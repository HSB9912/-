<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>뚠카롱 길드 관리 시스템 (v7.3)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        
        .chart-container { position: relative; width: 100%; max-width: 600px; margin: auto; height: 300px; }
        @media (min-width: 768px) { .chart-container { height: 350px; } }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #fbcfe8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #f472b6; }
        
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        th.sortable { cursor: pointer; user-select: none; transition: background 0.2s; }
        th.sortable:hover { background-color: #fdf2f8 !important; color: #db2777 !important; }

        .force-hide { display: none !important; }
        #loadingOverlay {
            position: fixed; inset: 0; background: white; z-index: 10000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }

        .nav-item.active { background-color: #fdf2f8; color: #ec4899; box-shadow: inset 4px 0 0 #ec4899; }
        
        #msgBox { transition: all 0.3s ease; transform: translateY(100px); opacity: 0; pointer-events: none; }
        #msgBox.show { transform: translateY(0); opacity: 1; }

        .btn-loading { pointer-events: none; opacity: 0.6; position: relative; color: transparent !important; }
        .btn-loading:after { content: ""; position: absolute; width: 16px; height: 16px; top: 50%; left: 50%; margin: -8px 0 0 -8px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .page-btn { padding: 0.5rem 1rem; border-radius: 0.75rem; font-size: 0.75rem; font-weight: bold; transition: all 0.2s; border: 1px solid #e5e7eb; background: white; color: #6b7280; }
        .page-btn.active { background: #ec4899; color: white; border-color: #ec4899; box-shadow: 0 4px 6px -1px rgba(236, 72, 153, 0.2); }
        .page-btn:hover:not(.active) { background: #f9fafb; color: #ec4899; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 h-screen overflow-hidden flex font-medium">

    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-pink-500 border-opacity-20 border-t-pink-500 mb-8 mx-auto"></div>
            <p class="text-pink-600 font-bold text-xl tracking-tight">클라우드 서버와 데이터 동기화 중...</p>
            <p class="text-gray-400 text-xs mt-4 uppercase tracking-widest font-bold">Processing Data Sync</p>
            <button id="forceEnterBtn" onclick="hideOverlay()" class="hidden mt-8 text-[10px] text-gray-400 underline uppercase tracking-widest font-bold hover:text-pink-500 transition-colors">서버 응답 지연 - 강제 입장하기</button>
        </div>
    </div>

    <!-- Message Box -->
    <div id="msgBox" class="fixed bottom-10 left-1/2 -translate-x-1/2 z-[200] bg-slate-900 text-white px-8 py-4 rounded-2xl shadow-2xl flex items-center gap-4 border border-white/10">
        <div id="msgIcon" class="text-pink-500"><i class="fas fa-info-circle"></i></div>
        <p id="msgText" class="text-sm font-bold"></p>
    </div>

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed lg:static inset-y-0 left-0 z-50 w-64 bg-white border-r border-gray-100 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 flex flex-col shadow-sm">
        <div class="p-6 border-b border-gray-100 flex items-center gap-3">
            <div class="w-10 h-10 rounded-2xl bg-gradient-to-tr from-pink-400 to-rose-400 flex items-center justify-center text-white font-bold shadow-lg shadow-pink-100 text-xl">뚠</div>
            <div>
                <h1 class="text-lg font-bold text-gray-800 tracking-tight">뚠카롱 길드 관리</h1>
                <p class="text-[9px] text-gray-400 font-bold uppercase tracking-widest leading-none mt-1">System Dashboard</p>
            </div>
            <button id="closeSidebar" class="lg:hidden ml-auto text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
        </div>
        
        <nav class="p-4 space-y-2 flex-1">
            <button onclick="router('dashboard')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="dashboard">
                <i class="fas fa-columns w-5 text-center"></i><span>대시보드</span>
            </button>
            <button onclick="router('members')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="members">
                <i class="fas fa-users w-5 text-center"></i><span>길드원 관리</span>
            </button>
            <button onclick="router('sheet')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="sheet">
                <i class="fas fa-table w-5 text-center"></i><span>시트 보기</span>
            </button>
            <button onclick="router('history')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="history">
                <i class="fas fa-history w-5 text-center"></i><span>운영 이력</span>
            </button>
            <button onclick="router('settings')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="settings">
                <i class="fas fa-cog w-5 text-center"></i><span>설정</span>
            </button>
        </nav>
        <div class="p-4 border-t border-gray-100 bg-gray-50/50 text-center font-bold">
            <p class="text-[10px] text-green-500 uppercase tracking-widest"><i class="fas fa-cloud mr-1 animate-pulse"></i> 실시간 연동 중</p>
        </div>
    </aside>

    <div id="sidebarOverlay" class="fixed inset-0 bg-black/10 z-40 hidden lg:hidden"></div>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col overflow-hidden bg-gray-50">
        <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-8 shrink-0 z-10 shadow-sm">
            <div class="flex items-center gap-4">
                <button id="openSidebar" class="p-2 lg:hidden rounded-lg hover:bg-gray-100 text-gray-600"><i class="fas fa-bars text-xl"></i></button>
                <h2 id="pageTitle" class="text-xl font-bold text-gray-800 tracking-tight">대시보드</h2>
            </div>
            <div class="flex items-center gap-4">
                <div class="px-4 py-1.5 bg-pink-50 text-pink-600 rounded-full text-xs font-bold border border-pink-100 shadow-sm">
                    ✨ <span id="counterLabel">전체 인원</span>: <span id="totalMembersCount">0</span>명
                </div>
                <button onclick="fetchMembers()" class="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-gray-100 text-gray-400 transition-all border border-gray-100 shadow-sm"><i class="fas fa-sync-alt"></i></button>
            </div>
        </header>

        <div id="contentArea" class="flex-1 overflow-y-auto p-4 lg:p-10 relative bg-gray-50"></div>
    </main>

    <!-- Modals -->
    <!-- Member Form Modal -->
    <div id="memberModal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/30 backdrop-blur-sm hidden fade-in font-bold">
        <div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-md overflow-hidden border border-gray-100">
            <div class="p-6 bg-pink-50 border-b border-pink-100 flex justify-between items-center">
                <div>
                    <h3 id="modalTitle" class="text-lg font-bold text-pink-700 tracking-tight">멤버 정보 입력</h3>
                </div>
                <button onclick="closeModal('memberModal')"><i class="fas fa-times text-gray-400 text-lg"></i></button>
            </div>
            <form id="memberForm" class="p-8 space-y-5">
                <input type="hidden" id="editMemberId">
                <div class="space-y-1">
                    <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">닉네임</label>
                    <input type="text" id="inputName" class="w-full border border-gray-100 bg-gray-50 rounded-2xl p-3.5 outline-none focus:ring-4 focus:ring-pink-50 text-sm font-bold shadow-inner" required placeholder="정확한 캐릭터명">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">소속</label>
                        <select id="inputGuild" class="w-full border border-gray-100 bg-gray-50 rounded-2xl p-3.5 text-sm font-bold outline-none" onchange="onGuildSelectChange(this.value)"></select>
                    </div>
                    <div class="space-y-1">
                        <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">직위</label>
                        <select id="inputRole" class="w-full border border-gray-100 bg-gray-50 rounded-2xl p-3.5 text-sm font-bold outline-none"></select>
                    </div>
                </div>
                <div class="space-y-1">
                    <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">직업</label>
                    <input type="text" id="inputClass" class="w-full border border-gray-100 bg-gray-50 rounded-2xl p-3.5 text-sm font-bold outline-none shadow-inner" placeholder="직업명">
                </div>
                <div class="flex items-center gap-3 py-1">
                    <input type="checkbox" id="inputIsMain" class="w-5 h-5 text-pink-500 rounded focus:ring-pink-50 shadow-sm cursor-pointer" checked onchange="toggleMainCharInput()">
                    <label for="inputIsMain" class="text-[11px] font-bold text-gray-600 uppercase tracking-tight cursor-pointer">본캐릭터입니까?</label>
                </div>
                <div id="mainCharInputGroup" class="hidden animate-fade-in space-y-1">
                    <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">본캐 닉네임</label>
                    <input type="text" id="inputMainCharName" class="w-full border border-gray-100 bg-gray-50 rounded-2xl p-3.5 text-sm font-bold outline-none shadow-inner" placeholder="본캐릭명 입력">
                </div>
                <div class="space-y-1">
                    <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">가입 날짜</label>
                    <input type="date" id="inputJoinDate" class="w-full border border-gray-100 bg-gray-50 rounded-2xl p-3.5 text-sm font-bold outline-none cursor-pointer">
                </div>
                <button type="submit" id="btnSubmitMember" class="w-full bg-gray-900 text-white py-4 rounded-2xl font-bold uppercase text-[10px] tracking-widest hover:bg-black transition-all shadow-xl mt-2">데이터베이스에 저장</button>
            </form>
        </div>
    </div>

    <!-- Bulk Import Modal -->
    <div id="bulkModal" class="fixed inset-0 z-[120] flex items-center justify-center bg-black/40 backdrop-blur-md hidden fade-in font-bold">
        <div class="bg-white rounded-[2.5rem] shadow-2xl w-full max-w-4xl overflow-hidden flex flex-col h-[85vh] border border-gray-100">
            <div class="p-6 bg-gray-50 border-b border-gray-100 flex justify-between items-center px-10">
                <h3 class="font-bold text-gray-600 text-sm"><i class="fas fa-file-import mr-2 text-pink-500"></i> 대량 명단 데이터 등록</h3>
                <button onclick="closeModal('bulkModal')"><i class="fas fa-times text-gray-400"></i></button>
            </div>
            <div class="p-10 flex-1 overflow-y-auto flex flex-col gap-8">
                <div class="bg-indigo-50 p-6 rounded-3xl border border-indigo-100 flex items-center gap-5 shadow-inner">
                    <div class="text-indigo-500 text-2xl"><i class="fas fa-info-circle"></i></div>
                    <p class="text-xs text-indigo-600 font-bold">엑셀에서 [너굴, 뚠카롱, 에반] 처럼 닉네임, 길드명, 직업 순서로 복사해서 넣으세요.</p>
                </div>
                <div class="flex-1 flex flex-col lg:flex-row gap-8 min-h-0">
                    <div class="flex-1 flex flex-col">
                        <textarea id="bulkInput" oninput="parseBulkInput()" class="w-full flex-1 border border-gray-200 rounded-[2rem] p-6 font-mono text-sm outline-none focus:ring-8 focus:ring-indigo-50 resize-none bg-gray-50 shadow-inner" placeholder="이곳에 데이터를 붙여넣으세요..."></textarea>
                    </div>
                    <div class="flex-1 flex flex-col border border-gray-200 rounded-[2rem] overflow-hidden bg-white shadow-sm">
                        <div class="p-4 bg-gray-50 border-b border-gray-100 font-bold text-[11px] text-gray-500 text-center">등록 대기 명단</div>
                        <div class="flex-1 overflow-auto no-scrollbar shadow-inner">
                            <table class="w-full text-left text-[11px] whitespace-nowrap font-bold">
                                <thead class="bg-gray-50 text-gray-400 sticky top-0 shadow-sm">
                                    <tr><th class="px-5 py-3 border-b">상태</th><th class="px-5 py-3 border-b">닉네임</th><th class="px-5 py-3 border-b">소속</th><th class="px-5 py-3 border-b">직업</th></tr>
                                </thead>
                                <tbody id="bulkPreviewBody" class="divide-y divide-gray-50"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t border-gray-100 bg-gray-50 flex justify-end gap-3 px-12 items-center">
                <span id="bulkStats" class="text-xs text-gray-500 font-bold mr-auto"></span>
                <button id="btnExecuteBulk" onclick="saveBulkData()" class="px-12 py-3 bg-gray-900 text-white rounded-2xl hover:bg-black font-bold text-xs shadow-xl transition-all disabled:opacity-30">입력하기</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirm Modal -->
    <div id="deleteModal" class="fixed inset-0 z-[110] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden fade-in font-bold">
        <div class="bg-white rounded-[2.5rem] shadow-2xl w-full max-w-sm p-10 text-center border border-gray-50">
            <div class="w-16 h-16 bg-red-50 text-red-500 rounded-2xl flex items-center justify-center text-2xl mx-auto mb-5 shadow-inner"><i class="fas fa-user-minus"></i></div>
            <p class="text-gray-800 font-bold text-lg mb-6 leading-tight">'<span id="deleteTargetName" class="text-red-500"></span>' 제거 확정</p>
            <div class="space-y-4 text-left mb-8">
                <div class="flex gap-2">
                    <button onclick="setDeleteType('leave')" id="btnLeave" class="flex-1 py-3 rounded-xl font-bold text-xs bg-gray-800 text-white shadow-sm transition-all">자진탈퇴</button>
                    <button onclick="setDeleteType('kick')" id="btnKick" class="flex-1 py-3 rounded-xl font-bold text-xs bg-gray-100 text-gray-400 transition-all">추방</button>
                </div>
                <input type="text" id="deleteReason" class="w-full border border-gray-100 bg-gray-50 rounded-xl p-3 text-xs font-bold outline-none shadow-inner" placeholder="사유를 입력하세요 (이력용)">
            </div>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="closeModal('deleteModal')" class="py-4 bg-gray-50 rounded-2xl font-bold text-xs text-gray-500 uppercase tracking-widest hover:bg-gray-100 transition-all">Cancel</button>
                <button onclick="confirmDelete()" class="py-4 bg-red-500 text-white rounded-2xl font-bold text-xs uppercase shadow-xl hover:bg-red-600 transition-all">Delete</button>
            </div>
        </div>
    </div>

    <!-- Factory Reset Modal -->
    <div id="resetModal" class="fixed inset-0 z-[110] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden fade-in font-bold">
        <div class="bg-white rounded-[3rem] shadow-2xl w-full max-w-md p-12 text-center border border-gray-50">
            <div class="w-20 h-20 bg-red-50 text-red-500 rounded-[2rem] flex items-center justify-center text-4xl mx-auto mb-6 shadow-inner"><i class="fas fa-radiation"></i></div>
            <h3 class="text-2xl font-black text-gray-800 tracking-tight mb-4">데이터 전체 초기화</h3>
            <p class="text-xs text-gray-500 mb-8 leading-relaxed">구글 시트의 모든 데이터와 로그가 완전히 지워집니다.<br>정말 진행하시겠습니까?</p>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="closeModal('resetModal')" class="py-4 bg-gray-50 rounded-2xl font-bold text-xs text-gray-500 hover:bg-gray-100 transition-all">취소</button>
                <button onclick="confirmReset()" class="py-4 bg-red-600 text-white rounded-2xl font-bold text-xs shadow-xl hover:bg-red-700 transition-all">초기화 진행</button>
            </div>
        </div>
    </div>

    <script>
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwRi3BSBpU3QO2gTS7lcGdnLtohNwLNLlaammBPMAIWVzigmz6o6TGjVtvaerO2akfZ/exec";
        const DEFAULT_SHEET_URL = "https://docs.google.com/spreadsheets/d/1pu_PIJ03omYU00jAmJ5FSvyjs_sqLxAU90_xjfY_yjQ/edit?gid=260394678#gid=260394678";
        
        const baseRanks = ['마카롱', '다쿠아즈'];
        const initialGuildRanks = {
            '뚠카롱': [...baseRanks, '크라운', '파르페', '티라미슈', '크로칸슈', '롤케이크', '팬케이크', '와플', '스콘', '반죽'],
            '뚱카롱': [...baseRanks, '뚠케이크', '뚠브레드', '수플레', '뚠스콘'],
            '밤카롱': [...baseRanks, '부팬케이크', '부케이크', '아인슈페너'],
            '별카롱': [...baseRanks, '부팬케이크', '부케이크', '아인슈페너'],
            '달카롱': [...baseRanks, '부팬케이크', '부케이크', '아인슈페너'],
            '꿀카롱': [...baseRanks, '부팬케이크', '부케이크', '아인슈페너']
        };
        
        const appState = {
            activeTab: 'dashboard',
            guilds: [
                { id: 'ddun', name: '뚠카롱', type: '메인 1기', color: '#f472b6', icon: 'fa-crown', max: 200 },
                { id: 'ddung', name: '뚱카롱', type: '메인 2기', color: '#fb7185', icon: 'fa-heart', max: 200 },
                { id: 'bam', name: '밤카롱', type: '부캐 1기', color: '#6366f1', icon: 'fa-moon', max: 200 },
                { id: 'byeol', name: '별카롱', type: '부캐 2기', color: '#facc15', icon: 'fa-star', max: 200 },
                { id: 'dal', name: '달카롱', type: '부캐 3기', color: '#60a5fa', icon: 'fa-sun', max: 200 },
                { id: 'kkul', name: '꿀카롱', type: '부캐 4기', color: '#fbbf24', icon: 'fa-cube', max: 200 },
            ],
            members: [],
            history: [],
            guildRanks: {},
            filters: { guild: 'all', search: '', sortField: 'name', sortOrder: 'asc', page: 1 },
            itemsPerPage: 17,
            deleteType: 'leave',
            tempSettingsRankGuild: '뚠카롱',
            parsedBulkData: [],
            scriptUrl: localStorage.getItem('macaron_script_url') || APPS_SCRIPT_URL,
            sheetUrl: localStorage.getItem('macaron_sheet_url') || DEFAULT_SHEET_URL
        };

        const savedRanks = localStorage.getItem('macaron_ranks_v18');
        if (savedRanks) {
            appState.guildRanks = JSON.parse(savedRanks);
        } else {
            appState.guilds.forEach(g => {
                appState.guildRanks[g.name] = initialGuildRanks[g.name] ? [...initialGuildRanks[g.name]] : [...initialGuildRanks['뚠카롱']];
            });
        }

        function showMsg(text, type = 'info') {
            const box = document.getElementById('msgBox');
            const icon = document.getElementById('msgIcon');
            const txt = document.getElementById('msgText');
            if(!box || !txt) return;
            txt.innerText = text;
            icon.innerHTML = type === 'success' ? '<i class="fas fa-check-circle text-green-400"></i>' : 
                             type === 'error' ? '<i class="fas fa-exclamation-circle text-red-400"></i>' : 
                             '<i class="fas fa-info-circle text-pink-400"></i>';
            box.classList.add('show');
            setTimeout(() => box.classList.remove('show'), 3500);
        }

        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.remove('force-hide');
                setTimeout(() => {
                    const btn = document.getElementById('forceEnterBtn');
                    if (btn && !overlay.classList.contains('force-hide')) btn.classList.remove('hidden');
                }, 4000);
            } else {
                overlay.classList.add('force-hide');
            }
        }

        function hideOverlay() { showLoading(false); }

        async function fetchMembers() {
            if(!appState.scriptUrl) { router('settings'); hideOverlay(); return; }
            showLoading(true);
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 12000);

            try {
                const response = await fetch(appState.scriptUrl, { 
                    method: 'GET', 
                    mode: 'cors',
                    cache: 'no-cache',
                    redirect: 'follow',
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                if (!response.ok) throw new Error(`Status: ${response.status}`);
                
                const json = await response.json();
                if (json.status === "success") {
                    appState.members = json.data.members || [];
                    appState.history = json.data.history || [];
                    
                    const countEl = document.getElementById('totalMembersCount');
                    if(countEl) countEl.innerText = appState.members.length;
                    
                    router(appState.activeTab);
                    showLoading(false);
                } else {
                    throw new Error(json.message || "서버 로직 에러");
                }
            } catch (e) {
                clearTimeout(timeoutId);
                console.error("Fetch Error:", e);
                showMsg("서버 동기화 실패. GAS 배포 권한을 [모든 사용자]로 변경해주세요.", "error");
                document.getElementById('forceEnterBtn')?.classList.remove('hidden');
            }
        }

        async function sendAction(action, data, btnId) {
            if(!appState.scriptUrl) return showMsg("연동 주소가 설정되지 않았습니다.", "error");
            const btn = btnId ? document.getElementById(btnId) : null;
            if (btn) btn.classList.add('btn-loading');
            showMsg("서버에 데이터를 전송 중입니다...", "info");
            
            try {
                const response = await fetch(appState.scriptUrl, {
                    method: 'POST',
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify({ action, data }),
                    redirect: 'follow'
                });
                
                let result;
                try {
                    result = await response.json();
                } catch(e) {
                    result = { status: "success" }; 
                }

                if (result.status === "success") {
                    showMsg("서버 반영이 성공적으로 완료되었습니다!", "success");
                    await fetchMembers();
                    return true;
                } else {
                    showMsg(result.message || "처리 실패", "error");
                    return false;
                }
            } catch (e) {
                console.error("Post Action Error:", e);
                showMsg("서버 전송 실패! 설정을 확인하세요.", "error");
                return false;
            } finally {
                if (btn) btn.classList.remove('btn-loading');
            }
        }

        function router(tab) {
            appState.activeTab = tab;
            const content = document.getElementById('contentArea');
            if (!content) return;
            content.innerHTML = '';
            document.querySelectorAll('.nav-item').forEach(el => {
                if(el.dataset.target === tab) {
                    el.classList.add('bg-pink-50', 'text-pink-600');
                    el.classList.remove('text-gray-600');
                } else {
                    el.classList.remove('bg-pink-50', 'text-pink-600');
                    el.classList.add('text-gray-600');
                }
            });

            const titles = { dashboard: '길드 현황판', members: '길드원 관리', sheet: '시트 보기', history: '운영 이력', settings: '시스템 설정' };
            document.getElementById('pageTitle').innerText = titles[tab] || '';

            if (tab === 'dashboard') renderDashboard(content);
            else if (tab === 'members') renderMembers(content);
            else if (tab === 'sheet') renderSheet(content);
            else if (tab === 'history') renderHistory(content);
            else if (tab === 'settings') renderSettings(content);
        }

        function renderDashboard(container) {
            const wrap = document.createElement('div');
            wrap.className = "grid grid-cols-1 xl:grid-cols-2 gap-10 fade-in";
            wrap.innerHTML = `
                <div class="bg-white p-12 rounded-[2.5rem] shadow-sm border border-gray-100">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-8">길드별 인원 분포도</h3>
                    <div class="chart-container"><canvas id="guildBarChart"></canvas></div>
                </div>
                <div class="bg-white p-12 rounded-[2.5rem] shadow-sm border border-gray-100 flex flex-col justify-center text-center">
                    <div class="w-16 h-16 bg-pink-100 text-pink-500 rounded-3xl flex items-center justify-center text-2xl mx-auto mb-6 shadow-sm"><i class="fas fa-sync-alt"></i></div>
                    <h3 class="text-xl font-bold text-gray-800 tracking-tight leading-none mb-3">클라우드 데이터 동기화</h3>
                    <p class="text-xs text-gray-400 font-bold uppercase tracking-widest opacity-60">닉네임 기반 고유 관리 시스템</p>
                </div>
            `;
            container.appendChild(wrap);

            const grid = document.createElement('div');
            grid.className = "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-10 fade-in";
            appState.guilds.forEach(g => {
                const count = appState.members.filter(m => m.guild === g.name).length;
                const pct = Math.min((count / g.max) * 100, 100);
                grid.innerHTML += `
                    <div class="bg-white p-10 rounded-[2.5rem] border border-gray-100 shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all group cursor-pointer" onclick="filterByGuild('${g.name}')">
                        <div class="flex justify-between items-start mb-8">
                            <span class="font-bold text-lg text-gray-800 group-hover:text-pink-500 transition-colors">${g.name}</span>
                            <span class="text-[10px] bg-gray-50 text-gray-500 px-3 py-1.5 rounded-xl font-bold">${g.type}</span>
                        </div>
                        <div class="flex justify-between text-[10px] mb-2 text-gray-400 font-bold">
                            <span>인원</span><span class="text-gray-800 font-bold">${count} / ${g.max}</span>
                        </div>
                        <div class="w-full bg-gray-50 rounded-full h-1.5 overflow-hidden shadow-inner"><div class="h-full bg-pink-500 rounded-full transition-all duration-1000 shadow-sm" style="width:${pct}%; background-color:${g.color}"></div></div>
                    </div>`;
            });
            container.appendChild(grid);

            const ctx = document.getElementById('guildBarChart')?.getContext('2d');
            if (ctx) {
                new Chart(ctx, { type: 'bar', data: { labels: appState.guilds.map(g => g.name), datasets: [{ data: appState.guilds.map(g => appState.members.filter(m => m.guild === g.name).length), backgroundColor: '#f472b6', borderRadius: 10, barThickness: 30 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: '#f1f5f9' }, ticks: { font: { weight: 'bold', size: 10 } } }, x: { grid: { display: false }, ticks: { font: { weight: 'bold', size: 10 } } } } } });
            }
        }

        function renderMembers(container) {
            container.innerHTML = `
                <div class="flex flex-col gap-8 fade-in">
                    <div class="bg-white p-10 rounded-t-[3rem] border border-gray-100 space-y-8 shadow-sm">
                        <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                            <div class="flex overflow-x-auto pb-2 no-scrollbar w-full md:w-auto gap-3">
                                <button onclick="filterByGuild('all')" class="shrink-0 whitespace-nowrap px-8 py-3 rounded-2xl text-xs font-bold transition-all ${appState.filters.guild === 'all' ? 'bg-gray-800 text-white shadow-xl' : 'bg-gray-50 text-gray-500 hover:bg-gray-100'}">전체 보기</button>
                                ${appState.guilds.map(g => `<button onclick="filterByGuild('${g.name}')" class="shrink-0 whitespace-nowrap px-8 py-3 rounded-2xl text-xs font-bold transition-all ${appState.filters.guild === g.name ? 'bg-pink-500 text-white shadow-xl shadow-pink-100' : 'bg-gray-50 text-gray-500 hover:bg-gray-100'}">${g.name}</button>`).join('')}
                            </div>
                            <div class="flex gap-4 w-full md:w-auto">
                                <button onclick="openBulkModal()" class="shrink-0 flex-1 md:flex-none px-8 py-3.5 bg-emerald-500 text-white rounded-2xl text-xs font-bold shadow-xl hover:bg-emerald-600 transition-all"><i class="fas fa-file-import mr-2"></i> 일괄 등록</button>
                                <button onclick="openAddModal()" class="shrink-0 flex-1 md:flex-none px-10 py-3.5 bg-pink-500 text-white rounded-2xl text-xs font-bold shadow-xl hover:bg-pink-600 transition-all"><i class="fas fa-plus mr-2"></i> 멤버 추가</button>
                            </div>
                        </div>
                        <div class="relative"><i class="fas fa-search absolute left-6 top-1/2 -translate-y-1/2 text-gray-400 text-sm"></i><input type="text" oninput="handleSearch(this.value)" value="${appState.filters.search}" class="w-full pl-16 pr-8 py-4 bg-gray-50 border border-gray-100 rounded-[2rem] outline-none focus:ring-4 focus:ring-pink-50 font-bold text-sm shadow-inner" placeholder="닉네임 검색"></div>
                    </div>
                    <div id="memberTableContainer" class="bg-white rounded-b-[3rem] border border-gray-100 overflow-hidden shadow-sm"></div>
                </div>`;
            updateMemberTable();
        }

        function updateMemberTable() {
            const container = document.getElementById('memberTableContainer');
            if(!container) return;
            const filtered = appState.members.filter(m => (appState.filters.guild === 'all' || m.guild === appState.filters.guild) && ( (m.name || '').toLowerCase().includes(appState.filters.search.toLowerCase()) || (m.mainCharName && m.mainCharName.toLowerCase().includes(appState.filters.search.toLowerCase())) ));
            
            // 닉네임 유니코드 및 텍스트 기준 오름차순/내림차순 정렬
            filtered.sort((a, b) => { 
                const vA = (a[appState.filters.sortField] || '').toString(); 
                const vB = (b[appState.filters.sortField] || '').toString(); 
                
                if (vA < vB) return appState.filters.sortOrder === 'asc' ? -1 : 1;
                if (vA > vB) return appState.filters.sortOrder === 'asc' ? 1 : -1;
                return 0;
            });

            const countLabel = appState.filters.guild === 'all' ? '전체 인원' : appState.filters.guild + ' 인원';
            const labelEl = document.getElementById('counterLabel');
            if(labelEl) labelEl.innerText = countLabel;
            
            const countEl = document.getElementById('totalMembersCount');
            if(countEl) countEl.innerText = filtered.length;

            // 헤더 클릭 정렬 표시용 아이콘 헬퍼
            const getSortIcon = (f) => {
                if (appState.filters.sortField !== f) return '<i class="fas fa-sort ml-1 opacity-30 text-[9px]"></i>';
                return appState.filters.sortOrder === 'asc' ? '<i class="fas fa-sort-up ml-1 text-pink-500 text-[10px]"></i>' : '<i class="fas fa-sort-down ml-1 text-pink-500 text-[10px]"></i>';
            };

            let html = `<div class="overflow-x-auto shadow-inner"><table class="w-full text-left min-w-[900px] text-xs whitespace-nowrap"><thead class="bg-gray-50 text-[10px] font-bold text-gray-500 border-b border-gray-100"><tr>
                <th class="p-8 text-center w-16">No.</th>
                <th class="p-8 sortable hover:bg-gray-100 transition-colors" onclick="handleSort('name')">닉네임 ${getSortIcon('name')}</th>
                <th class="p-8">구분</th>
                <th class="p-8 sortable hover:bg-gray-100 transition-colors" onclick="handleSort('guild')">소속 ${getSortIcon('guild')}</th>
                <th class="p-8 sortable hover:bg-gray-100 transition-colors" onclick="handleSort('role')">직위 ${getSortIcon('role')}</th>
                <th class="p-8 sortable hover:bg-gray-100 transition-colors" onclick="handleSort('class')">직업 ${getSortIcon('class')}</th>
                <th class="p-8 text-right">관리</th>
            </tr></thead><tbody class="divide-y divide-gray-50 text-gray-600 font-bold">`;
            
            if (filtered.length === 0) html += `<tr><td colspan="7" class="p-20 text-center text-gray-300 font-bold">검색된 길드원이 없습니다.</td></tr>`;
            
            filtered.forEach((m, index) => {
                // 직위에 따른 아이콘(왕관) 또는 동그라미 표시 로직
                let iconHtml = '';
                if (m.role === '마카롱') {
                    // 마카롱: 파란색 왕관
                    iconHtml = '<i class="fas fa-crown text-blue-500 text-sm shadow-sm" style="text-shadow: 0 0 8px rgba(59,130,246,0.6);"></i>';
                } else if (m.role === '다쿠아즈') {
                    // 다쿠아즈: 핑크색 왕관
                    iconHtml = '<i class="fas fa-crown text-pink-500 text-sm shadow-sm" style="text-shadow: 0 0 8px rgba(236,72,153,0.6);"></i>';
                } else {
                    // 일반 직위: 색상 동그라미
                    let dotClass = 'bg-gray-200';
                    if (m.isMain) {
                        if (['크라운', '파르페', '티라미슈', '크로칸슈'].includes(m.role)) {
                            dotClass = 'bg-blue-500 shadow-[0_0_8px_rgba(59,130,246,0.5)]';
                        } else if (['팬케이크', '롤케이크'].includes(m.role)) {
                            dotClass = 'bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.5)]';
                        } else {
                            dotClass = 'bg-pink-500 shadow-[0_0_8px_rgba(236,72,153,0.5)]';
                        }
                    }
                    iconHtml = `<div class="w-2.5 h-2.5 rounded-full ${dotClass}"></div>`;
                }
                
                html += `<tr class="hover:bg-pink-50/20 transition-all group">
                    <td class="p-8 text-center text-gray-400 font-black text-[11px]">${index + 1}</td>
                    <td class="p-8 leading-none"><div class="flex items-center gap-4 leading-none">${iconHtml}<span class="text-sm font-bold text-gray-800 tracking-tight leading-none">${m.name}</span></div></td>
                    <td class="p-8 leading-none">${m.isMain ? '<span class="text-[9px] font-bold bg-pink-50 text-pink-500 px-4 py-1.5 rounded-full border border-pink-100 shadow-sm">본캐</span>' : `<span class="text-[9px] font-bold text-gray-400">부캐 / ${m.mainCharName || '-'}</span>`}</td>
                    <td class="p-8 font-bold text-gray-500 leading-none">${m.guild}</td>
                    <td class="p-8 leading-none"><span class="bg-gray-100 text-gray-500 px-4 py-1.5 rounded-xl font-bold text-[10px] shadow-sm">${m.role}</span></td>
                    <td class="p-8 font-bold text-gray-400 leading-none">${m.class || '-'}</td>
                    <td class="p-8 text-right opacity-0 group-hover:opacity-100 transition-opacity leading-none"><div class="flex justify-end gap-2"><button onclick="openEditModal('${m.id}')" class="w-10 h-10 rounded-xl bg-white border border-gray-100 text-blue-500 hover:bg-blue-50 shadow-sm transition-all flex items-center justify-center"><i class="fas fa-edit"></i></button><button onclick="openDeleteModal('${m.id}')" class="w-10 h-10 rounded-xl bg-white border border-gray-100 text-red-500 hover:bg-red-50 shadow-sm transition-all flex items-center justify-center"><i class="fas fa-trash-alt"></i></button></div></td>
                </tr>`;

                // 17명 마다 점선 구분선 추가 (마지막 항목 제외)
                if ((index + 1) % 17 === 0 && index !== filtered.length - 1) {
                    html += `<tr><td colspan="7" class="p-0 border-b-[3px] border-dashed border-pink-300"></td></tr>`;
                }
            });
            html += `</tbody></table></div>`;
            container.innerHTML = html;
        }

        function renderSheet(container) {
            const sheetUrl = appState.sheetUrl;
            let embedUrl = (sheetUrl && sheetUrl.includes("docs.google.com/spreadsheets")) ? (sheetUrl.split('/edit')[0] + "/preview") : "";
            container.innerHTML = `<div class="h-full flex flex-col gap-6 fade-in font-bold"><div class="bg-white p-6 rounded-[2rem] border border-gray-100 shadow-sm flex flex-col md:flex-row justify-between items-center gap-6"><div><h3 class="text-sm font-bold text-gray-800">원본 데이터 시트 뷰어</h3><p class="text-[10px] text-gray-400 font-bold mt-2">A~G열 원본 구글 시트를 확인합니다.</p></div><button onclick="window.open('${sheetUrl || '#'}', '_blank')" class="px-10 py-4 bg-gray-900 text-white rounded-2xl text-[10px] font-bold shadow-xl hover:bg-black transition-all">새 창에서 시트 열기</button></div><div class="flex-1 bg-white border border-gray-100 rounded-[2.5rem] shadow-inner overflow-hidden relative">${embedUrl ? `<iframe src="${embedUrl}" class="w-full h-full border-none"></iframe>` : `<div class="absolute inset-0 flex flex-col items-center justify-center text-gray-300"><i class="fas fa-table text-7xl mb-6 opacity-20"></i><p class="text-xs">설정 메뉴에서 시트 링크를 연동해주세요.</p></div>`}</div></div>`;
        }

        function renderHistory(container) {
            container.innerHTML = `<div class="bg-white rounded-[2.5rem] border border-gray-100 shadow-sm overflow-hidden fade-in font-bold"><div class="p-8 border-b border-gray-50 flex items-center justify-between shadow-sm"><h3 class="text-sm font-bold text-gray-800"><i class="fas fa-history mr-2 text-pink-500"></i> 길드 활동 운영 이력</h3><span class="text-[10px] text-gray-400 font-bold">누적 기록: ${appState.history.length} 건</span></div><div class="overflow-x-auto shadow-inner"><table class="w-full text-left text-xs whitespace-nowrap font-bold"><thead class="bg-gray-50 text-[10px] font-bold text-gray-500 border-b border-gray-100"><tr><th class="p-6">시간</th><th class="p-6 w-32">활동 분류</th><th class="p-8">대상 닉네임</th><th class="p-6">활동 상세 내용</th></tr></thead><tbody class="divide-y divide-gray-50 text-gray-600 font-bold">${appState.history.length === 0 ? `<tr><td colspan="4" class="p-20 text-center text-gray-300 font-bold">기록된 이력이 없습니다.</td></tr>` : appState.history.map(log => `<tr class="hover:bg-gray-50/50 transition-colors"><td class="p-6 font-mono text-gray-400 font-bold text-[10px] tracking-tighter">${log.date}</td><td class="p-6"><span class="px-3 py-1.5 rounded-lg text-[9px] font-bold ${log.category === '추방' ? 'bg-red-50 text-red-500 border border-red-100 shadow-sm' : log.category === '가입' ? 'bg-green-50 text-green-500 border border-green-100 shadow-sm' : 'bg-gray-50 text-gray-500 border border-gray-100'}">${log.category}</span></td><td class="p-8 font-bold text-gray-800">${log.name}</td><td class="p-8 font-medium text-gray-500 font-bold text-[11px]">${log.content}</td></tr>`).join('')}</tbody></table></div></div>`;
        }

        function renderSettings(container) {
            container.innerHTML = `
                <div class="grid grid-cols-1 gap-10 fade-in max-w-4xl font-bold">
                    <div class="bg-white p-12 rounded-[2.5rem] border border-gray-100 shadow-sm font-bold">
                        <div class="flex items-center gap-5 mb-10"><div class="w-14 h-14 rounded-3xl bg-gray-900 text-white flex items-center justify-center text-2xl shadow-xl shadow-gray-200"><i class="fas fa-link"></i></div><div><h3 class="text-xl font-bold text-gray-800 tracking-tighter">클라우드 연동 설정</h3><p class="text-[10px] text-gray-400 font-bold mt-2">API 및 시트 주소를 구성합니다.</p></div></div>
                        <div class="space-y-8 font-bold">
                            <div class="space-y-2"><label class="text-[10px] font-bold text-gray-400 ml-1">앱스 스크립트 API URL</label><input type="text" id="settingScriptUrl" value="${appState.scriptUrl}" class="w-full bg-gray-50 border border-gray-100 rounded-2xl p-5 text-xs font-bold outline-none focus:ring-4 focus:ring-gray-200 shadow-inner font-mono transition-all"></div>
                            <div class="space-y-2"><label class="text-[10px] font-bold text-gray-400 ml-1">구글 스프레드시트 URL</label><input type="text" id="settingSheetUrl" value="${appState.sheetUrl}" class="w-full bg-gray-50 border border-gray-100 rounded-2xl p-5 text-xs font-bold outline-none focus:ring-4 focus:ring-gray-200 shadow-inner font-mono transition-all"></div>
                            <button onclick="saveSystemSettings()" class="w-full py-6 bg-gray-900 text-white rounded-3xl font-bold text-xs shadow-xl hover:bg-black transition-all active:scale-[0.98]">저장 후 시스템 재부팅</button>
                        </div>
                    </div>
                    <div class="bg-white p-12 rounded-[2.5rem] border border-gray-100 shadow-sm">
                        <div class="flex flex-col md:flex-row justify-between items-center gap-6 mb-12 pb-10 border-b border-gray-100">
                            <div>
                                <h3 class="text-xl font-bold text-gray-800 text-pink-500 tracking-tight">길드 직위 체계 커스텀</h3>
                                <p class="text-[10px] text-gray-400 font-bold mt-2">길드별로 고유한 직위를 설정하세요.</p>
                            </div>
                            <select onchange="changeRankGuild(this.value)" class="bg-gray-50 border border-gray-100 rounded-2xl px-8 py-5 text-xs font-bold outline-none cursor-pointer hover:bg-gray-100 shadow-sm transition-all">${appState.guilds.map(g => `<option value="${g.name}" ${g.name === appState.tempSettingsRankGuild ? 'selected' : ''}>${g.name}</option>`).join('')}</select>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 mb-12">
                            ${(appState.guildRanks[appState.tempSettingsRankGuild] || []).map((r, i) => `<div class="flex items-center gap-4 bg-gray-50 border border-gray-100 p-5 rounded-3xl group transition-all hover:bg-white hover:border-pink-200 shadow-sm"><span class="w-8 text-center text-[10px] font-bold text-gray-400 group-hover:text-pink-400">${i+1}</span><input type="text" value="${r}" onchange="updateRankVal(${i}, this.value)" class="flex-1 bg-transparent border-none text-sm font-bold text-gray-700 outline-none shadow-inner p-2 rounded-xl"> <button onclick="removeRank(${i})" class="text-gray-300 hover:text-red-500 transition-colors p-2"><i class="fas fa-times-circle"></i></button></div>`).join('')}
                        </div>
                        <button onclick="addRank()" class="w-full py-6 border-2 border-dashed border-gray-200 rounded-3xl text-gray-400 hover:text-pink-500 hover:border-pink-300 transition-all text-xs font-bold"><i class="fas fa-plus mr-3"></i> 새로운 직위 추가하기</button>
                    </div>
                    <div class="bg-white p-12 rounded-[2.5rem] border border-red-100 shadow-sm mt-10">
                        <div class="text-center">
                             <div class="w-16 h-16 bg-red-50 text-red-500 rounded-2xl flex items-center justify-center text-2xl mx-auto mb-5 shadow-inner"><i class="fas fa-radiation"></i></div>
                             <h3 class="text-xl font-bold text-gray-800 mb-2">공장 초기화</h3>
                             <p class="text-xs text-gray-400 font-bold mb-8">구글 시트의 모든 데이터를 영구 삭제합니다.</p>
                             <button onclick="executeFactoryReset()" class="py-4 px-10 bg-red-500 text-white rounded-2xl font-bold text-xs shadow-xl hover:bg-red-600 transition-all">전체 데이터 초기화</button>
                        </div>
                    </div>
                </div>`;
        }

        // --- Logic Handlers ---
        function saveSystemSettings() {
            const script = document.getElementById('settingScriptUrl').value.trim(), sheet = document.getElementById('settingSheetUrl').value.trim();
            if(!script) return showMsg("API 주소가 유효하지 않습니다.", "error");
            localStorage.setItem('macaron_script_url', script); localStorage.setItem('macaron_sheet_url', sheet);
            showMsg("연동 링크 설정이 업데이트되었습니다. 재시작 중...", "success"); setTimeout(() => location.reload(), 1000);
        }

        function handleSearch(v) { appState.filters.search = v; appState.filters.page = 1; updateMemberTable(); }
        function filterByGuild(g) { appState.filters.guild = g; appState.filters.page = 1; updateMemberTable(); router('members'); }
        function handleSort(field) { if(appState.filters.sortField === field) appState.filters.sortOrder = appState.filters.sortOrder === 'asc' ? 'desc' : 'asc'; else { appState.filters.sortField = field; appState.filters.sortOrder = 'asc'; } updateMemberTable(); }
        function goToPage(p) { appState.filters.page = p; updateMemberTable(); }
        function openModal(id) { document.getElementById(id)?.classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id)?.classList.add('hidden'); }
        function onGuildSelectChange(v) {
            const roleSel = document.getElementById('inputRole'); if(roleSel) roleSel.innerHTML = (appState.guildRanks[v] || initialGuildRanks['뚠카롱']).map(r => `<option value="${r}">${r}</option>`).join('');
        }
        function toggleMainCharInput() { document.getElementById('mainCharInputGroup').classList.toggle('hidden', document.getElementById('inputIsMain').checked); }
        
        function openAddModal() {
            document.getElementById('modalTitle').innerText = '멤버 정보 신규 등록'; document.getElementById('memberForm').reset();
            document.getElementById('editMemberId').value = ''; document.getElementById('inputName').disabled = false;
            const gSel = document.getElementById('inputGuild'); if(gSel) { gSel.innerHTML = appState.guilds.map(g => `<option value="${g.name}">${g.name}</option>`).join(''); onGuildSelectChange(appState.guilds[0].name); }
            document.getElementById('inputJoinDate').value = new Date().toISOString().split('T')[0]; toggleMainCharInput(); openModal('memberModal');
        }

        function openEditModal(id) {
            const m = appState.members.find(x => x.id == id); if(!m) return;
            document.getElementById('modalTitle').innerText = '멤버 정보 수정하기'; document.getElementById('editMemberId').value = m.id;
            document.getElementById('inputName').value = m.name; document.getElementById('inputName').disabled = true; 
            document.getElementById('inputClass').value = m.class || '';
            const gSel = document.getElementById('inputGuild'); if(gSel) { gSel.innerHTML = appState.guilds.map(g => `<option value="${g.name}" ${g.name === m.guild ? 'selected' : ''}>${g.name}</option>`).join(''); onGuildSelectChange(m.guild); }
            document.getElementById('inputRole').value = m.role; document.getElementById('inputIsMain').checked = m.isMain;
            document.getElementById('inputMainCharName').value = m.mainCharName || ''; document.getElementById('inputJoinDate').value = (m.joinDate || "").split('T')[0];
            toggleMainCharInput(); openModal('memberModal');
        }

        document.getElementById('memberForm').onsubmit = async (e) => {
            e.preventDefault(); const oldId = document.getElementById('editMemberId').value, name = document.getElementById('inputName').value.trim();
            const payload = { id: oldId || name, name: name, guild: document.getElementById('inputGuild').value, role: document.getElementById('inputRole').value, class: document.getElementById('inputClass').value.trim() || '-', isMain: document.getElementById('inputIsMain').checked, mainCharName: document.getElementById('inputMainCharName').value.trim(), joinDate: document.getElementById('inputJoinDate').value };
            if (await sendAction(oldId ? 'update' : 'add', payload, 'btnSubmitMember')) closeModal('memberModal');
        };

        function openDeleteModal(id) { appState.memberToDelete = appState.members.find(x => x.id == id); if(!appState.memberToDelete) return; document.getElementById('deleteTargetName').innerText = appState.memberToDelete.name; document.getElementById('deleteReason').value = ''; setDeleteType('leave'); openModal('deleteModal'); }
        function setDeleteType(t) { appState.deleteType = t; document.getElementById('btnLeave').className = t === 'leave' ? "flex-1 py-3.5 rounded-xl font-bold text-xs bg-gray-800 text-white shadow-sm transition-all" : "flex-1 py-3.5 rounded-xl font-bold text-xs bg-gray-100 text-gray-400 transition-all"; document.getElementById('btnKick').className = t === 'kick' ? "flex-1 py-3.5 rounded-xl font-bold text-xs bg-red-600 text-white shadow-xl shadow-red-100 transition-all" : "flex-1 py-3.5 rounded-xl font-bold text-xs bg-gray-100 text-gray-400 transition-all"; }
        async function confirmDelete() { if(!appState.memberToDelete) return; if (await sendAction('delete', { id: appState.memberToDelete.id, deleteType: appState.deleteType, reason: document.getElementById('deleteReason').value.trim() })) closeModal('deleteModal'); }

        function openBulkModal() { document.getElementById('bulkInput').value = ''; appState.parsedBulkData = []; parseBulkInput(); openModal('bulkModal'); }

        function parseBulkInput() {
            const raw = document.getElementById('bulkInput').value.trim(), tbody = document.getElementById('bulkPreviewBody'), btn = document.getElementById('btnExecuteBulk'), readyCount = document.getElementById('bulkReadyCount');
            if (!raw) { appState.parsedBulkData = []; if(tbody) tbody.innerHTML = '<tr><td colspan="4" class="p-20 text-center text-gray-400 font-bold">이곳에 데이터를 붙여넣으세요.</td></tr>'; if(readyCount) readyCount.innerText = '0'; if(btn) btn.disabled = true; return; }
            const lines = raw.split('\n'), parsed = [], today = new Date().toISOString().split('T')[0];
            lines.forEach(line => {
                let cols = line.split('\t').map(c => c.trim()); if (cols.length < 2 && line.includes(',')) cols = line.split(',').map(c => c.trim());
                if (!cols[0]) return; 
                let guild = appState.filters.guild !== 'all' ? appState.filters.guild : appState.guilds[0].name;
                const match = appState.guilds.find(g => g.name === cols[1]); if (match) guild = match.name;
                const ranks = appState.guildRanks[guild] || initialGuildRanks['뚠카롱'];
                parsed.push({ id: cols[0], name: cols[0], guild, role: ranks[ranks.length-1], class: cols[2] || '-', isMain: true, mainCharName: '', joinDate: today });
            });
            appState.parsedBulkData = parsed; if(readyCount) readyCount.innerText = parsed.length; if(btn) btn.disabled = (parsed.length === 0);
            if(tbody) {
                tbody.innerHTML = parsed.slice(0, 100).map(d => `<tr class="hover:bg-gray-50 transition-colors font-bold"><td class="px-5 py-4 text-green-500 font-bold text-[10px]">정상 대기</td><td class="px-5 py-4 font-bold text-gray-800">${d.name}</td><td class="px-5 py-4 text-gray-500 font-bold text-[10px]">${d.guild}</td><td class="px-5 py-4 text-gray-400 font-medium text-[10px]">${d.class}</td></tr>`).join('');
                if (parsed.length > 100) tbody.innerHTML += `<tr><td colspan="4" class="px-5 py-6 text-center text-gray-400 text-[10px] font-bold">...외 ${parsed.length - 100}명 생략됨</td></tr>`;
            }
        }

        async function saveBulkData() {
            if (appState.parsedBulkData.length === 0) return;
            // iframe 내 confirm 창 막힘 현상 해결을 위해 alert/confirm 없이 즉시 전송
            if (await sendAction('bulk_add', appState.parsedBulkData, 'btnExecuteBulk')) {
                closeModal('bulkModal');
                document.getElementById('bulkInput').value = '';
                appState.parsedBulkData = [];
                document.getElementById('bulkPreviewBody').innerHTML = '';
            }
        }

        function changeRankGuild(v) { appState.tempSettingsRankGuild = v; router('settings'); }
        function updateRankVal(i, v) { appState.guildRanks[appState.tempSettingsRankGuild][i] = v; localStorage.setItem('macaron_ranks_v18', JSON.stringify(appState.guildRanks)); }
        function addRank() { appState.guildRanks[appState.tempSettingsRankGuild].push("새 직위"); localStorage.setItem('macaron_ranks_v18', JSON.stringify(appState.guildRanks)); router('settings'); }
        function removeRank(i) { appState.guildRanks[appState.tempSettingsRankGuild].splice(i, 1); localStorage.setItem('macaron_ranks_v18', JSON.stringify(appState.guildRanks)); router('settings'); }
        
        function executeFactoryReset() { openModal('resetModal'); }
        async function confirmReset() { if(await sendAction('reset', {})) closeModal('resetModal'); }

        function initSidebar() {
            const sb = document.getElementById('sidebar'), ov = document.getElementById('sidebarOverlay'), openBtn = document.getElementById('openSidebar'), closeBtn = document.getElementById('closeSidebar');
            if(openBtn) { openBtn.onclick = () => { sb.classList.remove('-translate-x-full'); ov.classList.remove('hidden'); }; }
            if(closeBtn) { closeBtn.onclick = () => { sb.classList.add('-translate-x-full'); ov.classList.add('hidden'); }; }
            if(ov) { ov.onclick = () => { sb.classList.add('-translate-x-full'); ov.classList.add('hidden'); }; }
            
            // 본문에 초기화 모달이 없으면 생성
            if(!document.getElementById('resetModal')){
                const resetHtml = `<div id="resetModal" class="fixed inset-0 z-[110] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden fade-in font-bold"><div class="bg-white rounded-[3rem] shadow-2xl w-full max-w-md p-12 text-center border border-gray-50"><div class="w-20 h-20 bg-red-50 text-red-500 rounded-[2rem] flex items-center justify-center text-4xl mx-auto mb-6 shadow-inner"><i class="fas fa-radiation"></i></div><h3 class="text-2xl font-black text-gray-800 tracking-tight mb-4">데이터 전체 초기화</h3><p class="text-xs text-gray-500 mb-8 leading-relaxed">구글 시트의 모든 데이터와 로그가 완전히 지워집니다.<br>정말 진행하시겠습니까?</p><div class="grid grid-cols-2 gap-4"><button onclick="closeModal('resetModal')" class="py-4 bg-gray-50 rounded-2xl font-bold text-xs text-gray-500 hover:bg-gray-100 transition-all">취소</button><button onclick="confirmReset()" class="py-4 bg-red-600 text-white rounded-2xl font-bold text-xs shadow-xl hover:bg-red-700 transition-all">초기화 진행</button></div></div></div>`;
                document.body.insertAdjacentHTML('beforeend', resetHtml);
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => { initSidebar(); fetchMembers(); });
    </script>
</body>
</html>

