<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëš ì¹´ë¡± ê¸¸ë“œ ê´€ë¦¬ ì‹œìŠ¤í…œ (v7.4)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #fbcfe8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #f472b6; }
        
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        th.sortable { cursor: pointer; user-select: none; transition: background 0.2s; }
        th.sortable:hover { background-color: #fdf2f8 !important; color: #db2777 !important; }

        .force-hide { display: none !important; }
        #loadingOverlay {
            position: fixed; inset: 0; background: white; z-index: 10000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }

        .nav-item.active { background-color: #fdf2f8; color: #ec4899; box-shadow: inset 4px 0 0 #ec4899; }
        
        #msgBox { transition: all 0.3s ease; transform: translateY(100px); opacity: 0; pointer-events: none; }
        #msgBox.show { transform: translateY(0); opacity: 1; }

        .btn-loading { pointer-events: none; opacity: 0.6; position: relative; color: transparent !important; }
        .btn-loading:after { content: ""; position: absolute; width: 16px; height: 16px; top: 50%; left: 50%; margin: -8px 0 0 -8px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .page-btn { padding: 0.5rem 1rem; border-radius: 0.75rem; font-size: 0.75rem; font-weight: bold; transition: all 0.2s; border: 1px solid #e5e7eb; background: white; color: #6b7280; }
        .page-btn.active { background: #ec4899; color: white; border-color: #ec4899; box-shadow: 0 4px 6px -1px rgba(236, 72, 153, 0.2); }
        .page-btn:hover:not(.active) { background: #f9fafb; color: #ec4899; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* ë‹¬ë ¥ ìŠ¤íƒ€ì¼ */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem; text-align: center; font-size: 0.8rem; }
        .calendar-day { padding: 0.5rem; border-radius: 1rem; position: relative; transition: all 0.2s; }
        .calendar-day:hover { background-color: #f9fafb; }
        .calendar-day.today { background-color: #ec4899; color: white; box-shadow: 0 4px 6px -1px rgba(236, 72, 153, 0.4); }
        .calendar-day.thursday { color: #db2777; background-color: #fdf2f8; border: 1px solid #fbcfe8; }
        .calendar-head { font-size: 0.75rem; font-weight: 800; color: #9ca3af; text-transform: uppercase; padding-bottom: 0.5rem; }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 h-screen overflow-hidden flex font-medium">

    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-pink-500 border-opacity-20 border-t-pink-500 mb-8 mx-auto"></div>
            <p class="text-pink-600 font-bold text-xl tracking-tight">í´ë¼ìš°ë“œ ì„œë²„ì™€ ë°ì´í„° ë™ê¸°í™” ì¤‘...</p>
            <p class="text-gray-400 text-xs mt-4 uppercase tracking-widest font-bold">Processing Data Sync</p>
            <button id="forceEnterBtn" onclick="hideOverlay()" class="hidden mt-8 text-[10px] text-gray-400 underline uppercase tracking-widest font-bold hover:text-pink-500 transition-colors">ì„œë²„ ì‘ë‹µ ì§€ì—° - ê°•ì œ ì…ì¥í•˜ê¸°</button>
        </div>
    </div>

    <!-- Message Box -->
    <div id="msgBox" class="fixed bottom-10 left-1/2 -translate-x-1/2 z-[200] bg-slate-900 text-white px-8 py-4 rounded-2xl shadow-2xl flex items-center gap-4 border border-white/10">
        <div id="msgIcon" class="text-pink-500"><i class="fas fa-info-circle"></i></div>
        <p id="msgText" class="text-sm font-bold"></p>
    </div>

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed lg:static inset-y-0 left-0 z-50 w-64 bg-white border-r border-gray-100 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 flex flex-col shadow-sm">
        <div class="p-6 border-b border-gray-100 flex items-center gap-3">
            <div class="w-10 h-10 rounded-2xl bg-gradient-to-tr from-pink-400 to-rose-400 flex items-center justify-center text-white font-bold shadow-lg shadow-pink-100 text-xl">ëš </div>
            <div>
                <h1 class="text-lg font-bold text-gray-800 tracking-tight">ëš ì¹´ë¡± ê¸¸ë“œ ê´€ë¦¬</h1>
                <p class="text-[9px] text-gray-400 font-bold uppercase tracking-widest leading-none mt-1">System Dashboard</p>
            </div>
            <button id="closeSidebar" class="lg:hidden ml-auto text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
        </div>
        
        <nav class="p-4 space-y-2 flex-1">
            <button onclick="router('dashboard')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="dashboard">
                <i class="fas fa-columns w-5 text-center"></i><span>ëŒ€ì‹œë³´ë“œ</span>
            </button>
            <button onclick="router('members')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="members">
                <i class="fas fa-users w-5 text-center"></i><span>ê¸¸ë“œì› ê´€ë¦¬</span>
            </button>
            <button onclick="router('sheet')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="sheet">
                <i class="fas fa-table w-5 text-center"></i><span>ì‹œíŠ¸ ë³´ê¸°</span>
            </button>
            <button onclick="router('history')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="history">
                <i class="fas fa-history w-5 text-center"></i><span>ìš´ì˜ ì´ë ¥</span>
            </button>
            <button onclick="router('settings')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="settings">
                <i class="fas fa-cog w-5 text-center"></i><span>ì„¤ì •</span>
            </button>
        </nav>
        <div class="p-4 border-t border-gray-100 bg-gray-50/50 text-center font-bold">
            <p class="text-[10px] text-green-500 uppercase tracking-widest"><i class="fas fa-cloud mr-1 animate-pulse"></i> ì‹¤ì‹œê°„ ì—°ë™ ì¤‘</p>
        </div>
    </aside>

    <div id="sidebarOverlay" class="fixed inset-0 bg-black/10 z-40 hidden lg:hidden"></div>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col overflow-hidden bg-gray-50">
        <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-8 shrink-0 z-10 shadow-sm">
            <div class="flex items-center gap-4">
                <button id="openSidebar" class="p-2 lg:hidden rounded-lg hover:bg-gray-100 text-gray-600"><i class="fas fa-bars text-xl"></i></button>
                <h2 id="pageTitle" class="text-xl font-bold text-gray-800 tracking-tight">ê¸¸ë“œ í˜„í™©íŒ</h2>
            </div>
            <div class="flex items-center gap-4">
                <div class="px-4 py-1.5 bg-pink-50 text-pink-600 rounded-full text-xs font-bold border border-pink-100 shadow-sm">
                    âœ¨ <span id="counterLabel">ì „ì²´ ì¸ì›</span>: <span id="totalMembersCount">0</span>ëª…
                </div>
                <button onclick="fetchMembers()" class="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-gray-100 text-gray-400 transition-all border border-gray-100 shadow-sm"><i class="fas fa-sync-alt"></i></button>
            </div>
        </header>

        <div id="contentArea" class="flex-1 overflow-y-auto p-4 lg:p-10 relative bg-gray-50"></div>
    </main>

    <!-- Modals -->
    <!-- Member Form Modal -->
    <div id="memberModal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/30 backdrop-blur-sm hidden fade-in font-bold">
        <div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-md overflow-hidden border border-gray-100">
            <div class="p-6 bg-pink-50 border-b border-pink-100 flex justify-between items-center">
                <div>
                    <h3 id="modalTitle" class="text-lg font-bold text-pink-700 tracking-tight">ë©¤ë²„ ì •ë³´ ì…ë ¥</h3>
                </div>
                <button onclick="closeModal('memberModal')"><i class="fas fa-times text-gray-400 text-lg"></i></button>
            </div>
            <form id="memberForm" class="p-8 space-y-5">
                <input type="hidden" id="editMemberId">
                <div class="space-y-1">
                    <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">ë‹‰ë„¤ì„</label>
                    <input type="text" id="inputName" class="w-full border border-gray-100 bg-gray-50 rounded-2xl p-3.5 outline-none focus:ring-4 focus:ring-pink-50 text-sm font-bold shadow-inner" required placeholder="ì •í™•í•œ ìºë¦­í„°ëª…">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">ì†Œì†</label>
                        <select id="inputGuild" class="w-full border border-gray-100 bg-gray-50 rounded-2xl p-3.5 text-sm font-bold outline-none" onchange="onGuildSelectChange(this.value)"></select>
                    </div>
                    <div class="space-y-1">
                        <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">ì§ìœ„</label>
                        <select id="inputRole" class="w-full border border-gray-100 bg-gray-50 rounded-2xl p-3.5 text-sm font-bold outline-none"></select>
                    </div>
                </div>
                <div class="space-y-1">
                    <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">ì§ì—…</label>
                    <input type="text" id="inputClass" class="w-full border border-gray-100 bg-gray-50 rounded-2xl p-3.5 text-sm font-bold outline-none shadow-inner" placeholder="ì§ì—…ëª…">
                </div>
                <div class="flex items-center gap-3 py-1">
                    <input type="checkbox" id="inputIsMain" class="w-5 h-5 text-pink-500 rounded focus:ring-pink-50 shadow-sm cursor-pointer" checked onchange="toggleMainCharInput()">
                    <label for="inputIsMain" class="text-[11px] font-bold text-gray-600 uppercase tracking-tight cursor-pointer">ë³¸ìºë¦­í„°ì…ë‹ˆê¹Œ?</label>
                </div>
                <div id="mainCharInputGroup" class="hidden animate-fade-in space-y-1">
                    <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">ë³¸ìº ë‹‰ë„¤ì„</label>
                    <input type="text" id="inputMainCharName" class="w-full border border-gray-100 bg-gray-50 rounded-2xl p-3.5 text-sm font-bold outline-none shadow-inner" placeholder="ë³¸ìºë¦­ëª… ì…ë ¥">
                </div>
                <div class="space-y-1">
                    <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">ê°€ì… ë‚ ì§œ</label>
                    <input type="date" id="inputJoinDate" class="w-full border border-gray-100 bg-gray-50 rounded-2xl p-3.5 text-sm font-bold outline-none cursor-pointer">
                </div>
                <button type="submit" id="btnSubmitMember" class="w-full bg-gray-900 text-white py-4 rounded-2xl font-bold uppercase text-[10px] tracking-widest hover:bg-black transition-all shadow-xl mt-2">ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥</button>
            </form>
        </div>
    </div>

    <!-- Bulk Import Modal -->
    <div id="bulkModal" class="fixed inset-0 z-[120] flex items-center justify-center bg-black/40 backdrop-blur-md hidden fade-in font-bold">
        <div class="bg-white rounded-[2.5rem] shadow-2xl w-full max-w-4xl overflow-hidden flex flex-col h-[85vh] border border-gray-100">
            <div class="p-6 bg-gray-50 border-b border-gray-100 flex justify-between items-center px-10">
                <h3 class="font-bold text-gray-600 text-sm"><i class="fas fa-file-import mr-2 text-pink-500"></i> ëŒ€ëŸ‰ ëª…ë‹¨ ë°ì´í„° ë“±ë¡</h3>
                <button onclick="closeModal('bulkModal')"><i class="fas fa-times text-gray-400"></i></button>
            </div>
            <div class="p-10 flex-1 overflow-y-auto flex flex-col gap-8">
                <div class="bg-indigo-50 p-6 rounded-3xl border border-indigo-100 flex items-center gap-5 shadow-inner">
                    <div class="text-indigo-500 text-2xl"><i class="fas fa-info-circle"></i></div>
                    <p class="text-xs text-indigo-600 font-bold">ì—‘ì…€ì—ì„œ [ë„ˆêµ´, ëš ì¹´ë¡±, ì—ë°˜] ì²˜ëŸ¼ ë‹‰ë„¤ì„, ê¸¸ë“œëª…, ì§ì—… ìˆœì„œë¡œ ë³µì‚¬í•´ì„œ ë„£ìœ¼ì„¸ìš”.</p>
                </div>
                <div class="flex-1 flex flex-col lg:flex-row gap-8 min-h-0">
                    <div class="flex-1 flex flex-col">
                        <textarea id="bulkInput" oninput="parseBulkInput()" class="w-full flex-1 border border-gray-200 rounded-[2rem] p-6 font-mono text-sm outline-none focus:ring-8 focus:ring-indigo-50 resize-none bg-gray-50 shadow-inner" placeholder="ì´ê³³ì— ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>
                    </div>
                    <div class="flex-1 flex flex-col border border-gray-200 rounded-[2rem] overflow-hidden bg-white shadow-sm">
                        <div class="p-4 bg-gray-50 border-b border-gray-100 font-bold text-[11px] text-gray-500 text-center">ë“±ë¡ ëŒ€ê¸° ëª…ë‹¨</div>
                        <div class="flex-1 overflow-auto no-scrollbar shadow-inner">
                            <table class="w-full text-left text-[11px] whitespace-nowrap font-bold">
                                <thead class="bg-gray-50 text-gray-400 sticky top-0 shadow-sm">
                                    <tr><th class="px-5 py-3 border-b">ìƒíƒœ</th><th class="px-5 py-3 border-b">ë‹‰ë„¤ì„</th><th class="px-5 py-3 border-b">ì†Œì†</th><th class="px-5 py-3 border-b">ì§ì—…</th></tr>
                                </thead>
                                <tbody id="bulkPreviewBody" class="divide-y divide-gray-50"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t border-gray-100 bg-gray-50 flex justify-end gap-3 px-12 items-center">
                <span id="bulkStats" class="text-xs text-gray-500 font-bold mr-auto"></span>
                <button id="btnExecuteBulk" onclick="saveBulkData()" class="px-12 py-3 bg-gray-900 text-white rounded-2xl hover:bg-black font-bold text-xs shadow-xl transition-all disabled:opacity-30">ì…ë ¥í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirm Modal -->
    <div id="deleteModal" class="fixed inset-0 z-[110] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden fade-in font-bold">
        <div class="bg-white rounded-[2.5rem] shadow-2xl w-full max-w-sm p-10 text-center border border-gray-50">
            <div class="w-16 h-16 bg-red-50 text-red-500 rounded-2xl flex items-center justify-center text-2xl mx-auto mb-5 shadow-inner"><i class="fas fa-user-minus"></i></div>
            <p class="text-gray-800 font-bold text-lg mb-6 leading-tight">'<span id="deleteTargetName" class="text-red-500"></span>' ì œê±° í™•ì •</p>
            <div class="space-y-4 text-left mb-8">
                <div class="flex gap-2">
                    <button onclick="setDeleteType('leave')" id="btnLeave" class="flex-1 py-3 rounded-xl font-bold text-xs bg-gray-800 text-white shadow-sm transition-all">ìì§„íƒˆí‡´</button>
                    <button onclick="setDeleteType('kick')" id="btnKick" class="flex-1 py-3 rounded-xl font-bold text-xs bg-gray-100 text-gray-400 transition-all">ì¶”ë°©</button>
                </div>
                <input type="text" id="deleteReason" class="w-full border border-gray-100 bg-gray-50 rounded-xl p-3 text-xs font-bold outline-none shadow-inner" placeholder="ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì´ë ¥ìš©)">
            </div>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="closeModal('deleteModal')" class="py-4 bg-gray-50 rounded-2xl font-bold text-xs text-gray-500 hover:bg-gray-100 transition-all">ì·¨ì†Œ</button>
                <button onclick="confirmDelete()" class="py-4 bg-red-500 text-white rounded-2xl font-bold text-xs shadow-xl hover:bg-red-600 transition-all">ì‚­ì œ í™•ì •</button>
            </div>
        </div>
    </div>

    <!-- Factory Reset Modal -->
    <div id="resetModal" class="fixed inset-0 z-[110] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden fade-in font-bold">
        <div class="bg-white rounded-[3rem] shadow-2xl w-full max-w-md p-12 text-center border border-gray-50">
            <div class="w-20 h-20 bg-red-50 text-red-500 rounded-[2rem] flex items-center justify-center text-4xl mx-auto mb-6 shadow-inner"><i class="fas fa-radiation"></i></div>
            <h3 class="text-2xl font-black text-gray-800 tracking-tight mb-4">ë°ì´í„° ì „ì²´ ì´ˆê¸°í™”</h3>
            <p class="text-xs text-gray-500 mb-8 leading-relaxed">êµ¬ê¸€ ì‹œíŠ¸ì˜ ëª¨ë“  ë°ì´í„°ì™€ ë¡œê·¸ê°€ ì™„ì „íˆ ì§€ì›Œì§‘ë‹ˆë‹¤.<br>ì •ë§ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="closeModal('resetModal')" class="py-4 bg-gray-50 rounded-2xl font-bold text-xs text-gray-500 hover:bg-gray-100 transition-all">ì·¨ì†Œ</button>
                <button onclick="confirmReset()" class="py-4 bg-red-600 text-white rounded-2xl font-bold text-xs shadow-xl hover:bg-red-700 transition-all">ì´ˆê¸°í™” ì§„í–‰</button>
            </div>
        </div>
    </div>

    <script>
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwRi3BSBpU3QO2gTS7lcGdnLtohNwLNLlaammBPMAIWVzigmz6o6TGjVtvaerO2akfZ/exec";
        const DEFAULT_SHEET_URL = "https://docs.google.com/spreadsheets/d/1pu_PIJ03omYU00jAmJ5FSvyjs_sqLxAU90_xjfY_yjQ/edit?gid=260394678#gid=260394678";
        const GUILD_START_DATE = new Date('2020-03-17');
        
        const baseRanks = ['ë§ˆì¹´ë¡±', 'ë‹¤ì¿ ì•„ì¦ˆ'];
        const initialGuildRanks = {
            'ëš ì¹´ë¡±': [...baseRanks, 'í¬ë¼ìš´', 'íŒŒë¥´í˜', 'í‹°ë¼ë¯¸ìŠˆ', 'í¬ë¡œì¹¸ìŠˆ', 'ë¡¤ì¼€ì´í¬', 'íŒ¬ì¼€ì´í¬', 'ì™€í”Œ', 'ìŠ¤ì½˜', 'ë°˜ì£½'],
            'ëš±ì¹´ë¡±': [...baseRanks, 'ëš ì¼€ì´í¬', 'ëš ë¸Œë ˆë“œ', 'ìˆ˜í”Œë ˆ', 'ëš ìŠ¤ì½˜'],
            'ë°¤ì¹´ë¡±': [...baseRanks, 'ë¶€íŒ¬ì¼€ì´í¬', 'ë¶€ì¼€ì´í¬', 'ì•„ì¸ìŠˆí˜ë„ˆ'],
            'ë³„ì¹´ë¡±': [...baseRanks, 'ë¶€íŒ¬ì¼€ì´í¬', 'ë¶€ì¼€ì´í¬', 'ì•„ì¸ìŠˆí˜ë„ˆ'],
            'ë‹¬ì¹´ë¡±': [...baseRanks, 'ë¶€íŒ¬ì¼€ì´í¬', 'ë¶€ì¼€ì´í¬', 'ì•„ì¸ìŠˆí˜ë„ˆ'],
            'ê¿€ì¹´ë¡±': [...baseRanks, 'ë¶€íŒ¬ì¼€ì´í¬', 'ë¶€ì¼€ì´í¬', 'ì•„ì¸ìŠˆí˜ë„ˆ']
        };
        
        const appState = {
            activeTab: 'dashboard',
            guilds: [
                { id: 'ddun', name: 'ëš ì¹´ë¡±', type: 'ë©”ì¸ 1ê¸°', color: '#f472b6', icon: 'fa-crown', max: 200 },
                { id: 'ddung', name: 'ëš±ì¹´ë¡±', type: 'ë©”ì¸ 2ê¸°', color: '#fb7185', icon: 'fa-heart', max: 200 },
                { id: 'bam', name: 'ë°¤ì¹´ë¡±', type: 'ë¶€ìº 1ê¸°', color: '#6366f1', icon: 'fa-moon', max: 200 },
                { id: 'byeol', name: 'ë³„ì¹´ë¡±', type: 'ë¶€ìº 2ê¸°', color: '#facc15', icon: 'fa-star', max: 200 },
                { id: 'dal', name: 'ë‹¬ì¹´ë¡±', type: 'ë¶€ìº 3ê¸°', color: '#60a5fa', icon: 'fa-sun', max: 200 },
                { id: 'kkul', name: 'ê¿€ì¹´ë¡±', type: 'ë¶€ìº 4ê¸°', color: '#fbbf24', icon: 'fa-cube', max: 200 },
            ],
            members: [],
            history: [],
            guildRanks: {},
            filters: { guild: 'all', search: '', sortField: 'name', sortOrder: 'asc', page: 1 },
            deleteType: 'leave',
            tempSettingsRankGuild: 'ëš ì¹´ë¡±',
            parsedBulkData: [],
            scriptUrl: localStorage.getItem('macaron_script_url') || APPS_SCRIPT_URL,
            sheetUrl: localStorage.getItem('macaron_sheet_url') || DEFAULT_SHEET_URL
        };

        const savedRanks = localStorage.getItem('macaron_ranks_v19');
        if (savedRanks) {
            appState.guildRanks = JSON.parse(savedRanks);
        } else {
            appState.guilds.forEach(g => {
                appState.guildRanks[g.name] = initialGuildRanks[g.name] ? [...initialGuildRanks[g.name]] : [...initialGuildRanks['ëš ì¹´ë¡±']];
            });
        }

        function showMsg(text, type = 'info') {
            const box = document.getElementById('msgBox');
            const icon = document.getElementById('msgIcon');
            const txt = document.getElementById('msgText');
            if(!box || !txt) return;
            txt.innerText = text;
            icon.innerHTML = type === 'success' ? '<i class="fas fa-check-circle text-green-400"></i>' : 
                             type === 'error' ? '<i class="fas fa-exclamation-circle text-red-400"></i>' : 
                             '<i class="fas fa-info-circle text-pink-400"></i>';
            box.classList.add('show');
            setTimeout(() => box.classList.remove('show'), 3500);
        }

        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.remove('force-hide');
                setTimeout(() => {
                    const btn = document.getElementById('forceEnterBtn');
                    if (btn && !overlay.classList.contains('force-hide')) btn.classList.remove('hidden');
                }, 4000);
            } else {
                overlay.classList.add('force-hide');
            }
        }

        function hideOverlay() { showLoading(false); }

        async function fetchMembers() {
            if(!appState.scriptUrl) { router('settings'); hideOverlay(); return; }
            showLoading(true);
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 12000);

            try {
                const response = await fetch(appState.scriptUrl, { 
                    method: 'GET', 
                    mode: 'cors',
                    cache: 'no-cache',
                    redirect: 'follow',
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                if (!response.ok) throw new Error(`Status: ${response.status}`);
                
                const json = await response.json();
                if (json.status === "success") {
                    appState.members = json.data.members || [];
                    appState.history = json.data.history || [];
                    
                    const countEl = document.getElementById('totalMembersCount');
                    if(countEl) countEl.innerText = appState.members.length;
                    
                    router(appState.activeTab);
                    showLoading(false);
                } else {
                    throw new Error(json.message || "ì„œë²„ ë¡œì§ ì—ëŸ¬");
                }
            } catch (e) {
                clearTimeout(timeoutId);
                console.error("Fetch Error:", e);
                showMsg("ì„œë²„ ë™ê¸°í™” ì‹¤íŒ¨. GAS ë°°í¬ ê¶Œí•œì„ [ëª¨ë“  ì‚¬ìš©ì]ë¡œ ë³€ê²½í•´ì£¼ì„¸ìš”.", "error");
                document.getElementById('forceEnterBtn')?.classList.remove('hidden');
            }
        }

        async function sendAction(action, data, btnId) {
            if(!appState.scriptUrl) return showMsg("ì—°ë™ ì£¼ì†Œê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.", "error");
            const btn = btnId ? document.getElementById(btnId) : null;
            if (btn) btn.classList.add('btn-loading');
            showMsg("ì„œë²„ì— ë°ì´í„°ë¥¼ ì „ì†¡ ì¤‘ì…ë‹ˆë‹¤...", "info");
            
            try {
                const response = await fetch(appState.scriptUrl, {
                    method: 'POST',
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify({ action, data }),
                    redirect: 'follow'
                });
                
                let result;
                try {
                    result = await response.json();
                } catch(e) {
                    result = { status: "success" }; 
                }

                if (result.status === "success") {
                    showMsg("ì„œë²„ ë°˜ì˜ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!", "success");
                    await fetchMembers();
                    return true;
                } else {
                    showMsg(result.message || "ì²˜ë¦¬ ì‹¤íŒ¨", "error");
                    return false;
                }
            } catch (e) {
                console.error("Post Action Error:", e);
                showMsg("ì„œë²„ ì „ì†¡ ì‹¤íŒ¨! ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.", "error");
                return false;
            } finally {
                if (btn) btn.classList.remove('btn-loading');
            }
        }

        function router(tab) {
            appState.activeTab = tab;
            const content = document.getElementById('contentArea');
            if (!content) return;
            content.innerHTML = '';
            document.querySelectorAll('.nav-item').forEach(el => {
                if(el.dataset.target === tab) {
                    el.classList.add('bg-pink-50', 'text-pink-600');
                    el.classList.remove('text-gray-600');
                } else {
                    el.classList.remove('bg-pink-50', 'text-pink-600');
                    el.classList.add('text-gray-600');
                }
            });

            const titles = { dashboard: 'ê¸¸ë“œ í˜„í™©íŒ', members: 'ê¸¸ë“œì› ê´€ë¦¬', sheet: 'ì‹œíŠ¸ ë³´ê¸°', history: 'ìš´ì˜ ì´ë ¥', settings: 'ì‹œìŠ¤í…œ ì„¤ì •' };
            document.getElementById('pageTitle').innerText = titles[tab] || '';

            if (tab === 'dashboard') renderDashboard(content);
            else if (tab === 'members') renderMembers(content);
            else if (tab === 'sheet') renderSheet(content);
            else if (tab === 'history') renderHistory(content);
            else if (tab === 'settings') renderSettings(content);
        }

        function getAnniversaryInfo() {
            const now = new Date();
            const diff = now - GUILD_START_DATE;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const years = Math.floor(days / 365);
            const remainingDays = days % 365;
            return { totalDays: days, years: years, remainingDays: remainingDays };
        }

        function renderCalendar() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const today = now.getDate();
            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();
            
            const monthNames = ["1ì›”", "2ì›”", "3ì›”", "4ì›”", "5ì›”", "6ì›”", "7ì›”", "8ì›”", "9ì›”", "10ì›”", "11ì›”", "12ì›”"];
            
            let html = `
                <div class="mb-4 flex justify-between items-end">
                    <h4 class="text-xl font-bold text-gray-800">${monthNames[month]} <span class="text-gray-400 text-sm">${year}</span></h4>
                </div>
                <div class="calendar-grid">
                    <div class="calendar-head text-red-400">ì¼</div>
                    <div class="calendar-head">ì›”</div>
                    <div class="calendar-head">í™”</div>
                    <div class="calendar-head">ìˆ˜</div>
                    <div class="calendar-head text-pink-500">ëª©</div>
                    <div class="calendar-head">ê¸ˆ</div>
                    <div class="calendar-head text-blue-400">í† </div>
            `;

            for(let i=0; i<firstDay; i++) html += `<div></div>`;
            
            for(let d=1; d<=lastDate; d++) {
                const date = new Date(year, month, d);
                const dayOfWeek = date.getDay();
                let classes = "calendar-day text-gray-600";
                let content = d;
                
                if (dayOfWeek === 4) {
                    classes += " thursday"; // ëª©ìš”ì¼ ê°•ì¡°
                    content = `<span class="relative z-10">${d}</span><i class="fas fa-sync-alt absolute top-0.5 right-1 text-[8px] text-pink-300 opacity-50"></i>`;
                }
                if (d === today) classes += " today";
                
                html += `<div class="${classes}">${content}</div>`;
            }
            html += `</div>`;
            return html;
        }

        function renderDashboard(container) {
            const anniv = getAnniversaryInfo();
            const wrap = document.createElement('div');
            wrap.className = "grid grid-cols-1 xl:grid-cols-2 gap-10 fade-in";
            wrap.innerHTML = `
                <div class="bg-white p-10 rounded-[3rem] shadow-sm border border-gray-100 flex flex-col justify-between">
                     <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">ğŸ“…</span>
                            <div>
                                <h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest">Guild Calendar</h3>
                                <p class="text-[10px] text-pink-400 font-bold">ëª©ìš”ì¼ì€ ì£¼ê°„ ì´ˆê¸°í™”!</p>
                            </div>
                        </div>
                        <div class="text-right">
                             <div class="text-2xl font-black text-gray-800 tracking-tight">D+${anniv.totalDays}</div>
                             <div class="text-[10px] font-bold text-gray-400 bg-gray-100 px-2 py-0.5 rounded-lg inline-block">ìƒì„±ëœ ì§€ ${anniv.years}ë…„ ${anniv.remainingDays}ì¼ ì§€ë‚¨</div>
                        </div>
                     </div>
                     ${renderCalendar()}
                </div>
                <div class="bg-white p-12 rounded-[2.5rem] shadow-sm border border-gray-100 flex flex-col justify-center text-center">
                    <div class="w-16 h-16 bg-pink-100 text-pink-500 rounded-3xl flex items-center justify-center text-2xl mx-auto mb-6 shadow-sm"><i class="fas fa-sync-alt"></i></div>
                    <h3 class="text-xl font-bold text-gray-800 tracking-tight leading-none mb-3">í´ë¼ìš°ë“œ ë°ì´í„° ë™ê¸°í™”</h3>
                    <p class="text-xs text-gray-400 font-bold uppercase tracking-widest opacity-60">ë‹‰ë„¤ì„ ê¸°ë°˜ ê³ ìœ  ê´€ë¦¬ ì‹œìŠ¤í…œ</p>
                </div>
            `;
            container.appendChild(wrap);

            const grid = document.createElement('div');
            grid.className = "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-10 fade-in";
            appState.guilds.forEach(g => {
                const count = appState.members.filter(m => m.guild === g.name).length;
                const pct = Math.min((count / g.max) * 100, 100);
                grid.innerHTML += `
                    <div class="bg-white p-10 rounded-[2.5rem] border border-gray-100 shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all group cursor-pointer" onclick="filterByGuild('${g.name}')">
                        <div class="flex justify-between items-start mb-8">
                            <span class="font-bold text-lg text-gray-800 group-hover:text-pink-500 transition-colors">${g.name}</span>
                            <span class="text-[10px] bg-gray-50 text-gray-500 px-3 py-1.5 rounded-xl font-bold">${g.type}</span>
                        </div>
                        <div class="flex justify-between text-[10px] mb-2 text-gray-400 font-bold">
                            <span>ì¸ì›</span><span class="text-gray-800 font-bold">${count} / ${g.max}</span>
                        </div>
                        <div class="w-full bg-gray-50 rounded-full h-1.5 overflow-hidden shadow-inner"><div class="h-full bg-pink-500 rounded-full transition-all duration-1000 shadow-sm" style="width:${pct}%; background-color:${g.color}"></div></div>
                    </div>`;
            });
            container.appendChild(grid);
        }

        function renderMembers(container) {
            container.innerHTML = `
                <div class="flex flex-col gap-8 fade-in">
                    <div class="bg-white p-10 rounded-t-[3rem] border border-gray-100 space-y-8 shadow-sm">
                        <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                            <div class="flex overflow-x-auto pb-2 no-scrollbar w-full md:w-auto gap-3">
                                <button onclick="filterByGuild('all')" class="shrink-0 whitespace-nowrap px-8 py-3 rounded-2xl text-xs font-bold transition-all ${appState.filters.guild === 'all' ? 'bg-gray-800 text-white shadow-xl' : 'bg-gray-50 text-gray-500 hover:bg-gray-100'}">ì „ì²´ ë³´ê¸°</button>
                                ${appState.guilds.map(g => `<button onclick="filterByGuild('${g.name}')" class="shrink-0 whitespace-nowrap px-8 py-3 rounded-2xl text-xs font-bold transition-all ${appState.filters.guild === g.name ? 'bg-pink-500 text-white shadow-xl shadow-pink-100' : 'bg-gray-50 text-gray-500 hover:bg-gray-100'}">${g.name}</button>`).join('')}
                            </div>
                            <div class="flex gap-4 w-full md:w-auto">
                                <button onclick="openBulkModal()" class="shrink-0 flex-1 md:flex-none px-8 py-3.5 bg-emerald-500 text-white rounded-2xl text-xs font-bold shadow-xl hover:bg-emerald-600 transition-all"><i class="fas fa-file-import mr-2"></i> ì¼ê´„ ë“±ë¡</button>
                                <button onclick="openAddModal()" class="shrink-0 flex-1 md:flex-none px-10 py-3.5 bg-pink-500 text-white rounded-2xl text-xs font-bold shadow-xl hover:bg-pink-600 transition-all"><i class="fas fa-plus mr-2"></i> ë©¤ë²„ ì¶”ê°€</button>
                            </div>
                        </div>
                        <div class="relative"><i class="fas fa-search absolute left-6 top-1/2 -translate-y-1/2 text-gray-400 text-sm"></i><input type="text" oninput="handleSearch(this.value)" value="${appState.filters.search}" class="w-full pl-16 pr-8 py-4 bg-gray-50 border border-gray-100 rounded-[2rem] outline-none focus:ring-4 focus:ring-pink-50 font-bold text-sm shadow-inner" placeholder="ë‹‰ë„¤ì„, ì§ì—…, ì§ìœ„, êµ¬ë¶„(ë³¸ìº/ë¶€ìº) ê²€ìƒ‰"></div>
                    </div>
                    <div id="memberTableContainer" class="bg-white rounded-b-[3rem] border border-gray-100 overflow-hidden shadow-sm"></div>
                </div>`;
            updateMemberTable();
        }

        function updateMemberTable() {
            const container = document.getElementById('memberTableContainer');
            if(!container) return;
            const term = appState.filters.search.toLowerCase();
            const filtered = appState.members.filter(m => {
                const gMatch = appState.filters.guild === 'all' || m.guild === appState.filters.guild;
                const sMatch = (m.name || '').toLowerCase().includes(term) || 
                               (m.role || '').toLowerCase().includes(term) || 
                               (m.class || '').toLowerCase().includes(term) || 
                               (m.isMain ? 'ë³¸ìº' : 'ë¶€ìº').includes(term);
                return gMatch && sMatch;
            });
            
            // ë‹‰ë„¤ì„ ìœ ë‹ˆì½”ë“œ ë° í…ìŠ¤íŠ¸ ê¸°ì¤€ ì˜¤ë¦„ì°¨ìˆœ/ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
            filtered.sort((a, b) => { 
                const vA = (a[appState.filters.sortField] || '').toString(); 
                const vB = (b[appState.filters.sortField] || '').toString(); 
                
                if (vA < vB) return appState.filters.sortOrder === 'asc' ? -1 : 1;
                if (vA > vB) return appState.filters.sortOrder === 'asc' ? 1 : -1;
                return 0;
            });

            const countLabel = appState.filters.guild === 'all' ? 'ì „ì²´ ì¸ì›' : appState.filters.guild + ' ì¸ì›';
            const labelEl = document.getElementById('counterLabel');
            if(labelEl) labelEl.innerText = countLabel;
            
            const countEl = document.getElementById('totalMembersCount');
            if(countEl) countEl.innerText = filtered.length;

            // í—¤ë” í´ë¦­ ì •ë ¬ í‘œì‹œìš© ì•„ì´ì½˜ í—¬í¼
            const getSortIcon = (f) => {
                if (appState.filters.sortField !== f) return '<i class="fas fa-sort ml-1 opacity-30 text-[9px]"></i>';
                return appState.filters.sortOrder === 'asc' ? '<i class="fas fa-sort-up ml-1 text-pink-500 text-[10px]"></i>' : '<i class="fas fa-sort-down ml-1 text-pink-500 text-[10px]"></i>';
            };

            let html = `<div class="overflow-x-auto shadow-inner"><table class="w-full text-left min-w-[900px] text-xs whitespace-nowrap"><thead class="bg-gray-50 text-[10px] font-bold text-gray-500 border-b border-gray-100"><tr>
                <th class="p-8 text-center w-16">No.</th>
                <th class="p-8 sortable hover:bg-gray-100 transition-colors" onclick="handleSort('name')">ë‹‰ë„¤ì„ ${getSortIcon('name')}</th>
                <th class="p-8">êµ¬ë¶„</th>
                <th class="p-8 sortable hover:bg-gray-100 transition-colors" onclick="handleSort('guild')">ì†Œì† ${getSortIcon('guild')}</th>
                <th class="p-8 sortable hover:bg-gray-100 transition-colors" onclick="handleSort('role')">ì§ìœ„ ${getSortIcon('role')}</th>
                <th class="p-8 sortable hover:bg-gray-100 transition-colors" onclick="handleSort('class')">ì§ì—… ${getSortIcon('class')}</th>
                <th class="p-8 text-right">ê´€ë¦¬</th>
            </tr></thead><tbody class="divide-y divide-gray-50 text-gray-600 font-bold">`;
            
            if (filtered.length === 0) html += `<tr><td colspan="7" class="p-20 text-center text-gray-300 font-bold">ê²€ìƒ‰ëœ ê¸¸ë“œì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
            
            filtered.forEach((m, index) => {
                let iconHtml = '';
                if (m.role === 'ë§ˆì¹´ë¡±') {
                    iconHtml = '<i class="fas fa-crown text-blue-500 text-sm shadow-sm" style="text-shadow: 0 0 8px rgba(59,130,246,0.6);"></i>';
                } else if (m.role === 'ë‹¤ì¿ ì•„ì¦ˆ') {
                    iconHtml = '<i class="fas fa-crown text-pink-500 text-sm shadow-sm" style="text-shadow: 0 0 8px rgba(236,72,153,0.6);"></i>';
                } else {
                    let dotClass = 'bg-gray-200';
                    if (m.isMain) {
                        if (['í¬ë¼ìš´', 'íŒŒë¥´í˜', 'í‹°ë¼ë¯¸ìŠˆ', 'í¬ë¡œì¹¸ìŠˆ'].includes(m.role)) {
                            dotClass = 'bg-blue-500 shadow-[0_0_8px_rgba(59,130,246,0.5)]';
                        } else if (['íŒ¬ì¼€ì´í¬', 'ë¡¤ì¼€ì´í¬'].includes(m.role)) {
                            dotClass = 'bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.5)]';
                        } else {
                            dotClass = 'bg-pink-500 shadow-[0_0_8px_rgba(236,72,153,0.5)]';
                        }
                    }
                    iconHtml = `<div class="w-2.5 h-2.5 rounded-full ${dotClass}"></div>`;
                }
                
                html += `<tr class="hover:bg-pink-50/20 transition-all group">
                    <td class="p-8 text-center text-gray-400 font-black text-[11px]">${index + 1}</td>
                    <td class="p-8 leading-none"><div class="flex items-center gap-4 leading-none">${iconHtml}<span class="text-sm font-bold text-gray-800 tracking-tight leading-none">${m.name}</span></div></td>
                    <td class="p-8 leading-none">${m.isMain ? '<span class="text-[9px] font-bold bg-pink-50 text-pink-500 px-4 py-1.5 rounded-full border border-pink-100 shadow-sm">ë³¸ìº</span>' : `<span class="text-[9px] font-bold text-gray-400">ë¶€ìº / ${m.mainCharName || '-'}</span>`}</td>
                    <td class="p-8 font-bold text-gray-500 leading-none">${m.guild}</td>
                    <td class="p-8 leading-none"><span class="bg-gray-100 text-gray-500 px-4 py-1.5 rounded-xl font-bold text-[10px] shadow-sm">${m.role}</span></td>
                    <td class="p-8 font-bold text-gray-400 leading-none">${m.class || '-'}</td>
                    <td class="p-8 text-right opacity-0 group-hover:opacity-100 transition-opacity leading-none"><div class="flex justify-end gap-2"><button onclick="openEditModal('${m.id}')" class="w-10 h-10 rounded-xl bg-white border border-gray-100 text-blue-500 hover:bg-blue-50 shadow-sm transition-all flex items-center justify-center"><i class="fas fa-edit"></i></button><button onclick="openDeleteModal('${m.id}')" class="w-10 h-10 rounded-xl bg-white border border-gray-100 text-red-500 hover:bg-red-50 shadow-sm transition-all flex items-center justify-center"><i class="fas fa-trash-alt"></i></button></div></td>
                </tr>`;

                if ((index + 1) % 17 === 0 && index !== filtered.length - 1) {
                    html += `<tr><td colspan="7" class="p-0 border-b-[3px] border-dashed border-pink-300"></td></tr>`;
                }
            });
            html += `</tbody></table></div>`;
            container.innerHTML = html;
        }

        function renderSheet(container) {
            const sheetUrl = appState.sheetUrl;
            let embedUrl = (sheetUrl && sheetUrl.includes("docs.google.com/spreadsheets")) ? (sheetUrl.split('/edit')[0] + "/preview") : "";
            container.innerHTML = `<div class="h-full flex flex-col gap-6 fade-in font-bold"><div class="bg-white p-6 rounded-[2rem] border border-gray-100 shadow-sm flex flex-col md:flex-row justify-between items-center gap-6"><div><h3 class="text-sm font-bold text-gray-800">ì›ë³¸ ë°ì´í„° ì‹œíŠ¸ ë·°ì–´</h3><p class="text-[10px] text-gray-400 font-bold mt-2">A~Gì—´ ì›ë³¸ êµ¬ê¸€ ì‹œíŠ¸ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.</p></div><button onclick="window.open('${sheetUrl || '#'}', '_blank')" class="px-10 py-4 bg-gray-900 text-white rounded-2xl text-[10px] font-bold shadow-xl hover:bg-black transition-all">ìƒˆ ì°½ì—ì„œ ì‹œíŠ¸ ì—´ê¸°</button></div><div class="flex-1 bg-white border border-gray-100 rounded-[2.5rem] shadow-inner overflow-hidden relative">${embedUrl ? `<iframe src="${embedUrl}" class="w-full h-full border-none"></iframe>` : `<div class="absolute inset-0 flex flex-col items-center justify-center text-gray-300"><i class="fas fa-table text-7xl mb-6 opacity-20"></i><p class="text-xs">ì„¤ì • ë©”ë‰´ì—ì„œ ì‹œíŠ¸ ë§í¬ë¥¼ ì—°ë™í•´ì£¼ì„¸ìš”.</p></div>`}</div></div>`;
        }

        function renderHistory(container) {
            container.innerHTML = `<div class="bg-white rounded-[2.5rem] border border-gray-100 shadow-sm overflow-hidden fade-in font-bold"><div class="p-8 border-b border-gray-50 flex items-center justify-between shadow-sm"><h3 class="text-sm font-bold text-gray-800"><i class="fas fa-history mr-2 text-pink-500"></i> ê¸¸ë“œ í™œë™ ìš´ì˜ ì´ë ¥</h3><span class="text-[10px] text-gray-400 font-bold">ëˆ„ì  ê¸°ë¡: ${appState.history.length} ê±´</span></div><div class="overflow-x-auto shadow-inner"><table class="w-full text-left text-xs whitespace-nowrap font-bold"><thead class="bg-gray-50 text-[10px] font-bold text-gray-500 border-b border-gray-100"><tr><th class="p-6">ì‹œê°„</th><th class="p-6 w-32">í™œë™ ë¶„ë¥˜</th><th class="p-8">ëŒ€ìƒ ë‹‰ë„¤ì„</th><th class="p-6">í™œë™ ìƒì„¸ ë‚´ìš©</th></tr></thead><tbody class="divide-y divide-gray-50 text-gray-600 font-bold">${appState.history.length === 0 ? `<tr><td colspan="4" class="p-20 text-center text-gray-300 font-bold">ê¸°ë¡ëœ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>` : appState.history.map(log => {
                const badge = log.category === 'ì¶”ë°©' ? 'bg-red-50 text-red-500 border border-red-100' : (log.category === 'íƒˆí‡´' || log.category === 'ìì§„íƒˆí‡´' ? 'bg-gray-100 text-gray-500 border border-gray-200' : 'bg-green-50 text-green-500 border border-green-100');
                return `<tr class="hover:bg-gray-50/50 transition-colors"><td class="p-6 font-mono text-gray-400 font-bold text-[10px] tracking-tighter">${log.date}</td><td class="p-6"><span class="px-3 py-1.5 rounded-lg text-[9px] font-bold ${badge} shadow-sm">${log.category}</span></td><td class="p-8 font-bold text-gray-800">${log.name}</td><td class="p-8 font-medium text-gray-500 font-bold text-[11px]">${log.content}</td></tr>`;
            }).join('')}</tbody></table></div></div>`;
        }

        function renderSettings(container) {
            container.innerHTML = `
                <div class="grid grid-cols-1 gap-10 fade-in max-w-4xl font-bold">
                    <div class="bg-white p-12 rounded-[2.5rem] border border-gray-100 shadow-sm font-bold">
                        <div class="flex items-center gap-5 mb-10"><div class="w-14 h-14 rounded-3xl bg-gray-900 text-white flex items-center justify-center text-2xl shadow-xl shadow-gray-200"><i class="fas fa-link"></i></div><div><h3 class="text-xl font-bold text-gray-800 tracking-tighter">í´ë¼ìš°ë“œ ì—°ë™ ì„¤ì •</h3><p class="text-[10px] text-gray-400 font-bold mt-2">API ë° ì‹œíŠ¸ ì£¼ì†Œë¥¼ êµ¬ì„±í•©ë‹ˆë‹¤.</p></div></div>
                        <div class="space-y-8 font-bold">
                            <div class="space-y-2"><label class="text-[10px] font-bold text-gray-400 ml-1">ì•±ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ API URL</label><input type="text" id="settingScriptUrl" value="${appState.scriptUrl}" class="w-full bg-gray-50 border border-gray-100 rounded-2xl p-5 text-xs font-bold outline-none focus:ring-4 focus:ring-gray-200 shadow-inner font-mono transition-all"></div>
                            <div class="space-y-2"><label class="text-[10px] font-bold text-gray-400 ml-1">êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ URL</label><input type="text" id="settingSheetUrl" value="${appState.sheetUrl}" class="w-full bg-gray-50 border border-gray-100 rounded-2xl p-5 text-xs font-bold outline-none focus:ring-4 focus:ring-gray-200 shadow-inner font-mono transition-all"></div>
                            <button onclick="saveSystemSettings()" class="w-full py-6 bg-gray-900 text-white rounded-3xl font-bold text-xs shadow-xl hover:bg-black transition-all active:scale-[0.98]">ì €ì¥ í›„ ì‹œìŠ¤í…œ ì¬ë¶€íŒ…</button>
                        </div>
                    </div>
                    <div class="bg-white p-12 rounded-[2.5rem] border border-gray-100 shadow-sm">
                        <div class="flex flex-col md:flex-row justify-between items-center gap-6 mb-12 pb-10 border-b border-gray-100">
                            <div>
                                <h3 class="text-xl font-bold text-gray-800 text-pink-500 tracking-tight">ê¸¸ë“œ ì§ìœ„ ì²´ê³„ (ì½ê¸° ì „ìš©)</h3>
                                <p class="text-[10px] text-gray-400 font-bold mt-2">ê¸¸ë“œë³„ ì§ìœ„ ëª©ë¡ì…ë‹ˆë‹¤.</p>
                            </div>
                            <select onchange="changeRankGuild(this.value)" class="bg-gray-50 border border-gray-100 rounded-2xl px-8 py-5 text-xs font-bold outline-none cursor-pointer hover:bg-gray-100 shadow-sm transition-all">${appState.guilds.map(g => `<option value="${g.name}" ${g.name === appState.tempSettingsRankGuild ? 'selected' : ''}>${g.name}</option>`).join('')}</select>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 mb-12">
                            ${(appState.guildRanks[appState.tempSettingsRankGuild] || []).map((r, i) => `<div class="flex items-center gap-4 bg-gray-50 border border-gray-100 p-5 rounded-3xl group hover:bg-white hover:border-pink-200 shadow-sm"><span class="w-8 text-center text-[10px] font-bold text-gray-400 group-hover:text-pink-400">${i+1}</span><div class="flex-1 text-sm font-bold text-gray-700">${r}</div></div>`).join('')}
                        </div>
                    </div>
                    <div class="bg-white p-12 rounded-[2.5rem] border border-red-100 shadow-sm mt-10">
                        <div class="text-center">
                             <div class="w-16 h-16 bg-red-50 text-red-500 rounded-2xl flex items-center justify-center text-2xl mx-auto mb-5 shadow-inner"><i class="fas fa-radiation"></i></div>
                             <h3 class="text-xl font-bold text-gray-800 mb-2">ê³µì¥ ì´ˆê¸°í™”</h3>
                             <p class="text-xs text-gray-400 font-bold mb-8">êµ¬ê¸€ ì‹œíŠ¸ì˜ ëª¨ë“  ë°ì´í„°ë¥¼ ì˜êµ¬ ì‚­ì œí•©ë‹ˆë‹¤.</p>
                             <button onclick="executeFactoryReset()" class="py-4 px-10 bg-red-500 text-white rounded-2xl font-bold text-xs shadow-xl hover:bg-red-600 transition-all">ì „ì²´ ë°ì´í„° ì´ˆê¸°í™”</button>
                        </div>
                    </div>
                </div>`;
        }

        // --- Logic Handlers ---
        function saveSystemSettings() {
            const script = document.getElementById('settingScriptUrl').value.trim(), sheet = document.getElementById('settingSheetUrl').value.trim();
            if(!script) return showMsg("API ì£¼ì†Œê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.", "error");
            localStorage.setItem('macaron_script_url', script); localStorage.setItem('macaron_sheet_url', sheet);
            showMsg("ì—°ë™ ë§í¬ ì„¤ì •ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤. ì¬ì‹œì‘ ì¤‘...", "success"); setTimeout(() => location.reload(), 1000);
        }

        function handleSearch(v) { appState.filters.search = v; appState.filters.page = 1; updateMemberTable(); }
        function filterByGuild(g) { appState.filters.guild = g; appState.filters.page = 1; updateMemberTable(); router('members'); }
        function handleSort(field) { if(appState.filters.sortField === field) appState.filters.sortOrder = appState.filters.sortOrder === 'asc' ? 'desc' : 'asc'; else { appState.filters.sortField = field; appState.filters.sortOrder = 'asc'; } updateMemberTable(); }
        function goToPage(p) { appState.filters.page = p; updateMemberTable(); }
        function openModal(id) { document.getElementById(id)?.classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id)?.classList.add('hidden'); }
        function onGuildSelectChange(v) {
            const roleSel = document.getElementById('inputRole'); if(roleSel) roleSel.innerHTML = (appState.guildRanks[v] || initialGuildRanks['ëš ì¹´ë¡±']).map(r => `<option value="${r}">${r}</option>`).join('');
        }
        function toggleMainCharInput() { document.getElementById('mainCharInputGroup').classList.toggle('hidden', document.getElementById('inputIsMain').checked); }
        
        function openAddModal() {
            document.getElementById('modalTitle').innerText = 'ë©¤ë²„ ì •ë³´ ì‹ ê·œ ë“±ë¡'; document.getElementById('memberForm').reset();
            document.getElementById('editMemberId').value = ''; document.getElementById('inputName').disabled = false;
            const gSel = document.getElementById('inputGuild'); if(gSel) { gSel.innerHTML = appState.guilds.map(g => `<option value="${g.name}">${g.name}</option>`).join(''); onGuildSelectChange(appState.guilds[0].name); }
            document.getElementById('inputJoinDate').value = new Date().toISOString().split('T')[0]; toggleMainCharInput(); openModal('memberModal');
        }

        function openEditModal(id) {
            const m = appState.members.find(x => x.id == id); if(!m) return;
            document.getElementById('modalTitle').innerText = 'ë©¤ë²„ ì •ë³´ ìˆ˜ì •í•˜ê¸°'; document.getElementById('editMemberId').value = m.id;
            document.getElementById('inputName').value = m.name; document.getElementById('inputName').disabled = true; 
            document.getElementById('inputClass').value = m.class || '';
            const gSel = document.getElementById('inputGuild'); if(gSel) { gSel.innerHTML = appState.guilds.map(g => `<option value="${g.name}" ${g.name === m.guild ? 'selected' : ''}>${g.name}</option>`).join(''); onGuildSelectChange(m.guild); }
            document.getElementById('inputRole').value = m.role; document.getElementById('inputIsMain').checked = m.isMain;
            document.getElementById('inputMainCharName').value = m.mainCharName || ''; document.getElementById('inputJoinDate').value = (m.joinDate || "").split('T')[0];
            toggleMainCharInput(); openModal('memberModal');
        }

        document.getElementById('memberForm').onsubmit = async (e) => {
            e.preventDefault(); const oldId = document.getElementById('editMemberId').value, name = document.getElementById('inputName').value.trim();
            const payload = { id: oldId || name, name: name, guild: document.getElementById('inputGuild').value, role: document.getElementById('inputRole').value, class: document.getElementById('inputClass').value.trim() || '-', isMain: document.getElementById('inputIsMain').checked, mainCharName: document.getElementById('inputMainCharName').value.trim(), joinDate: document.getElementById('inputJoinDate').value };
            if (await sendAction(oldId ? 'update' : 'add', payload, 'btnSubmitMember')) closeModal('memberModal');
        };

        function openDeleteModal(id) { appState.memberToDelete = appState.members.find(x => x.id == id); if(!appState.memberToDelete) return; document.getElementById('deleteTargetName').innerText = appState.memberToDelete.name; document.getElementById('deleteReason').value = ''; setDeleteType('leave'); openModal('deleteModal'); }
        function setDeleteType(t) { appState.deleteType = t; document.getElementById('btnLeave').className = t === 'leave' ? "flex-1 py-3.5 rounded-xl font-bold text-xs bg-gray-800 text-white shadow-sm transition-all" : "flex-1 py-3.5 rounded-xl font-bold text-xs bg-gray-100 text-gray-400 transition-all"; document.getElementById('btnKick').className = t === 'kick' ? "flex-1 py-3.5 rounded-xl font-bold text-xs bg-red-600 text-white shadow-xl shadow-red-100 transition-all" : "flex-1 py-3.5 rounded-xl font-bold text-xs bg-gray-100 text-gray-400 transition-all"; }
        async function confirmDelete() { if(!appState.memberToDelete) return; if (await sendAction('delete', { id: appState.memberToDelete.id, deleteType: appState.deleteType, reason: document.getElementById('deleteReason').value.trim() })) closeModal('deleteModal'); }

        function openBulkModal() { document.getElementById('bulkInput').value = ''; appState.parsedBulkData = []; parseBulkInput(); openModal('bulkModal'); }

        function parseBulkInput() {
            const raw = document.getElementById('bulkInput').value.trim(), tbody = document.getElementById('bulkPreviewBody'), btn = document.getElementById('btnExecuteBulk'), readyCount = document.getElementById('bulkReadyCount');
            if (!raw) { appState.parsedBulkData = []; if(tbody) tbody.innerHTML = '<tr><td colspan="4" class="p-20 text-center text-gray-400 font-bold">ì´ê³³ì— ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.</td></tr>'; if(readyCount) readyCount.innerText = '0'; if(btn) btn.disabled = true; return; }
            const lines = raw.split('\n'), parsed = [], today = new Date().toISOString().split('T')[0];
            lines.forEach(line => {
                let cols = line.split('\t').map(c => c.trim()); if (cols.length < 2 && line.includes(',')) cols = line.split(',').map(c => c.trim());
                if (!cols[0]) return; 
                let guild = appState.filters.guild !== 'all' ? appState.filters.guild : appState.guilds[0].name;
                const match = appState.guilds.find(g => g.name === cols[1]); if (match) guild = match.name;
                const ranks = appState.guildRanks[guild] || initialGuildRanks['ëš ì¹´ë¡±'];
                parsed.push({ id: cols[0], name: cols[0], guild, role: ranks[ranks.length-1], class: cols[2] || '-', isMain: true, mainCharName: '', joinDate: today });
            });
            appState.parsedBulkData = parsed; if(readyCount) readyCount.innerText = parsed.length; if(btn) btn.disabled = (parsed.length === 0);
            if(tbody) {
                tbody.innerHTML = parsed.slice(0, 100).map(d => `<tr class="hover:bg-gray-50 transition-colors font-bold"><td class="px-5 py-4 text-green-500 font-bold text-[10px]">ì •ìƒ ëŒ€ê¸°</td><td class="px-5 py-4 font-bold text-gray-800">${d.name}</td><td class="px-5 py-4 text-gray-500 font-bold text-[10px]">${d.guild}</td><td class="px-5 py-4 text-gray-400 font-medium text-[10px]">${d.class}</td></tr>`).join('');
                if (parsed.length > 100) tbody.innerHTML += `<tr><td colspan="4" class="px-5 py-6 text-center text-gray-400 text-[10px] font-bold">...ì™¸ ${parsed.length - 100}ëª… ìƒëµë¨</td></tr>`;
            }
        }

        async function saveBulkData() {
            if (appState.parsedBulkData.length === 0) return;
            // iframe ë‚´ confirm ì°½ ë§‰í˜ í˜„ìƒ í•´ê²°ì„ ìœ„í•´ alert/confirm ì—†ì´ ì¦‰ì‹œ ì „ì†¡
            if (await sendAction('bulk_add', appState.parsedBulkData, 'btnExecuteBulk')) {
                closeModal('bulkModal');
                document.getElementById('bulkInput').value = '';
                appState.parsedBulkData = [];
                document.getElementById('bulkPreviewBody').innerHTML = '';
            }
        }

        function changeRankGuild(v) { appState.tempSettingsRankGuild = v; router('settings'); }
        function updateRankVal(i, v) { appState.guildRanks[appState.tempSettingsRankGuild][i] = v; localStorage.setItem('macaron_ranks_v19', JSON.stringify(appState.guildRanks)); }
        function addRank() { appState.guildRanks[appState.tempSettingsRankGuild].push("ìƒˆ ì§ìœ„"); localStorage.setItem('macaron_ranks_v19', JSON.stringify(appState.guildRanks)); router('settings'); }
        function removeRank(i) { appState.guildRanks[appState.tempSettingsRankGuild].splice(i, 1); localStorage.setItem('macaron_ranks_v19', JSON.stringify(appState.guildRanks)); router('settings'); }
        
        function executeFactoryReset() { openModal('resetModal'); }
        async function confirmReset() { if(await sendAction('reset', {})) closeModal('resetModal'); }

        function initSidebar() {
            const sb = document.getElementById('sidebar'), ov = document.getElementById('sidebarOverlay'), openBtn = document.getElementById('openSidebar'), closeBtn = document.getElementById('closeSidebar');
            if(openBtn) { openBtn.onclick = () => { sb.classList.remove('-translate-x-full'); ov.classList.remove('hidden'); }; }
            if(closeBtn) { closeBtn.onclick = () => { sb.classList.add('-translate-x-full'); ov.classList.add('hidden'); }; }
            if(ov) { ov.onclick = () => { sb.classList.add('-translate-x-full'); ov.classList.add('hidden'); }; }
            
            // ë³¸ë¬¸ì— ì´ˆê¸°í™” ëª¨ë‹¬ì´ ì—†ìœ¼ë©´ ìƒì„±
            if(!document.getElementById('resetModal')){
                const resetHtml = `<div id="resetModal" class="fixed inset-0 z-[110] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden fade-in font-bold"><div class="bg-white rounded-[3rem] shadow-2xl w-full max-w-md p-12 text-center border border-gray-50"><div class="w-20 h-20 bg-red-50 text-red-500 rounded-[2rem] flex items-center justify-center text-4xl mx-auto mb-6 shadow-inner"><i class="fas fa-radiation"></i></div><h3 class="text-2xl font-black text-gray-800 tracking-tight mb-4">ë°ì´í„° ì „ì²´ ì´ˆê¸°í™”</h3><p class="text-xs text-gray-500 mb-8 leading-relaxed">êµ¬ê¸€ ì‹œíŠ¸ì˜ ëª¨ë“  ë°ì´í„°ì™€ ë¡œê·¸ê°€ ì™„ì „íˆ ì§€ì›Œì§‘ë‹ˆë‹¤.<br>ì •ë§ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p><div class="grid grid-cols-2 gap-4"><button onclick="closeModal('resetModal')" class="py-4 bg-gray-50 rounded-2xl font-bold text-xs text-gray-500 hover:bg-gray-100 transition-all">ì·¨ì†Œ</button><button onclick="confirmReset()" class="py-4 bg-red-600 text-white rounded-2xl font-bold text-xs shadow-xl hover:bg-red-700 transition-all">ì´ˆê¸°í™” ì§„í–‰</button></div></div></div>`;
                document.body.insertAdjacentHTML('beforeend', resetHtml);
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => { initSidebar(); fetchMembers(); });
    </script>
</body>
</html>
