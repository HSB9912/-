<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëš ì¹´ë¡± ê¸¸ë“œ ê´€ë¦¬ ì‹œìŠ¤í…œ (v8.25)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        .chart-container { position: relative; width: 100%; height: 300px; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #fbcfe8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #f472b6; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        th.sortable { cursor: pointer; user-select: none; transition: background 0.2s; position: relative; }
        th.sortable:hover { background-color: #fdf2f8 !important; color: #db2777 !important; }
        .force-hide { display: none !important; }
        #loadingOverlay { position: fixed; inset: 0; background: white; z-index: 10000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .nav-item.active { background-color: #fdf2f8; color: #ec4899; box-shadow: inset 4px 0 0 #ec4899; }
        #msgBox { transition: all 0.3s ease; transform: translateY(100px); opacity: 0; pointer-events: none; }
        #msgBox.show { transform: translateY(0); opacity: 1; }
        .batch-modified { background-color: #fff7ed !important; } 
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.25rem; text-align: center; font-size: 0.75rem; }
        .calendar-day { padding: 0.25rem; border-radius: 0.75rem; position: relative; transition: all 0.2s; min-height: 56px; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; aspect-ratio: 1/1; cursor: pointer; border: 1px solid transparent; }
        .calendar-day:hover { background-color: #f9fafb; border-color: #fbcfe8; }
        .calendar-day.today { background-color: #ec4899; color: white; font-weight: bold; }
        .calendar-day.thursday { color: #db2777; background-color: #fdf2f8; border: 1px solid #fbcfe8; font-weight: bold; }
        .calendar-day.not-current { opacity: 0.2; pointer-events: none; }
        .calendar-head { font-size: 0.7rem; font-weight: 800; color: #9ca3af; text-transform: uppercase; padding-bottom: 8px; }
        .event-dot { width: 4px; height: 4px; background-color: #ec4899; border-radius: 50%; margin-top: 2px; }
        .calendar-day.today .event-dot { background-color: white; }
        
        .event-snippet { 
            font-size: 11px; 
            color: #db2777; 
            opacity: 1; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            width: 100%; 
            margin-top: 3px; 
            line-height: 1.1; 
            font-weight: 800; 
            background-color: rgba(251, 207, 232, 0.3); 
            border-radius: 4px;
            padding: 1px 2px;
        }
        .calendar-day.today .event-snippet { color: white; background-color: rgba(255, 255, 255, 0.2); }

        .score-zero { background-color: #fee2e2 !important; color: #ef4444 !important; }
        .score-cell { transition: background 0.2s; }
        .score-cell:hover { background-color: #f8fafb; }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 h-screen overflow-hidden flex font-medium">

    <div id="loadingOverlay">
        <div class="text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-pink-500 border-opacity-20 border-t-pink-500 mb-8 mx-auto"></div>
            <p class="text-pink-600 font-bold text-xl tracking-tight">ë°ì´í„° ë™ê¸°í™” ì¤‘...</p>
        </div>
    </div>

    <div id="msgBox" class="fixed bottom-10 left-1/2 -translate-x-1/2 z-[200] bg-slate-900 text-white px-8 py-4 rounded-2xl shadow-2xl flex items-center gap-4 border border-white/10">
        <div id="msgIcon" class="text-pink-500"><i class="fas fa-info-circle"></i></div>
        <p id="msgText" class="text-sm font-bold"></p>
    </div>

    <aside id="sidebar" class="fixed lg:static inset-y-0 left-0 z-50 w-64 bg-white border-r border-gray-100 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 flex flex-col shadow-sm">
        <div class="p-6 border-b border-gray-100 flex items-center gap-3">
            <div class="w-10 h-10 rounded-2xl bg-gradient-to-tr from-pink-400 to-rose-400 flex items-center justify-center text-white font-bold shadow-lg shadow-pink-100 text-xl">ëš </div>
            <div><h1 class="text-lg font-bold text-gray-800 tracking-tight">ëš ì¹´ë¡± ê¸¸ë“œ ê´€ë¦¬</h1><p class="text-[9px] text-gray-400 font-bold uppercase tracking-widest leading-none mt-1">v8.25 Stable</p></div>
            <button id="closeSidebar" class="lg:hidden ml-auto text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
        </div>
        <nav class="p-4 space-y-2 flex-1 overflow-y-auto no-scrollbar">
            <button onclick="router('dashboard')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="dashboard"><i class="fas fa-columns w-5 text-center"></i><span>ëŒ€ì‹œë³´ë“œ</span></button>
            <button onclick="router('members')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="members"><i class="fas fa-users w-5 text-center"></i><span>ê¸¸ë“œì› ê´€ë¦¬</span></button>
            <button onclick="router('suro')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="suro"><i class="fas fa-edit w-5 text-center"></i><span>ìˆ˜ë¡œ ì ìˆ˜ ì…ë ¥</span></button>
            <button onclick="router('analysis')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="analysis"><i class="fas fa-chart-line w-5 text-center"></i><span>ìˆ˜ë¡œ ì ìˆ˜ ë¶„ì„</span></button>
            <button onclick="router('bail')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="bail"><i class="fas fa-gem w-5 text-center"></i><span>ë³´ì„ê¸ˆ ê´€ë¦¬</span></button>
            <button onclick="router('penalty')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="penalty"><i class="fas fa-exclamation-triangle w-5 text-center"></i><span>ë²Œì  ê´€ë¦¬</span></button>
            <button onclick="router('sheet')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="sheet"><i class="fas fa-table w-5 text-center"></i><span>ì‹œíŠ¸ ë³´ê¸°</span></button>
            <button onclick="router('history')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="history"><i class="fas fa-history w-5 text-center"></i><span>ìš´ì˜ ì´ë ¥</span></button>
            <button onclick="router('settings')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="settings"><i class="fas fa-cog w-5 text-center"></i><span>ì„¤ì •</span></button>
        </nav>
        <div class="p-4 border-t border-gray-100 bg-gray-50/50 text-center font-bold"><p class="text-[10px] text-green-500 uppercase tracking-widest"><i class="fas fa-cloud mr-1 animate-pulse"></i> Database Connected</p></div>
    </aside>

    <div id="sidebarOverlay" class="fixed inset-0 bg-black/10 z-40 hidden lg:hidden"></div>

    <main class="flex-1 flex flex-col overflow-hidden bg-gray-50">
        <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-8 shrink-0 z-10 shadow-sm">
            <div class="flex items-center gap-4"><button id="openSidebar" class="p-2 lg:hidden rounded-lg hover:bg-gray-100 text-gray-600"><i class="fas fa-bars text-xl"></i></button><h2 id="pageTitle" class="text-xl font-bold text-gray-800 tracking-tight">ëŒ€ì‹œë³´ë“œ</h2></div>
            <div class="flex items-center gap-4">
                <div class="px-4 py-1.5 bg-pink-50 text-pink-600 rounded-full text-[11px] font-bold border border-pink-100 shadow-sm">
                    âœ¨ <span id="anniversaryLabel">ë¡œë”© ì¤‘...</span>
                </div>
                <div class="hidden md:flex px-4 py-1.5 bg-slate-50 text-slate-600 rounded-full text-[11px] font-bold border border-slate-100 shadow-sm gap-2">
                    <span>ğŸ‘¥</span> <span id="totalMembersCount">ë¡œë”© ì¤‘...</span>
                </div>
                <button id="refreshBtn" onclick="fetchMembers()" class="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-gray-100 text-gray-400 transition-all border border-gray-100 shadow-sm"><i class="fas fa-sync-alt"></i></button>
            </div>
        </header>
        <div id="contentArea" class="flex-1 overflow-y-auto p-4 lg:p-10 relative bg-gray-50 flex flex-col min-h-0"></div>
    </main>

    <!-- Modals -->
    <div id="memberModal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/30 backdrop-blur-sm hidden fade-in font-bold"><div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-md overflow-hidden border border-gray-100"><div class="p-6 bg-pink-50 border-b border-pink-100 flex justify-between items-center"><div><h3 id="modalTitle" class="text-lg font-bold text-pink-700 tracking-tight">ë©¤ë²„ ì •ë³´ ì…ë ¥</h3></div><button onclick="closeModal('memberModal')"><i class="fas fa-times text-gray-400 text-lg"></i></button></div><form id="memberForm" class="p-8 space-y-5"><input type="hidden" id="editMemberId"><div class="space-y-1"><label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">ë‹‰ë„¤ì„</label><input type="text" id="inputName" class="w-full border border-gray-100 bg-gray-50 rounded-2xl p-3.5 outline-none focus:ring-4 focus:ring-pink-50 text-sm font-bold shadow-inner" required placeholder="ì •í™•í•œ ìºë¦­í„°ëª…"></div><div class="grid grid-cols-2 gap-4"><div class="space-y-1"><label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">ì†Œì†</label><select id="inputGuild" class="w-full border border-gray-100 bg-gray-50 rounded-2xl p-3.5 text-sm font-bold outline-none" onchange="onGuildSelectChange(this.value)"></select></div><div class="space-y-1"><label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">ì§ìœ„</label><select id="inputRole" class="w-full border border-gray-100 bg-gray-50 rounded-2xl p-3.5 text-sm font-bold outline-none"></select></div></div><div class="space-y-1"><label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">ì§ì—…</label><select id="inputClass" class="w-full border border-gray-100 bg-gray-50 rounded-2xl p-3.5 text-sm font-bold outline-none shadow-inner cursor-pointer"><option value="">ì§ì—…ì„ ì„ íƒí•˜ì„¸ìš”</option></select></div><div class="flex items-center gap-3 py-1"><input type="checkbox" id="inputIsMain" class="w-5 h-5 text-pink-500 rounded focus:ring-pink-50 shadow-sm cursor-pointer" checked onchange="toggleMainCharInput()"><label for="inputIsMain" class="text-[11px] font-bold text-gray-600 uppercase tracking-tight cursor-pointer">ë³¸ìºë¦­í„°ì…ë‹ˆê¹Œ?</label></div><div id="mainCharInputGroup" class="hidden animate-fade-in space-y-1"><label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">ë³¸ìº ë‹‰ë„¤ì„</label><input type="text" id="inputMainCharName" class="w-full border border-gray-100 bg-gray-50 rounded-2xl p-3.5 text-sm font-bold outline-none shadow-inner" placeholder="ë³¸ìºë¦­ëª… ì…ë ¥"></div><button type="submit" id="btnSubmitMember" class="w-full bg-gray-900 text-white py-4 rounded-2xl font-bold uppercase text-[10px] tracking-widest hover:bg-black transition-all shadow-xl mt-2">ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥</button></form></div></div>
    
    <div id="deleteModal" class="fixed inset-0 z-[110] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden fade-in font-bold"><div class="bg-white rounded-[2.5rem] shadow-2xl w-full max-w-sm p-10 text-center border border-gray-50"><div class="w-16 h-16 bg-red-50 text-red-500 rounded-2xl flex items-center justify-center text-2xl mx-auto mb-5 shadow-inner"><i class="fas fa-user-minus"></i></div><p class="text-gray-800 font-bold text-lg mb-6 leading-tight">'<span id="deleteTargetName" class="text-red-500"></span>' ì œê±° í™•ì •</p><div class="space-y-4 text-left mb-8"><div class="flex gap-2"><button onclick="setDeleteType('leave')" id="btnLeave" class="flex-1 py-3 rounded-xl font-bold text-xs bg-gray-800 text-white shadow-sm transition-all">ìì§„íƒˆí‡´</button><button onclick="setDeleteType('kick')" id="btnKick" class="flex-1 py-3 rounded-xl font-bold text-xs bg-gray-100 text-gray-400 transition-all">ì¶”ë°©</button></div><input type="text" id="deleteReason" class="w-full border border-gray-100 bg-gray-50 rounded-xl p-3 text-xs font-bold outline-none shadow-inner" placeholder="ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì´ë ¥ìš©)"></div><div class="grid grid-cols-2 gap-4"><button onclick="closeModal('deleteModal')" class="py-4 bg-gray-50 rounded-2xl font-bold text-xs text-gray-500 hover:bg-gray-100 transition-all">ì·¨ì†Œ</button><button onclick="confirmDelete()" class="py-4 bg-red-500 text-white rounded-2xl font-bold text-xs shadow-xl hover:bg-red-600 transition-all">ì‚­ì œ í™•ì •</button></div></div></div>

    <!-- Event Detail Modal -->
    <div id="eventDetailModal" class="fixed inset-0 z-[120] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden fade-in font-bold">
        <div class="bg-white rounded-[2.5rem] shadow-2xl w-full max-w-sm p-10 border border-gray-50 relative">
            <div class="flex justify-between items-center mb-10">
                <h3 id="eventDetailDate" class="text-2xl font-black text-slate-800 tracking-tighter">2026-02-18</h3>
                <button onclick="closeModal('eventDetailModal')" class="text-gray-400 hover:text-gray-600 text-xl"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="space-y-8">
                <div class="space-y-2">
                    <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">ì¼ì • ì œëª©</label>
                    <input type="text" id="eventTitleInput" class="w-full border border-gray-100 bg-gray-50/50 rounded-2xl p-5 outline-none focus:ring-4 focus:ring-pink-50 text-sm font-bold shadow-inner placeholder:text-gray-300" placeholder="ì˜ˆ: ìˆ˜ë¡œ ì •ì‚°">
                </div>
                
                <div class="space-y-2">
                    <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">ìƒì„¸ ë‚´ìš©</label>
                    <textarea id="eventContentInput" rows="4" class="w-full border border-gray-100 bg-gray-50/50 rounded-2xl p-5 outline-none focus:ring-4 focus:ring-pink-50 text-sm font-bold shadow-inner resize-none placeholder:text-gray-300" placeholder="ìƒì„¸ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mt-12">
                <button onclick="deleteEvent()" class="py-5 bg-rose-50 text-rose-500 rounded-[1.5rem] font-bold text-sm hover:bg-rose-100 transition-all">ì‚­ì œ</button>
                <button onclick="saveEvent()" class="py-5 bg-[#1e232d] text-white rounded-[1.5rem] font-bold text-sm shadow-xl hover:bg-black transition-all">ì¼ì • ì €ì¥</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONSTANTS ---
        const DEFAULT_SHEET_URL = "https://docs.google.com/spreadsheets/d/19V1FFMz9M3gQof6T89nwLSGHEK_OriOint2adLINlY0/edit?gid=1890518105#gid=1890518105";
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyOylLKXCCvWuHOliqYRP6sK_sOIRe9AmnfGg5xwNNMKD8eDf2K-J4oM7FpEbWVypkrrA/exec";
        const GUILD_START_DATE = new Date('2020-03-17');
        const MAPLE_JOBS = ["íˆì–´ë¡œ", "ë‹¤í¬ë‚˜ì´íŠ¸", "íŒ”ë¼ë”˜", "ë¶ˆë…", "ì¬ì½œ", "ë¹„ìˆ", "ë³´ìš°ë§ˆìŠ¤í„°", "ì‹ ê¶", "íŒ¨ìŠ¤íŒŒì¸ë”","ë‚˜ì´íŠ¸ë¡œë“œ", "ì„€ë„ì–´", "ë“€ì–¼ë¸”ë ˆì´ë“œ", "ìº¡í‹´", "ë°”ì´í¼", "ìºë…¼ë§ˆìŠ¤í„°","ë¯¸í•˜ì¼", "ì†Œìš¸ë§ˆìŠ¤í„°", "í”Œë ˆì„ìœ„ìë“œ", "ìœˆë“œë¸Œë ˆì´ì»¤", "ë‚˜ì´íŠ¸ì›Œì»¤", "ìŠ¤íŠ¸ë¼ì´ì»¤","ì•„ë€", "ì—ë°˜", "ë£¨ë¯¸ë„ˆìŠ¤", "ë©”ë¥´ì„¸ë°ìŠ¤", "íŒ¬í…€", "ì€ì›”","ë°ëª¬ ìŠ¬ë ˆì´ì–´", "ë°ëª¬ ì–´ë²¤ì ¸", "ë¸”ë˜ìŠ¤í„°", "ë°°í‹€ë©”ì´ì§€", "ì™€ì¼ë“œí—Œí„°", "ë©”ì¹´ë‹‰", "ì œë…¼","ì¹´ì´ì €", "ì¹´ì¸", "ì¹´ë°ë‚˜", "ì—”ì ¤ë¦­ë²„ìŠ¤í„°","ë¼ë¼", "í˜¸ì˜", "ì•„ë¸", "ì¼ë¦¬ì›€", "ì•„í¬", "ì¹¼ë¦¬","ì œë¡œ", "í‚¤ë„¤ì‹œìŠ¤", "ë Œ"];
        const baseRanks = ['ë§ˆì¹´ë¡±', 'ë‹¤ì¿ ì•„ì¦ˆ'];
        const initialGuildRanks = {
            'ëš ì¹´ë¡±': [...baseRanks, 'í¬ë¼ìš´', 'íŒŒë¥´í˜', 'í‹°ë¼ë¯¸ìŠˆ', 'í¬ë¡œì¹¸ìŠˆ', 'ë¡¤ì¼€ì´í¬', 'íŒ¬ì¼€ì´í¬', 'ì™€í”Œ'],
            'ëš±ì¹´ë¡±': [...baseRanks, 'ëš ì¼€ì´í¬', 'ëš ë¸Œë ˆë“œ', 'ìˆ˜í”Œë ˆ', 'ëš ìŠ¤ì½˜', 'ë°˜ì£½', 'ë°˜ì£½(íœ´ë©´)', 'ì•„ì¸ìŠˆíŒ¨ë„ˆ'],
            'ë°¤ì¹´ë¡±': [...baseRanks, 'ë¶€íŒ¬ì¼€ì´í¬', 'ë¶€ì¼€ì´í¬', 'ì•„ì¸ìŠˆíŒ¨ë„ˆ', 'ë°˜ì£½', 'ë°˜ì£½(íœ´ë©´)'],
            'ë³„ì¹´ë¡±': [...baseRanks, 'ë¶€íŒ¬ì¼€ì´í¬', 'ë¶€ì¼€ì´í¬', 'ì•„ì¸ìŠˆíŒ¨ë„ˆ', 'ë°˜ì£½', 'ë°˜ì£½(íœ´ë©´)'],
            'ë‹¬ì¹´ë¡±': [...baseRanks, 'ë¶€íŒ¬ì¼€ì´í¬', 'ë¶€ì¼€ì´í¬', 'ì•„ì¸ìŠˆíŒ¨ë„ˆ', 'ë°˜ì£½', 'ë°˜ì£½(íœ´ë©´)'],
            'ê¿€ì¹´ë¡±': [...baseRanks, 'ë¶€íŒ¬ì¼€ì´í¬', 'ë¶€ì¼€ì´í¬', 'ì•„ì¸ìŠˆíŒ¨ë„ˆ', 'ë°˜ì£½', 'ë°˜ì£½(íœ´ë©´)']
        };

        // --- GLOBAL STATE ---
        let jobChartInstance = null;
        let analysisChartInstance = null;

        const appState = {
            activeTab: 'dashboard',
            guilds: [
                { id: 'ddun', name: 'ëš ì¹´ë¡±', type: 'ë©”ì¸ 1ê¸°', color: '#f472b6', icon: 'fa-crown', max: 200 },
                { id: 'ddung', name: 'ëš±ì¹´ë¡±', type: 'ë©”ì¸ 2ê¸°', color: '#fb7185', icon: 'fa-heart', max: 200 },
                { id: 'bam', name: 'ë°¤ì¹´ë¡±', type: 'ë¶€ìº 1ê¸°', color: '#6366f1', icon: 'fa-moon', max: 200 },
                { id: 'byeol', name: 'ë³„ì¹´ë¡±', type: 'ë¶€ìº 2ê¸°', color: '#facc15', icon: 'fa-star', max: 200 },
                { id: 'dal', name: 'ë‹¬ì¹´ë¡±', type: 'ë¶€ìº 3ê¸°', color: '#60a5fa', icon: 'fa-sun', max: 200 },
                { id: 'kkul', name: 'ê¿€ì¹´ë¡±', type: 'ë¶€ìº 4ê¸°', color: '#fbbf24', icon: 'fa-cube', max: 200 },
            ],
            members: [], history: [], bailHistory: [], suroHeaders: [],
            events: [],
            penaltyHistory: [],
            filters: { guild: 'all', search: '', sortField: 'name', sortOrder: 'asc' },
            suroFilters: { guild: 'all', search: '', sortField: 'name', sortOrder: 'asc' },
            analysisFilters: { sortField: 'avg', sortOrder: 'desc' },
            analysisGuild: 'ëš ì¹´ë¡±',
            isBatchMode: false, pendingUpdates: {},
            calendarView: { year: new Date().getFullYear(), month: new Date().getMonth() },
            scriptUrl: APPS_SCRIPT_URL,
            sheetUrl: DEFAULT_SHEET_URL,
            guildRanks: initialGuildRanks,
            currentSuroInputs: {},
            currentSelectedDate: null
        };

        // --- HELPER FUNCTIONS ---
        window.showMsg = (text, type = 'info') => {
            const box = document.getElementById('msgBox'); if(!box) return;
            document.getElementById('msgText').innerText = text;
            box.classList.add('show'); setTimeout(() => box.classList.remove('show'), 3500);
        };
        window.showLoading = (show) => { document.getElementById('loadingOverlay')?.classList.toggle('force-hide', !show); };
        
        window.getAnniversaryInfo = () => {
            const now = new Date(); const diff = now - GUILD_START_DATE;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const years = Math.floor(days / 365);
            const remainingDays = days % 365;
            return { totalDays: days, years, remainingDays };
        };
        
        window.updateAnniversaryLabel = () => {
            const anniv = window.getAnniversaryInfo();
            const el = document.getElementById('anniversaryLabel');
            if (el) el.innerText = `ëš ì¹´ë¡±ì´ ìƒì„±ëœ ì§€ ${anniv.totalDays}ì¼ (${anniv.years}ë…„ ${anniv.remainingDays}ì¼)`;
        };

        window.calculateTotalSuro = (guildName) => {
            if (!appState.suroHeaders || appState.suroHeaders.length === 0) return 0;
            const lastHeader = appState.suroHeaders[appState.suroHeaders.length - 1];
            return appState.members.filter(m => m.guild === guildName).reduce((s, m) => s + (Number(m.suro?.[lastHeader]) || 0), 0);
        };

        window.getAdminBailStats = () => {
            const stats = {};
            appState.bailHistory.forEach(h => { const amount = parseInt(h.amount) || 0; stats[h.receiver] = (stats[h.receiver] || 0) + amount; });
            return Object.entries(stats).sort((a,b) => a[0].localeCompare(b[0], 'ko'));
        };

        function smartCompare(a, b, field, order) {
            let valA = a[field]; let valB = b[field];
            if (field === 'mainInfo') {
                valA = a.isMain ? a.name : (a.mainCharName || "");
                valB = b.isMain ? b.name : (b.mainCharName || "");
            }
            if (valA === valB) return 0;
            const numA = parseFloat(valA); const numB = parseFloat(valB);
            if (!isNaN(numA) && !isNaN(numB)) { return order === 'asc' ? numA - numB : numB - numA; }
            const strA = String(valA || ""); const strB = String(valB || "");
            const res = strA < strB ? -1 : 1;
            return order === 'asc' ? res : -res;
        }

        window.getNicknameIcon = (role) => {
            if (role === 'ë§ˆì¹´ë¡±') return '<i class="fas fa-crown text-blue-500 mr-2 shadow-sm"></i>';
            if (role === 'ë‹¤ì¿ ì•„ì¦ˆ') return '<i class="fas fa-crown text-pink-500 mr-2 shadow-sm"></i>';
            return '<span class="w-3 h-3 rounded-full bg-gray-200 mr-2 inline-block"></span>';
        };

        function formatRankWithSuffix(rank) {
            if (!rank) return '-';
            const special = ['í¬ë¼ìš´', 'íŒŒë¥´í˜', 'í‹°ë¼ë¯¸ìŠˆ', 'í¬ë¡œì¹¸ìŠˆ'];
            if (special.includes(rank)) return `${rank} <span class="text-[8.5px] text-blue-500 font-bold tracking-tighter">(ì•„ì¸ìŠˆíŒ¨ë„ˆ)</span>`;
            return rank;
        }

        window.getSuroPeriodHeader = (dateObj) => { 
            const now = dateObj || new Date(); const day = now.getDay(); let diff = day - 4; if (diff < 0) diff += 7; 
            const startDate = new Date(now); startDate.setDate(now.getDate() - diff - 7); 
            const endDate = new Date(startDate); endDate.setDate(startDate.getDate() + 6); 
            const f = (d) => { 
                const yy = d.getFullYear().toString().slice(-2);
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                const dd = String(d.getDate()).padStart(2, '0');
                return `${yy}-${mm}-${dd}`;
            };
            return `${f(startDate)}(ëª©) ~ ${f(endDate)}(ìˆ˜) ìˆ˜ë¡œ ì ìˆ˜`; 
        };

        // --- BATCH MODE FUNCTIONS ---
        window.toggleBatchMode = () => { 
            appState.isBatchMode = !appState.isBatchMode; 
            appState.pendingUpdates = {}; 
            window.renderMembers(document.getElementById('contentArea')); 
        };

        window.stageUpdate = (id, field, val) => { 
            if(!appState.pendingUpdates[id]) appState.pendingUpdates[id] = { id }; 
            appState.pendingUpdates[id][field] = val; 
            window.updateMemberTable(); 
        };

        window.saveBatchUpdates = async () => { 
            const updates = Object.values(appState.pendingUpdates); 
            if(updates.length === 0) return window.showMsg("ìˆ˜ì •ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.", "error"); 
            
            if(confirm(`${updates.length}ëª…ì˜ ì •ë³´ë¥¼ ì—…ë°ì´íŠ¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì‹œê°„ì´ ì¡°ê¸ˆ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤)`)) { 
                window.showLoading(true); 
                
                let successCount = 0;
                const total = updates.length;

                for (const update of updates) {
                    const original = appState.members.find(m => String(m.id) === String(update.id));
                    if (!original) continue;

                    const payload = {
                        id: original.id,
                        name: original.name,
                        guild: update.guild !== undefined ? update.guild : original.guild,
                        role: update.role !== undefined ? update.role : original.role,
                        class: update.class !== undefined ? update.class : original.class,
                        isMain: original.isMain,
                        mainCharName: original.mainCharName || '',
                        joinDate: original.joinDate || ''
                    };

                    try {
                        const response = await fetch(appState.scriptUrl, { 
                            method: 'POST', 
                            headers: { 'Content-Type': 'text/plain;charset=utf-8' }, 
                            body: JSON.stringify({ action: 'update', data: payload }), 
                            redirect: 'follow' 
                        });
                        const res = await response.json();
                        if (res.status === "success") successCount++;
                    } catch (e) {
                        console.error("Update failed for", original.name, e);
                    }
                }

                window.showLoading(false);
                
                if (successCount === total) {
                    window.showMsg("ëª¨ë“  ë³€ê²½ì‚¬í•­ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
                    appState.isBatchMode = false; 
                    appState.pendingUpdates = {};
                    await window.fetchMembers();
                } else {
                    window.showMsg(`${successCount}/${total}ê±´ ì €ì¥ ì™„ë£Œ. ì¼ë¶€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.`, "warning");
                    await window.fetchMembers();
                }
            } 
        };

        // --- CORE API ---
        window.fetchMembers = async () => {
            window.showLoading(true);
            try {
                // Add timestamp to prevent caching in browser (Chrome/GitHub Pages issue)
                const targetUrl = appState.scriptUrl + "?t=" + new Date().getTime();
                const response = await fetch(targetUrl, { 
                    method: 'GET', 
                    mode: 'cors', 
                    cache: 'no-cache',
                    redirect: 'follow'
                });
                const json = await response.json();
                if (json.status === "success") {
                    // Force ID to be String to ensure batch update lookups work consistently
                    appState.members = (json.data.members || []).map(m => ({...m, id: String(m.id)})).filter(m => m.name && m.name.trim() !== "");
                    appState.history = json.data.history || [];
                    appState.suroHeaders = json.data.suroHeaders || [];
                    appState.bailHistory = json.data.bailHistory || [];
                    appState.events = json.data.events || [];
                    appState.penaltyHistory = json.data.penaltyHistory || [];
                    
                    const countEl = document.getElementById('totalMembersCount');
                    if (countEl) {
                        const counts = {};
                        appState.guilds.forEach(g => counts[g.name] = 0);
                        appState.members.forEach(m => {
                            if (counts[m.guild] !== undefined) counts[m.guild]++;
                        });
                        
                        const aliases = { 'ëš ì¹´ë¡±': 'ëš ', 'ëš±ì¹´ë¡±': 'ëš±', 'ë°¤ì¹´ë¡±': 'ë°¤', 'ë³„ì¹´ë¡±': 'ë³„', 'ë‹¬ì¹´ë¡±': 'ë‹¬', 'ê¿€ì¹´ë¡±': 'ê¿€' };
                        const text = appState.guilds.map(g => {
                            const name = aliases[g.name] || g.name.substring(0, 1);
                            return `${name}:${counts[g.name]}`;
                        }).join(' ');
                        
                        countEl.innerText = text;
                    }
                    
                    window.updateAnniversaryLabel();
                    window.router(appState.activeTab);
                } else {
                    window.showMsg("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.", "error");
                }
            } catch (e) { 
                console.error("Fetch Error:", e); 
                window.showMsg("ë°ì´í„° ì—°ë™ ì‹¤íŒ¨. ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.", "error"); 
            }
            window.showLoading(false);
        };

        window.sendAction = async (action, data) => {
            window.showMsg("ë°ì´í„° ì²˜ë¦¬ ì¤‘...", "info");
            try {
                const targetUrl = appState.scriptUrl;
                const response = await fetch(targetUrl, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }, 
                    body: JSON.stringify({ action, data }), 
                    redirect: 'follow' 
                });
                const res = await response.json();
                if (res.status === "success") { 
                    window.showMsg("ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.", "success"); 
                    await window.fetchMembers(); 
                    return true; 
                }
                else { window.showMsg(res.message || "ì˜¤ë¥˜ ë°œìƒ", "error"); return false; }
            } catch (e) { 
                console.error("Post Error:", e); 
                window.showMsg("ì„œë²„ ì „ì†¡ ì‹¤íŒ¨", "error"); 
                return false; 
            }
        };

        // --- ROUTER ---
        window.router = (tab) => {
            appState.activeTab = tab;
            const content = document.getElementById('contentArea'); if(!content) return;
            content.innerHTML = '';
            document.querySelectorAll('.nav-item').forEach(el => el.classList.toggle('active', el.dataset.target === tab));
            const titles = { dashboard: 'ê¸¸ë“œ í˜„í™©íŒ', members: 'ê¸¸ë“œì› ê´€ë¦¬', suro: 'ìˆ˜ë¡œ ì ìˆ˜ ì…ë ¥', analysis: 'ìˆ˜ë¡œ ë¶„ì„', bail: 'ë³´ì„ê¸ˆ ê´€ë¦¬', penalty: 'ë²Œì  ê´€ë¦¬ ì‹œìŠ¤í…œ', sheet: 'ì‹œíŠ¸ ë³´ê¸°', history: 'ìš´ì˜ ì´ë ¥', settings: 'ì„¤ì •' };
            document.getElementById('pageTitle').innerText = titles[tab] || '';
            if (tab === 'dashboard') window.renderDashboard(content);
            else if (tab === 'members') window.renderMembers(content);
            else if (tab === 'suro') window.renderSuro(content);
            else if (tab === 'analysis') window.renderAnalysis(content, appState.analysisGuild);
            else if (tab === 'bail') window.renderBail(content);
            else if (tab === 'penalty') window.renderPenalty(content);
            else if (tab === 'sheet') window.renderSheet(content);
            else if (tab === 'history') window.renderHistory(content);
            else if (tab === 'settings') window.renderSettings(content);
        };

        // --- DASHBOARD ---
        window.renderDashboard = (container) => {
            const anniv = window.getAnniversaryInfo(); const ddunT = window.calculateTotalSuro('ëš ì¹´ë¡±'); const ddungT = window.calculateTotalSuro('ëš±ì¹´ë¡±');
            const adminBailStats = window.getAdminBailStats();
            const adminBailHtml = adminBailStats.map(([name, count]) => `<div class="flex justify-between items-center py-2 border-b border-gray-50 last:border-0"><span class="text-[11px] font-bold text-gray-600">${name}</span><span class="text-[11px] font-black text-pink-500">${count}ê°œ</span></div>`).join('') || '<p class="text-[10px] text-gray-300 italic text-center py-4">ë³´ì„ê¸ˆ ë‚´ì—­ ì—†ìŒ</p>';
            
            container.innerHTML = `
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-8 mb-8 fade-in shrink-0">
                <div class="flex flex-col gap-6">
                    <div class="flex gap-6 h-40">
                        <div onclick="router('analysis'); renderAnalysis(document.getElementById('contentArea'), 'ëš ì¹´ë¡±')" class="flex-1 bg-gradient-to-br from-pink-500 to-rose-500 rounded-[2.5rem] p-8 shadow-lg text-white cursor-pointer hover:scale-[1.02] transition-transform relative overflow-hidden flex flex-col justify-center border-none">
                            <div class="absolute top-0 right-0 p-4 opacity-20 text-5xl"><i class="fas fa-crown"></i></div>
                            <h3 class="text-sm font-bold opacity-80 uppercase tracking-widest text-center">ëš ì¹´ë¡± ìˆ˜ë¡œ ì´ì </h3>
                            <p class="text-3xl font-black tracking-tighter text-center">${ddunT.toLocaleString()}</p>
                        </div>
                        <div onclick="router('analysis'); renderAnalysis(document.getElementById('contentArea'), 'ëš±ì¹´ë¡±')" class="flex-1 bg-white border border-gray-100 rounded-[2.5rem] p-8 shadow-sm text-gray-800 cursor-pointer hover:border-pink-200 transition-all flex flex-col justify-center">
                            <h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest text-center">ëš±ì¹´ë¡± ìˆ˜ë¡œ ì´ì </h3>
                            <p class="text-3xl font-black tracking-tighter text-pink-500 text-center">${ddungT.toLocaleString()}</p>
                        </div>
                    </div>
                    <div class="bg-white p-8 rounded-[2.5rem] border border-gray-100 min-h-[340px] shadow-sm flex flex-col">
                        <div class="flex justify-between items-center mb-6">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">ğŸ“…</span>
                                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest">Guild Calendar</h3>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="flex items-center gap-2 bg-gray-50 px-3 py-1.5 rounded-2xl border border-gray-100">
                                    <button onclick="moveMonth(-1)" class="w-6 h-6 flex items-center justify-center rounded-lg hover:bg-white hover:text-pink-500 transition-all text-gray-400"><i class="fas fa-chevron-left text-[10px]"></i></button>
                                    <span class="text-[11px] font-bold text-gray-600 w-16 text-center">${appState.calendarView.year}.${String(appState.calendarView.month + 1).padStart(2, '0')}</span>
                                    <button onclick="moveMonth(1)" class="w-6 h-6 flex items-center justify-center rounded-lg hover:bg-white hover:text-pink-500 transition-all text-gray-400"><i class="fas fa-chevron-right text-[10px]"></i></button>
                                </div>
                            </div>
                        </div>
                        ${window.renderCalendar()}
                    </div>
                </div>
                <div class="flex flex-col gap-8 h-full">
                    <div class="bg-white p-10 rounded-[3rem] shadow-sm border border-gray-100 flex flex-col h-[300px] overflow-hidden shrink-0">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest">ì§ì—… ë¶„í¬ë„</h3>
                            <select onchange="window.updateJobChart(this.value)" class="bg-gray-50 rounded-xl px-3 py-1.5 text-xs font-bold outline-none cursor-pointer hover:bg-gray-100">
                                <option value="all">ì „ì²´</option>${appState.guilds.map(g => `<option value="${g.name}">${g.name}</option>`).join('')}
                            </select>
                        </div>
                        <div class="flex-1 overflow-y-auto no-scrollbar">
                            <div style="min-height: 250px;"><canvas id="jobChart"></canvas></div>
                        </div>
                    </div>
                    <div class="bg-white p-10 rounded-[3rem] shadow-sm border border-gray-100 flex flex-col flex-1 min-h-[200px] overflow-hidden">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest">ê°„ë¶€ì§„ ë³´ì„ê¸ˆ í˜„í™©</h3>
                            <i class="fas fa-gem text-pink-300"></i>
                        </div>
                        <div class="flex-1 overflow-y-auto no-scrollbar pr-2">${adminBailHtml}</div>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 fade-in shrink-0">
                ${appState.guilds.map(g => { 
                    const count = appState.members.filter(m => m.guild === g.name).length; 
                    const pct = Math.min((count / g.max) * 100, 100); 
                    return `<div class="bg-white p-8 rounded-[2.5rem] border border-gray-100 shadow-sm hover:shadow-xl transition-all cursor-pointer group" onclick="filterByGuild('${g.name}')"><div class="flex justify-between items-start mb-6"><div class="flex items-center gap-3"><div class="w-10 h-10 bg-gray-50 rounded-2xl flex items-center justify-center text-gray-400 group-hover:bg-pink-50 group-hover:text-pink-500 transition-colors"><i class="fas ${g.icon}"></i></div><div><span class="block font-bold text-lg text-gray-800 group-hover:text-pink-500">${g.name}</span><span class="text-[10px] text-gray-400 font-bold">${g.type}</span></div></div></div><div class="w-full bg-gray-50 rounded-full h-1.5 overflow-hidden"><div class="h-full bg-pink-500 transition-all duration-1000" style="width:${pct}%"></div></div><p class="text-[10px] text-gray-400 font-bold mt-2 text-right">${count} / ${g.max}</p></div>`; 
                }).join('')}
            </div>`;
            setTimeout(() => window.updateJobChart('all'), 0);
        };

        // --- CALENDAR LOGIC ---
        window.moveMonth = (delta) => {
            let newMonth = appState.calendarView.month + delta;
            let newYear = appState.calendarView.year;
            if (newMonth < 0) { newMonth = 11; newYear--; }
            else if (newMonth > 11) { newMonth = 0; newYear++; }
            appState.calendarView.month = newMonth;
            appState.calendarView.year = newYear;
            window.router('dashboard');
        };

        window.renderCalendar = () => { 
            const year = appState.calendarView.year, month = appState.calendarView.month; 
            const first = new Date(year, month, 1).getDay();
            const last = new Date(year, month + 1, 0).getDate(); 
            const prevLast = new Date(year, month, 0).getDate();
            const today = new Date();
            
            let html = `<div class="calendar-grid"><div class="calendar-head text-red-400">ì¼</div><div class="calendar-head">ì›”</div><div class="calendar-head">í™”</div><div class="calendar-head">ìˆ˜</div><div class="calendar-head text-pink-500">ëª©</div><div class="calendar-head">ê¸ˆ</div><div class="calendar-head text-blue-400">í† </div>`; 
            
            for(let i=first; i>0; i--) {
                html += `<div class="calendar-day not-current"><span>${prevLast - i + 1}</span></div>`;
            }

            for(let d=1; d<=last; d++) { 
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                // ë‚ ì§œ ë¹„êµ ë¡œì§ ê°•í™”: ê³µë°± ì œê±° ë° ë¶€ë¶„ ì¼ì¹˜ í™•ì¸ (ì‹œê°„ëŒ€ ë¬¸ì œ ë°©ì§€)
                const dayEvent = appState.events.find(e => {
                    const eDate = (e.date || '').trim();
                    return eDate === dateStr || eDate.startsWith(dateStr);
                });
                const isToday = today.getFullYear()===year && today.getMonth()===month && today.getDate()===d;
                const isThursday = new Date(year, month, d).getDay() === 4;

                let cls = "calendar-day text-gray-600";
                if(isThursday) cls += " thursday";
                if(isToday) cls += " today";
                
                let eventHtml = '';
                if(dayEvent) {
                    eventHtml += `<div class="event-dot"></div>`;
                    eventHtml += `<div class="event-snippet" title="${dayEvent.title}">${dayEvent.title}</div>`;
                }
                html += `<div class="${cls}" onclick="window.showEventDetail('${dateStr}')"><span>${d}</span>${eventHtml}</div>`; 
            } 
            
            const totalCells = first + last;
            const extraCells = (7 - (totalCells % 7)) % 7;
            for(let i=1; i<=extraCells; i++) {
                html += `<div class="calendar-day not-current"><span>${i}</span></div>`;
            }

            return html + `</div>`; 
        };

        window.showEventDetail = (dateStr) => {
            appState.currentSelectedDate = dateStr;
            const modal = document.getElementById('eventDetailModal');
            const dateDisplay = document.getElementById('eventDetailDate');
            const titleInput = document.getElementById('eventTitleInput');
            const contentInput = document.getElementById('eventContentInput');
            
            // ë‚ ì§œ ë¹„êµ ë¡œì§ ê°•í™”
            const existing = appState.events.find(e => {
                const eDate = (e.date || '').trim();
                return eDate === dateStr || eDate.startsWith(dateStr);
            });
            
            dateDisplay.innerText = dateStr;
            titleInput.value = existing ? existing.title : "";
            contentInput.value = existing ? existing.content : "";
            modal.classList.remove('hidden');
        };
        
        window.saveEvent = async () => {
            const title = document.getElementById('eventTitleInput').value.trim();
            const content = document.getElementById('eventContentInput').value.trim();
            const date = appState.currentSelectedDate;
            if (!title) { window.showMsg("ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", "error"); return; }
            const success = await window.sendAction('save_event', { date, title, content });
            if (success) window.closeModal('eventDetailModal');
        };
        
        window.deleteEvent = async () => {
            if (!confirm("ì´ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            const date = appState.currentSelectedDate;
            const success = await window.sendAction('delete_event', { date });
            if (success) window.closeModal('eventDetailModal');
        };

        // --- ANALYSIS ---
        window.renderAnalysis = (container, gName) => {
            appState.analysisGuild = gName;
            const targets = appState.members.filter(m => m.guild === gName);
            const recentHeaders = appState.suroHeaders.slice(-5);
            const currentHeader = recentHeaders[recentHeaders.length - 1];
            const total = window.calculateTotalSuro(gName);

            const zeroPointMembers = targets.filter(m => (Number(m.suro?.[currentHeader]) || 0) === 0);
            const processedList = targets.map(m => {
                const scores = recentHeaders.map(h => Number(m.suro?.[h]) || 0);
                const avg = scores.length > 0 ? (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(1) : 0;
                return { ...m, avg: Number(avg), recentScores: scores };
            });

            processedList.sort((a, b) => {
                const f = appState.analysisFilters.sortField;
                const o = appState.analysisFilters.sortOrder;
                if (f === 'avg') return o === 'asc' ? a.avg - b.avg : b.avg - a.avg;
                if (f === 'score') {
                    const vA = Number(a.suro?.[currentHeader]) || 0;
                    const vB = Number(b.suro?.[currentHeader]) || 0;
                    return o === 'asc' ? vA - vB : vB - vA;
                }
                return smartCompare(a, b, f, o);
            });

            const sortIcon = (f) => appState.analysisFilters.sortField === f ? (appState.analysisFilters.sortOrder === 'asc' ? ' <i class="fas fa-sort-up"></i>' : ' <i class="fas fa-sort-down"></i>') : '';

            container.innerHTML = `
            <div class="flex flex-col gap-6 fade-in h-full overflow-hidden">
                <div class="flex gap-2 overflow-x-auto no-scrollbar shrink-0">
                    ${appState.guilds.map(g => `<button onclick="window.renderAnalysis(document.getElementById('contentArea'), '${g.name}')" class="px-6 py-2.5 rounded-xl text-xs font-bold transition-all ${g.name === gName ? 'bg-pink-500 text-white shadow-lg' : 'bg-white text-gray-500 border border-gray-100'}">${g.name}</button>`).join('')}
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 shrink-0 font-bold">
                    <div class="bg-white p-6 rounded-[2rem] border border-gray-100 shadow-sm flex flex-col justify-center items-center">
                        <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest mb-1">ì „ì²´ ì´ì </p>
                        <h4 class="text-3xl font-black text-gray-800 tracking-tighter">${total.toLocaleString()}</h4>
                    </div>
                    <div class="bg-red-50 p-6 rounded-[2rem] border border-red-100 shadow-sm flex flex-col justify-center items-center">
                        <p class="text-[10px] text-red-500 font-bold uppercase tracking-widest mb-1">ğŸš¨ ì¤‘ìš” ì•Œë¦¼ (ë¯¸ì°¸ì—¬)</p>
                        <h4 class="text-3xl font-black text-red-600 tracking-tighter">${zeroPointMembers.length}ëª…</h4>
                    </div>
                    <div class="bg-white p-6 rounded-[2rem] border border-gray-100 shadow-sm flex flex-col justify-center items-center">
                        <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest mb-1">ìµœê·¼ ë°ì´í„° ì£¼ì°¨</p>
                        <h4 class="text-sm font-bold text-gray-700">${currentHeader ? currentHeader.split(' ')[0] : 'ë°ì´í„° ì—†ìŒ'}</h4>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 flex-1 min-h-0">
                    <div class="lg:col-span-1 bg-white p-8 rounded-[2.5rem] border border-gray-100 shadow-sm flex flex-col overflow-hidden">
                        <h3 class="text-xs font-bold text-gray-400 mb-6 uppercase tracking-widest">ì£¼ê°„ ì´ì  ì¶”ì´</h3>
                        <div class="flex-1 min-h-[200px]">
                            <canvas id="analysisChart"></canvas>
                        </div>
                    </div>

                    <div class="lg:col-span-2 bg-white rounded-[2.5rem] border border-gray-100 shadow-sm overflow-hidden flex flex-col">
                        <div class="p-6 border-b border-gray-50 flex justify-between items-center shrink-0">
                            <h3 class="text-sm font-bold text-gray-800 uppercase tracking-widest">ì¸í„°ë™í‹°ë¸Œ ë°ì´í„° í…Œì´ë¸”</h3>
                        </div>
                        <div class="flex-1 overflow-auto no-scrollbar">
                            <table class="w-full text-left text-xs whitespace-nowrap">
                                <thead class="bg-gray-50 font-bold text-[10px] text-gray-500 uppercase sticky top-0 z-10 border-b border-gray-100">
                                    <tr>
                                        <th class="p-4 w-12 text-center">RANK</th>
                                        <th class="p-4 sortable" onclick="window.setAnalysisSort('name')">ìºë¦­í„°ëª…${sortIcon('name')}</th>
                                        <th class="p-4 text-center sortable bg-pink-50/50" onclick="window.setAnalysisSort('avg')">í‰ê· ${sortIcon('avg')}</th>
                                        ${recentHeaders.map(h => `<th class="p-4 text-right font-medium">${h.split('~')[0].trim()}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-50 font-bold">
                                    ${processedList.map((m, i) => {
                                        return `
                                        <tr class="hover:bg-gray-50 transition-colors h-12">
                                            <td class="p-4 text-center text-gray-300">${i + 1}</td>
                                            <td class="p-4 text-gray-800 flex items-center leading-none">
                                                ${window.getNicknameIcon(m.role)}${m.name}
                                            </td>
                                            <td class="p-4 text-center text-pink-500 bg-pink-50/20">${m.avg.toLocaleString()}</td>
                                            ${m.recentScores.map(s => `
                                                <td class="p-4 text-right font-mono score-cell ${s === 0 ? 'score-zero' : 'text-gray-400'}">
                                                    ${s > 0 ? s.toLocaleString() : '0'}
                                                </td>
                                            `).join('')}
                                        </tr>`;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>`;

            const ctx = document.getElementById('analysisChart');
            if(!ctx) return;
            if(analysisChartInstance) analysisChartInstance.destroy();
            analysisChartInstance = new Chart(ctx, { 
                type: 'line', 
                data: { 
                    labels: recentHeaders.map(h => {
                        const parts = h ? h.split('-') : [];
                        if(parts.length >= 3) return parts[1] + '-' + parts[2].substring(0,2);
                        return h;
                    }), 
                    datasets: [{ 
                        label: 'ê¸¸ë“œ ì´ì ', 
                        data: recentHeaders.map(h => appState.members.filter(m => m.guild === gName).reduce((s, m) => s + (Number(m.suro?.[h]) || 0), 0)), 
                        borderColor: '#ec4899', 
                        borderWidth: 3, 
                        pointRadius: 4, 
                        pointBackgroundColor: '#fff', 
                        tension: 0.4, 
                        fill: true, 
                        backgroundColor: 'rgba(236, 72, 153, 0.05)' 
                    }] 
                }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { legend: { display: false } }, 
                    scales: { 
                        y: { display: false }, 
                        x: { grid: { display: false }, ticks: { font: { size: 10, weight: 'bold' } } } 
                    } 
                } 
            });
        };
        
        window.setAnalysisSort = (f) => { 
            if(appState.analysisFilters.sortField === f) appState.analysisFilters.sortOrder = appState.analysisFilters.sortOrder === 'asc' ? 'desc' : 'asc'; 
            else { appState.analysisFilters.sortField = f; appState.analysisFilters.sortOrder = (f==='score'||f==='rank'||f==='avg') ? 'desc' : 'asc'; } 
            window.renderAnalysis(document.getElementById('contentArea'), appState.analysisGuild); 
        };

        window.updateJobChart = (target) => {
            const ctx = document.getElementById('jobChart'); if(!ctx) return;
            const targets = target === 'all' ? appState.members : appState.members.filter(m => m.guild === target);
            const counts = {}; targets.forEach(m => { const j = m.class || 'ë¯¸ì„¤ì •'; counts[j] = (counts[j] || 0) + 1; });
            const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]);
            if(jobChartInstance) jobChartInstance.destroy();
            jobChartInstance = new Chart(ctx, { type: 'bar', data: { labels: sorted.map(j => j[0]), datasets: [{ label: 'ì¸ì›', data: sorted.map(j => j[1]), backgroundColor: '#f472b6', borderRadius: 4, barThickness: 12 }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, ticks: { precision: 0 } } } } });
        };

        // --- MEMBERS MANAGEMENT ---
        window.renderMembers = (container) => {
            container.innerHTML = `<div class="flex flex-col gap-8 fade-in h-full"><div class="bg-white p-10 rounded-t-[3rem] border border-gray-100 space-y-8 shadow-sm"><div class="flex flex-col md:flex-row justify-between items-center gap-6"><div class="flex overflow-x-auto pb-2 no-scrollbar w-full md:w-auto gap-3"><button onclick="window.filterByGuild('all')" class="shrink-0 px-8 py-3 rounded-2xl text-xs font-bold transition-all ${appState.filters.guild === 'all' ? 'bg-gray-800 text-white shadow-xl' : 'bg-gray-50 text-gray-500 hover:bg-gray-100'}">ì „ì²´ ë³´ê¸°</button>${appState.guilds.map(g => `<button onclick="window.filterByGuild('${g.name}')" class="shrink-0 px-8 py-3 rounded-2xl text-xs font-bold transition-all ${appState.filters.guild === g.name ? 'bg-pink-500 text-white shadow-xl' : 'bg-gray-50 text-gray-500 hover:bg-gray-100'}">${g.name}</button>`).join('')}</div><div class="flex gap-4 items-center"><button onclick="window.toggleBatchMode()" class="px-6 py-3 rounded-2xl text-xs font-bold transition-all ${appState.isBatchMode ? 'bg-gray-800 text-white shadow-xl' : 'bg-pink-50 text-pink-500 hover:bg-pink-100'}"><i class="fas fa-edit mr-1"></i> ì¼ê´„ ìˆ˜ì • ${appState.isBatchMode?'OFF':'ON'}</button>${appState.isBatchMode ? `<button onclick="window.saveBatchUpdates()" class="px-6 py-3 bg-pink-500 text-white rounded-2xl text-xs font-bold shadow-xl animate-pulse">ë³€ê²½ì‚¬í•­ ì €ì¥</button>` : ''}<button onclick="window.openAddModal()" class="w-10 h-10 flex items-center justify-center rounded-2xl bg-pink-50 text-pink-500 hover:bg-pink-100 shadow-sm"><i class="fas fa-plus"></i></button></div></div><div class="relative"><i class="fas fa-search absolute left-6 top-1/2 -translate-y-1/2 text-gray-400"></i><input type="text" oninput="window.handleSearch(this.value)" value="${appState.filters.search}" class="w-full pl-16 pr-8 py-4 bg-gray-50 border border-gray-100 rounded-[2rem] outline-none text-sm font-bold shadow-inner focus:ring-4 focus:ring-pink-50 transition-all" placeholder="ë‹‰ë„¤ì„, ì§ìœ„, ì§ì—… ê²€ìƒ‰"></div></div><div id="memberTableContainer" class="bg-white rounded-b-[3rem] border border-gray-100 overflow-hidden shadow-sm flex-1 min-h-0"></div></div>`;
            window.updateMemberTable();
        };

        window.updateMemberTable = () => {
            const container = document.getElementById('memberTableContainer'); if(!container) return;
            const term = appState.filters.search.toLowerCase();
            const filtered = appState.members.filter(m => { 
                const gMatch = appState.filters.guild === 'all' || m.guild === appState.filters.guild; 
                const sMatch = m.name.toLowerCase().includes(term) || 
                               (m.class||'').toLowerCase().includes(term) || 
                               (m.role||'').toLowerCase().includes(term) ||
                               (m.mainCharName || '').toLowerCase().includes(term) || 
                               (m.isMain && m.name.toLowerCase().includes(term)); 
                return gMatch && sMatch; 
            });
            filtered.sort((a, b) => smartCompare(a, b, appState.filters.sortField, appState.filters.sortOrder));
            const sortIcon = (f) => appState.filters.sortField === f ? (appState.filters.sortOrder === 'asc' ? ' <i class="fas fa-sort-up"></i>' : ' <i class="fas fa-sort-down"></i>') : '';
            let html = `<div class="overflow-y-auto h-full"><table class="w-full text-left min-w-[900px] text-xs whitespace-nowrap"><thead class="bg-gray-50 text-[10px] font-bold text-gray-500 border-b border-gray-100 sticky top-0 z-10"><tr><th class="p-4 text-center w-16">No.</th><th class="p-4 sortable" onclick="window.handleSort('name')">ë‹‰ë„¤ì„${sortIcon('name')}</th><th class="p-4 sortable" onclick="window.handleSort('mainInfo')">ë³¸ìº ì •ë³´${sortIcon('mainInfo')}</th><th class="p-4 sortable" onclick="window.handleSort('guild')">ì†Œì†${sortIcon('guild')}</th><th class="p-4 sortable" onclick="window.handleSort('role')">ì§ìœ„${sortIcon('role')}</th><th class="p-4 sortable" onclick="window.handleSort('class')">ì§ì—…${sortIcon('class')}</th><th class="p-4 text-right">ê´€ë¦¬</th></tr></thead><tbody class="divide-y divide-gray-50 text-gray-600 font-bold">`;
            filtered.forEach((m, idx) => {
                const mainName = m.isMain ? m.name : (m.mainCharName || '-'); 
                const mainMem = appState.members.find(x => x.name === mainName);
                const mainRankHtml = mainMem ? formatRankWithSuffix(mainMem.role) : '-';
                
                // ì¼ê´„ ìˆ˜ì • ëª¨ë“œì¼ ë•Œ, ìˆ˜ì • ëŒ€ê¸° ì¤‘ì¸ ê°’ì´ ìˆëŠ”ì§€ í™•ì¸
                const pending = appState.pendingUpdates[m.id];
                const currentGuild = pending && pending.guild ? pending.guild : m.guild;
                const currentRole = pending && pending.role ? pending.role : m.role;
                const currentClass = pending && pending.class ? pending.class : (m.class || '');

                html += `<tr class="${pending ? 'batch-modified' : ''} hover:bg-pink-50/20 group transition-colors h-14"><td class="p-3 text-center text-gray-400 text-[11px]">${idx+1}</td><td class="p-3 font-bold text-gray-800 flex items-center h-full leading-none">${window.getNicknameIcon(m.role)}<span class="text-sm tracking-tight">${m.name}</span></td><td class="p-3 leading-tight"><div><span class="block text-[11px] font-bold text-gray-700">${mainName}</span><span class="text-[9px] text-gray-400 font-medium">${mainRankHtml}</span></div></td><td class="p-3">${appState.isBatchMode ? `<select onchange="window.stageUpdate('${m.id}', 'guild', this.value)" class="bg-white border rounded px-1 text-[10px] outline-none">${appState.guilds.map(g=>`<option value="${g.name}" ${currentGuild===g.name?'selected':''}>${g.name}</option>`).join('')}</select>` : m.guild}</td><td class="p-3">${appState.isBatchMode ? `<select onchange="window.stageUpdate('${m.id}', 'role', this.value)" class="bg-white border rounded px-1 text-[10px] outline-none">${(appState.guildRanks[currentGuild]||initialGuildRanks[currentGuild]||initialGuildRanks['ëš ì¹´ë¡±']).map(r=>`<option value="${r}" ${currentRole===r?'selected':''}>${r}</option>`).join('')}</select>` : `<span class="text-[10px]">${m.role}</span>`}</td><td class="p-3">${appState.isBatchMode ? `<input type="text" value="${currentClass}" onchange="window.stageUpdate('${m.id}', 'class', this.value)" class="bg-white border rounded px-1 text-[10px] w-24 outline-none">` : `<span class="text-[10px] text-gray-400">${m.class||'-'}</span>`}</td><td class="p-3 text-right">${!appState.isBatchMode ? `<div class="flex justify-end gap-1 opacity-0 group-hover:opacity-100 transition-opacity"><button onclick="window.openEditModal('${m.id}')" class="w-8 h-8 rounded-xl border border-gray-100 text-blue-500 hover:bg-blue-50 flex items-center justify-center shadow-sm"><i class="fas fa-edit text-[10px]"></i></button><button onclick="window.openDeleteModal('${m.id}')" class="w-8 h-8 rounded-xl border border-gray-100 text-red-500 hover:bg-red-50 flex items-center justify-center shadow-sm"><i class="fas fa-trash text-[10px]"></i></button></div>` : '<span class="text-[9px] text-gray-300">ìˆ˜ì • ì¤‘</span>'}</td></tr>`;
            });
            html += `</tbody></table></div>`; container.innerHTML = html;
        };

        // --- SURO SCORES ---
        window.renderSuro = (container) => {
            container.innerHTML = `<div class="flex flex-col gap-8 fade-in h-full"><div class="bg-white p-10 rounded-t-[3rem] border border-gray-100 space-y-8 shadow-sm shrink-0"><div class="flex flex-col md:flex-row justify-between items-center gap-6"><div class="flex overflow-x-auto pb-2 no-scrollbar w-full md:w-auto gap-3"><button onclick="window.filterSuroGuild('all')" class="shrink-0 px-8 py-3 rounded-2xl text-xs font-bold transition-all ${appState.suroFilters.guild === 'all' ? 'bg-gray-800 text-white shadow-xl' : 'bg-gray-50 text-gray-500'}">ì „ì²´ ë³´ê¸°</button>${appState.guilds.map(g => `<button onclick="window.filterSuroGuild('${g.name}')" class="shrink-0 px-8 py-3 rounded-2xl text-xs font-bold transition-all ${appState.suroFilters.guild === g.name ? 'bg-blue-500 text-white shadow-xl' : 'bg-gray-50 text-gray-500'}">${g.name}</button>`).join('')}</div><button onclick="window.saveSuroInputs()" id="btnSuroSave" class="px-10 py-4 bg-blue-500 text-white rounded-2xl font-bold shadow-xl hover:bg-blue-600 transition-all text-xs">ìˆ˜ë¡œ ì ìˆ˜ ì €ì¥</button></div><div class="relative"><i class="fas fa-search absolute left-6 top-1/2 -translate-y-1/2 text-gray-400"></i><input type="text" oninput="window.filterSuroSearch(this.value)" class="w-full pl-16 pr-8 py-4 bg-gray-50 border border-gray-100 rounded-[2rem] outline-none font-bold text-sm shadow-inner focus:ring-4 focus:ring-blue-50 transition-all" placeholder="ë‹‰ë„¤ì„ ê²€ìƒ‰"></div></div><div id="suroTableContainer" class="bg-white rounded-b-[3rem] border border-gray-100 overflow-hidden shadow-sm flex-1 min-h-0 flex flex-col"></div></div>`;
            window.updateSuroTable();
        };

        window.updateSuroTable = () => {
            const container = document.getElementById('suroTableContainer'); if(!container) return;
            const period = window.getSuroPeriodHeader(); const prevHeader = appState.suroHeaders.slice(-2)[0] || ""; const term = (appState.suroFilters.search || '').toLowerCase();
            const filtered = appState.members.filter(m => (appState.suroFilters.guild === 'all' || m.guild === appState.suroFilters.guild) && m.name.toLowerCase().includes(term));
            filtered.sort((a, b) => { const f = appState.suroFilters.sortField, o = appState.suroFilters.sortOrder; if (f === 'prev') return smartCompare({prev: Number(a.suro?.[prevHeader]||0)}, {prev: Number(b.suro?.[prevHeader]||0)}, 'prev', o); if (f === 'curr') { const valA = Number(appState.currentSuroInputs[a.name] || a.suro?.[period] || 0), valB = Number(appState.currentSuroInputs[b.name] || b.suro?.[period] || 0); return o === 'asc' ? valA - valB : valB - valA; } return smartCompare(a, b, f, o); });
            const sortIcon = (f) => appState.suroFilters.sortField === f ? (appState.suroFilters.sortOrder === 'asc' ? ' <i class="fas fa-sort-up"></i>' : ' <i class="fas fa-sort-down"></i>') : '';
            let html = `<div class="overflow-y-auto flex-1 p-0"><table class="w-full text-left min-w-[800px]"><thead class="bg-gray-50 text-gray-500 text-[10px] font-bold uppercase sticky top-0 z-10 border-b border-gray-100 shadow-sm"><tr><th class="p-4 cursor-pointer hover:bg-gray-100 transition-colors" onclick="window.handleSuroSort('name')">ë‹‰ë„¤ì„ (ìœ ë‹ˆì½”ë“œ)${sortIcon('name')}</th><th class="p-4 cursor-pointer hover:bg-gray-100 transition-colors" onclick="window.handleSuroSort('guild')">ì†Œì†${sortIcon('guild')}</th><th class="p-4 text-right cursor-pointer hover:bg-gray-100 transition-colors" onclick="window.handleSuroSort('prev')">ì§€ë‚œ ê¸°ë¡${sortIcon('prev')}</th><th class="p-4 text-right w-48 cursor-pointer hover:bg-gray-100 transition-colors" onclick="window.handleSuroSort('curr')">ì´ë²ˆì£¼ ì ìˆ˜${sortIcon('curr')}</th></tr></thead><tbody class="divide-y divide-gray-50 font-bold">`;
            filtered.forEach((m, idx) => {
                const currVal = appState.currentSuroInputs[m.name] !== undefined ? appState.currentSuroInputs[m.name] : (m.suro?.[period] || ''), prevVal = Number(m.suro?.[prevHeader] || 0);
                html += `<tr class="hover:bg-blue-50/30 transition-colors h-14"><td class="p-4 font-bold text-gray-800 flex items-center h-full text-sm leading-none">${window.getNicknameIcon(m.role)}${m.name}</td><td class="p-4 text-xs font-bold text-gray-400">${m.guild}</td><td class="p-4 text-right font-mono text-gray-300 text-xs">${prevVal > 0 ? prevVal.toLocaleString() : '-'}</td><td class="p-3"><input type="number" class="w-full bg-gray-50 border border-gray-100 rounded-xl px-4 py-2 text-right font-bold outline-none focus:bg-white focus:ring-2 focus:ring-blue-100 shadow-inner" value="${currVal}" oninput="appState.currentSuroInputs['${m.name}']=this.value"></td></tr>`;
            });
            html += `</tbody></table></div>`; container.innerHTML = html;
        };

        window.saveSuroInputs = async () => {
            const data = Object.entries(appState.currentSuroInputs).filter(([n, s]) => s !== "" && s !== null).map(([name, score]) => ({ name, score }));
            if(data.length === 0) return window.showMsg("ì…ë ¥ëœ ì ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.", "error");
            if(!confirm(`${data.length}ëª…ì˜ ì •ë³´ë¥¼ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            const btn = document.getElementById('btnSuroSave'); if (btn) { btn.disabled = true; btn.innerText = "ì €ì¥ ì¤‘..."; }
            if (await window.sendAction('save_suro', data)) { appState.currentSuroInputs = {}; }
            else if (btn) { btn.disabled = false; btn.innerText = "ìˆ˜ë¡œ ì ìˆ˜ ì €ì¥"; }
        };

        // --- BAIL MANAGEMENT ---
        window.renderBail = (container) => {
            const receivers = appState.members.filter(m => m.guild === 'ëš ì¹´ë¡±' && ['ë§ˆì¹´ë¡±', 'ë‹¤ì¿ ì•„ì¦ˆ'].includes(m.role)).sort((a,b) => smartCompare(a, b, 'name', 'asc'));
            const adminStats = window.getAdminBailStats();
            const historyRows = [...appState.bailHistory].reverse().map(h => `<tr class="hover:bg-gray-50 border-b border-gray-50 h-12 transition-colors font-bold text-xs"><td class="p-4 font-mono text-gray-400 text-[10px]">${h.date}</td><td class="p-4 text-gray-700">${h.payer}</td><td class="p-4 text-blue-500">${h.receiver}</td><td class="p-4 text-right text-pink-500">${h.amount}ê°œ</td></tr>`).join('');
            const statsHtml = adminStats.map(([name, count]) => `<div class="bg-gray-50 rounded-2xl p-4 flex justify-between items-center border border-gray-100 hover:bg-white transition-all shadow-sm"><span class="font-bold text-gray-700 text-xs">${name}</span><span class="font-black text-pink-500 text-lg">${count}ê°œ</span></div>`).join('');
            container.innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-3 gap-8 fade-in h-full"><div class="lg:col-span-1 bg-white p-10 rounded-[3rem] border border-gray-100 shadow-sm flex flex-col h-full overflow-hidden"><div class="mb-8"><h3 class="text-xl font-bold text-gray-800 tracking-tight">ë³´ì„ê¸ˆ ë‚©ë¶€ ë“±ë¡</h3><p class="text-xs text-gray-400 mt-1 uppercase font-bold tracking-widest">GEM BAIL REGISTRATION</p></div><div class="space-y-6 flex-1 overflow-y-auto no-scrollbar pb-6"><div class="space-y-2"><label class="text-[10px] font-bold text-gray-400 ml-1 uppercase">ë‚©ë¶€ì</label><input type="text" id="bailPayerInput" class="w-full bg-gray-50 border border-gray-100 rounded-2xl p-4 text-sm font-bold outline-none shadow-inner" placeholder="ë‹‰ë„¤ì„ ì§ì ‘ ì…ë ¥"></div><div class="space-y-2"><label class="text-[10px] font-bold text-gray-400 ml-1 uppercase">ìˆ˜ë ¹ì</label><select id="bailReceiver" class="w-full bg-gray-50 border border-gray-100 rounded-2xl p-4 text-sm font-bold outline-none shadow-sm cursor-pointer font-bold">${receivers.map(r=>`<option value="${r.name}">${r.name} (${r.role})</option>`).join('')}</select></div><div class="space-y-2"><label class="text-[10px] font-bold text-gray-400 ml-1 uppercase">ìˆ˜ëŸ‰</label><input type="number" id="bailAmount" value="1" min="1" class="w-full bg-gray-50 border border-gray-100 rounded-2xl p-4 text-sm font-bold outline-none shadow-inner"></div><button onclick="window.submitBail()" id="btnBailSubmit" class="w-full py-6 bg-gray-900 text-white rounded-[2rem] font-bold text-xs shadow-2xl hover:bg-black transition-all active:scale-[0.98]">ë‚©ë¶€ í™•ì¸ ë° ì €ì¥</button><div class="mt-8 border-t pt-8"><h4 class="text-xs font-bold text-gray-400 mb-4 uppercase tracking-widest">ê°„ë¶€ë³„ ìˆ˜ë ¹ ì´ê³„</h4><div class="grid grid-cols-1 gap-2">${statsHtml || '<p class="text-[10px] text-gray-300 italic text-center">ë°ì´í„° ì—†ìŒ</p>'}</div></div></div></div><div class="lg:col-span-2 bg-white rounded-[3rem] border border-gray-100 shadow-sm flex flex-col overflow-hidden h-full"><div class="p-8 border-b border-gray-50 flex justify-between items-center"><h3 class="text-sm font-bold text-gray-800 uppercase tracking-widest">ìµœê·¼ ë³´ì„ê¸ˆ ë‚´ì—­ (yy-mm-dd)</h3><span class="text-[10px] text-gray-400 font-bold italic">Total: ${appState.bailHistory.length}</span></div><div class="flex-1 overflow-y-auto no-scrollbar"><table class="w-full text-left text-xs"><thead class="bg-gray-50 text-[10px] font-bold text-gray-500 uppercase sticky top-0"><tr><th class="p-5">ë‚ ì§œ</th><th class="p-5">ë‚©ë¶€ì</th><th class="p-5">ìˆ˜ë ¹ì</th><th class="p-5 text-right">ìˆ˜ëŸ‰</th></tr></thead><tbody class="divide-y divide-gray-50">${historyRows || '<tr><td colspan="4" class="p-20 text-center text-gray-300 font-bold italic">ë‚´ì—­ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</td></tr>'}</tbody></table></div></div></div>`;
        };

        window.submitBail = async () => {
            const pI = document.getElementById('bailPayerInput'), rI = document.getElementById('bailReceiver'), aI = document.getElementById('bailAmount'), btn = document.getElementById('btnBailSubmit');
            const payer = pI.value.trim(), receiver = rI.value, amount = aI.value; if(!payer || !receiver || !amount) return window.showMsg("í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.", "error");
            if(!confirm(`${payer} ë‹˜ì˜ ë³´ì„ê¸ˆ ${amount}ê°œë¥¼ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            if (btn) { btn.disabled = true; btn.innerText = "ì „ì†¡ ì¤‘..."; }
            if (await window.sendAction('save_bail', { payer, receiver, amount })) { pI.value = ''; aI.value = '1'; }
            else if (btn) { btn.disabled = false; btn.innerText = "ë‚©ë¶€ í™•ì¸ ë° ì €ì¥"; }
        };

        // --- PENALTY MANAGEMENT ---
        window.renderPenalty = (container) => {
            const memberOptions = appState.members.map(m => `<option value="${m.name}">${m.name} (${m.guild})</option>`).sort();
            
            // Calculate penalty counts
            const penaltyCounts = {};
            appState.penaltyHistory.forEach(h => {
                penaltyCounts[h.name] = (penaltyCounts[h.name] || 0) + Number(h.points);
            });
            // Just displaying users with > 0 total points (simple logic for now)
            const activePenalties = Object.entries(penaltyCounts).filter(([name, pts]) => pts > 0);

            const penaltyRows = [...appState.penaltyHistory].map(h => {
                // Ensure date format is safe
                let displayDate = "-";
                if(h.date) {
                    const datePart = h.date.split(' ')[0]; // 2026-02-18
                    if(datePart.length >= 2) displayDate = datePart.substring(2); // 26-02-18
                }
                
                return `
                <tr class="hover:bg-gray-50 border-b border-gray-50 h-12 transition-colors font-bold text-xs">
                    <!-- ë‚ ì§œ í˜•ì‹ YY-MM-DDë¡œ ë³€ê²½ -->
                    <td class="p-4 font-mono text-gray-400 text-[10px]">${displayDate}</td>
                    <td class="p-4 text-gray-700">${h.name}</td>
                    <td class="p-4 text-red-500">${h.points}ì </td>
                    <td class="p-4 text-gray-500 text-[11px]">${h.reason}</td>
                </tr>
            `}).join('');

            container.innerHTML = `
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 fade-in h-full">
                <!-- Left: Form -->
                <div class="lg:col-span-1 bg-white p-10 rounded-[3rem] border border-gray-100 shadow-sm flex flex-col h-full overflow-hidden">
                    <div class="mb-8">
                        <h3 class="text-xl font-bold text-gray-800 tracking-tight">ë²Œì  ë¶€ì—¬</h3>
                        <p class="text-xs text-gray-400 mt-1 uppercase font-bold tracking-widest">PENALTY RECORD</p>
                    </div>
                    <div class="space-y-6 flex-1 overflow-y-auto no-scrollbar pb-6">
                        <div class="space-y-2">
                            <label class="text-[10px] font-bold text-gray-400 ml-1 uppercase">ë¶€ì—¬ ë‚ ì§œ</label>
                            <input type="date" id="penaltyDate" class="w-full bg-gray-50 border border-gray-100 rounded-2xl p-4 text-sm font-bold outline-none shadow-inner" value="${new Date().toISOString().split('T')[0]}">
                        </div>
                        <div class="space-y-2">
                            <label class="text-[10px] font-bold text-gray-400 ml-1 uppercase">ëŒ€ìƒì</label>
                            <select id="penaltyTarget" class="w-full bg-gray-50 border border-gray-100 rounded-2xl p-4 text-sm font-bold outline-none shadow-sm cursor-pointer font-bold">
                                <option value="">ëŒ€ìƒìë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                                ${memberOptions}
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="text-[10px] font-bold text-gray-400 ml-1 uppercase">ë²Œì  (1~10ì )</label>
                            <select id="penaltyPoints" class="w-full bg-gray-50 border border-gray-100 rounded-2xl p-4 text-sm font-bold outline-none shadow-sm cursor-pointer font-bold">
                                ${[1,2,3,4,5,6,7,8,9,10].map(i => `<option value="${i}">${i}ì </option>`).join('')}
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="text-[10px] font-bold text-gray-400 ml-1 uppercase">ë¶€ì—¬ ì‚¬ìœ </label>
                            <textarea id="penaltyReason" rows="4" class="w-full bg-gray-50 border border-gray-100 rounded-2xl p-4 text-sm font-bold outline-none shadow-inner resize-none" placeholder="ìƒì„¸ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                        </div>
                        <button onclick="window.submitPenalty()" id="btnPenaltySubmit" class="w-full py-6 bg-red-600 text-white rounded-[2rem] font-bold text-xs shadow-xl hover:bg-red-700 transition-all active:scale-[0.98] mt-4">ë²Œì  ì €ì¥</button>
                    </div>
                </div>

                <!-- Right: Status & History -->
                <div class="lg:col-span-2 flex flex-col gap-6 h-full overflow-hidden">
                    <!-- Current Targets Card -->
                    <div class="bg-white p-8 rounded-[3rem] border border-gray-100 shadow-sm shrink-0 min-h-[160px]">
                        <div class="mb-4">
                            <h3 class="text-sm font-bold text-gray-800 uppercase tracking-widest">í˜„ì¬ ë²Œì  ê´€ë¦¬ ëŒ€ìƒì</h3>
                        </div>
                        <div class="flex gap-4 overflow-x-auto no-scrollbar pb-2">
                            ${activePenalties.length > 0 
                                ? activePenalties.map(([name, pts]) => `
                                    <div class="flex items-center gap-3 bg-red-50 pl-2 pr-5 py-2 rounded-full border border-red-100 shrink-0">
                                        <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center text-red-500 font-bold text-xs shadow-sm">${pts}</div>
                                        <span class="text-xs font-bold text-red-600">${name}</span>
                                    </div>
                                  `).join('')
                                : '<p class="text-xs text-gray-300 font-bold italic w-full">í˜„ì¬ ë²Œì ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>'
                            }
                        </div>
                    </div>

                    <!-- History Table -->
                    <div class="bg-white rounded-[3rem] border border-gray-100 shadow-sm flex flex-col flex-1 overflow-hidden">
                        <div class="p-8 border-b border-gray-50 flex justify-between items-center shrink-0">
                            <h3 class="text-sm font-bold text-gray-800 uppercase tracking-widest">ìƒì„¸ ë¶€ì—¬ ì´ë ¥</h3>
                        </div>
                        <div class="flex-1 overflow-y-auto no-scrollbar">
                            <table class="w-full text-left text-xs whitespace-nowrap">
                                <thead class="bg-gray-50 text-[10px] font-bold text-gray-500 uppercase sticky top-0">
                                    <tr>
                                        <th class="p-5">ë‚ ì§œ</th>
                                        <th class="p-5">ëŒ€ìƒì</th>
                                        <th class="p-5">ì ìˆ˜</th>
                                        <th class="p-5">ë¶€ì—¬ ì‚¬ìœ </th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-50">
                                    ${penaltyRows || '<tr><td colspan="4" class="p-20 text-center text-gray-300 font-bold italic">ë²Œì  ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>`;
        };

        window.submitPenalty = async () => {
            const date = document.getElementById('penaltyDate').value;
            const target = document.getElementById('penaltyTarget').value;
            const points = document.getElementById('penaltyPoints').value;
            const reason = document.getElementById('penaltyReason').value.trim();
            const btn = document.getElementById('btnPenaltySubmit');

            if (!date || !target || !points || !reason) return window.showMsg("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", "error");
            if (!confirm(`${target}ë‹˜ì—ê²Œ ${date} ì¼ìë¡œ ë²Œì  ${points}ì ì„ ë¶€ì—¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            if (btn) { btn.disabled = true; btn.innerText = "ì €ì¥ ì¤‘..."; }
            if (await window.sendAction('save_penalty', { date: date, name: target, points: points, reason: reason })) {
                document.getElementById('penaltyReason').value = '';
            } else if (btn) {
                btn.disabled = false; btn.innerText = "ë²Œì  ì €ì¥";
            }
        };

        // --- OTHER TABS ---
        window.renderSheet = (container) => { const embedUrl = appState.sheetUrl.includes('/edit') ? appState.sheetUrl.split('/edit')[0] + '/preview' : appState.sheetUrl; container.innerHTML = `<div class="h-full flex flex-col gap-6 fade-in"><div class="bg-white p-8 rounded-[2.5rem] border border-gray-100 shadow-sm flex flex-col md:flex-row justify-between items-center gap-4 shrink-0"><div><h3 class="text-lg font-bold text-gray-800 tracking-tight">êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ë·°ì–´</h3><p class="text-xs text-gray-400 mt-1">ì›ë³¸ ì‹œíŠ¸ë¥¼ ì¦‰ì‹œ ì—°ê²°í•˜ê±°ë‚˜ ì‹¤ì‹œê°„ìœ¼ë¡œ í™•ì¸í•©ë‹ˆë‹¤.</p></div><button onclick="window.open('${appState.sheetUrl}', '_blank')" class="px-10 py-4 bg-gray-900 text-white text-xs font-bold rounded-2xl shadow-xl hover:bg-black transition-all flex items-center gap-2"><i class="fas fa-external-link-alt"></i> ì›ë³¸ ì‹œíŠ¸ ë°”ë¡œê°€ê¸°</button></div><div class="flex-1 bg-white rounded-[3rem] border border-gray-100 overflow-hidden shadow-sm relative"><iframe src="${embedUrl}" class="w-full h-full border-none"></iframe></div></div>`; };
        window.renderHistory = (container) => { container.innerHTML = `<div class="bg-white rounded-[3rem] border border-gray-100 shadow-sm overflow-hidden h-full flex flex-col"><div class="p-8 border-b font-bold text-gray-800 shrink-0">ìš´ì˜ ì´ë ¥</div><div class="flex-1 overflow-y-auto no-scrollbar"><table class="w-full text-left text-xs whitespace-nowrap"><thead class="bg-gray-50 text-[10px] font-bold text-gray-500 uppercase sticky top-0"><tr><th class="p-6">DATE</th><th class="p-6">TYPE</th><th class="p-6">NAME</th><th class="p-6">CONTENT</th></tr></thead><tbody class="divide-y divide-gray-100">${appState.history.length === 0 ? `<tr><td colspan="4" class="p-20 text-center text-gray-300 font-bold">ê¸°ë¡ ì—†ìŒ</td></tr>` : [...appState.history].reverse().map(l => `<tr class="hover:bg-gray-50 transition-colors h-12 leading-none font-bold"><td class="p-6 text-gray-400 font-mono text-[10px]">${l.date}</td><td class="p-6"><span class="px-2 py-1 rounded-lg bg-gray-100 text-[9px] font-bold">${l.category}</span></td><td class="p-6 text-gray-700">${l.name}</td><td class="p-6 text-gray-500">${l.content}</td></tr>`).join('')}</tbody></table></div></div>`; };
        window.renderSettings = (container) => { container.innerHTML = `<div class="bg-white p-12 rounded-[3rem] border border-gray-100 shadow-sm max-w-4xl font-bold h-fit"><h3 class="text-xl mb-10 text-gray-800">ì‹œìŠ¤í…œ ì„¤ì •</h3><div class="space-y-8"><div class="space-y-2"><label class="text-[10px] font-bold text-gray-400 uppercase font-bold">Apps Script WebApp URL</label><input type="text" id="settingScriptUrl" value="${localStorage.getItem('macaron_script_url') || appState.scriptUrl}" class="w-full bg-gray-50 border border-gray-100 rounded-2xl p-5 text-xs font-mono outline-none shadow-inner focus:ring-4 focus:ring-gray-100 transition-all"></div><div class="space-y-2"><label class="text-[10px] font-bold text-gray-400 uppercase font-bold">Google Sheet URL</label><input type="text" id="settingSheetUrl" value="${localStorage.getItem('macaron_sheet_url') || appState.sheetUrl}" class="w-full bg-gray-50 border border-gray-100 rounded-2xl p-5 text-xs font-mono outline-none shadow-inner focus:ring-4 focus:ring-gray-100 transition-all"></div><button onclick="window.saveSettings()" class="w-full py-6 bg-gray-900 text-white rounded-3xl font-bold shadow-xl active:scale-[0.98] transition-all">ì„¤ì • ì €ì¥ ë° ì‹œìŠ¤í…œ ì¬ì‹œì‘</button></div></div>`; };
        window.saveSettings = () => { localStorage.setItem('macaron_script_url', document.getElementById('settingScriptUrl').value.trim()); localStorage.setItem('macaron_sheet_url', document.getElementById('settingSheetUrl').value.trim()); window.showMsg("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.", "success"); setTimeout(()=>location.reload(), 800); };

        window.toggleBatchMode = () => { appState.isBatchMode = !appState.isBatchMode; appState.pendingUpdates = {}; window.renderMembers(document.getElementById('contentArea')); };
        window.stageUpdate = (id, field, val) => { if(!appState.pendingUpdates[id]) appState.pendingUpdates[id] = { id }; appState.pendingUpdates[id][field] = val; window.updateMemberTable(); };
        window.saveBatchUpdates = async () => { const updates = Object.values(appState.pendingUpdates); if(updates.length === 0) return window.showMsg("ìˆ˜ì •ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.", "error"); if(confirm(`${updates.length}ëª…ì˜ ì •ë³´ë¥¼ ì—…ë°ì´íŠ¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) { if(await window.sendAction('bulk_update', updates)) { appState.isBatchMode = false; appState.pendingUpdates = {}; } } };
        window.handleSearch = (v) => { appState.filters.search = v; window.updateMemberTable(); };
        window.filterByGuild = (g) => { appState.filters.guild = g; if(appState.activeTab === 'members') window.renderMembers(document.getElementById('contentArea')); else window.updateMemberTable(); };
        window.handleSort = (field) => { if(appState.filters.sortField === field) appState.filters.sortOrder = appState.filters.sortOrder === 'asc' ? 'desc' : 'asc'; else { appState.filters.sortField = field; appState.filters.sortOrder = 'asc'; } window.updateMemberTable(); };
        window.handleSuroSort = (field) => { if(appState.suroFilters.sortField === field) appState.suroFilters.sortOrder = appState.suroFilters.sortOrder === 'asc' ? 'desc' : 'asc'; else { appState.suroFilters.sortField = field; appState.suroFilters.sortOrder = 'asc'; } window.updateSuroTable(); };
        window.filterSuroGuild = (g) => { appState.suroFilters.guild = g; window.updateSuroTable(); window.renderSuro(document.getElementById('contentArea')); };
        window.filterSuroSearch = (v) => { appState.suroFilters.search = v; window.updateSuroTable(); };
        window.closeModal = (id) => { document.getElementById(id)?.classList.add('hidden'); };
        
        window.openEditModal = (id) => { 
            const m = appState.members.find(x => x.id == id); if(!m) return;
            document.getElementById('modalTitle').innerText = 'ë©¤ë²„ ì •ë³´ ìˆ˜ì •'; document.getElementById('editMemberId').value = m.id; document.getElementById('inputName').value = m.name; document.getElementById('inputName').disabled = true;
            document.getElementById('inputClass').innerHTML = MAPLE_JOBS.map(j=>`<option value="${j}">${j}</option>`).join(''); document.getElementById('inputClass').value = m.class || '';
            document.getElementById('inputGuild').innerHTML = appState.guilds.map(g=>`<option value="${g.name}">${g.name}</option>`).join(''); document.getElementById('inputGuild').value = m.guild;
            onGuildSelectChange(m.guild); setTimeout(() => { document.getElementById('inputRole').value = m.role; }, 100);
            document.getElementById('inputIsMain').checked = m.isMain; document.getElementById('inputMainCharName').value = m.mainCharName || ''; toggleMainCharInput(); document.getElementById('memberModal').classList.remove('hidden');
        };
        window.openAddModal = () => {
            document.getElementById('modalTitle').innerText = 'ë©¤ë²„ ì‹ ê·œ ë“±ë¡'; document.getElementById('memberForm').reset(); document.getElementById('editMemberId').value = ''; document.getElementById('inputName').disabled = false;
            document.getElementById('inputClass').innerHTML = MAPLE_JOBS.map(j=>`<option value="${j}">${j}</option>`).join('');
            document.getElementById('inputGuild').innerHTML = appState.guilds.map(g=>`<option value="${g.name}">${g.name}</option>`).join('');
            onGuildSelectChange(appState.guilds[0].name); toggleMainCharInput(); document.getElementById('memberModal').classList.remove('hidden');
        };
        window.openDeleteModal = (id) => { appState.memberToDelete = appState.members.find(x => x.id == id); document.getElementById('deleteTargetName').innerText = appState.memberToDelete.name; document.getElementById('deleteModal').classList.remove('hidden'); };
        window.setDeleteType = (t) => { appState.deleteType = t; document.getElementById('btnLeave').className = t === 'leave' ? 'flex-1 py-3 rounded-xl font-bold text-xs bg-gray-800 text-white shadow-sm transition-all' : 'flex-1 py-3 rounded-xl font-bold text-xs bg-gray-100 text-gray-400 transition-all'; document.getElementById('btnKick').className = t === 'kick' ? 'flex-1 py-3 rounded-xl font-bold text-xs bg-red-600 text-white shadow-sm transition-all' : 'flex-1 py-3 rounded-xl font-bold text-xs bg-gray-100 text-gray-400 transition-all'; };
        window.confirmDelete = async () => { if(await window.sendAction('delete', { id: appState.memberToDelete.id, type: appState.deleteType, reason: document.getElementById('deleteReason').value })) window.closeModal('deleteModal'); };
        function onGuildSelectChange(v) { document.getElementById('inputRole').innerHTML = (appState.guildRanks[v] || initialGuildRanks[v] || initialGuildRanks['ëš ì¹´ë¡±']).map(r => `<option value="${r}">${r}</option>`).join(''); }
        function toggleMainCharInput() { document.getElementById('mainCharInputGroup').classList.toggle('hidden', document.getElementById('inputIsMain').checked); }
        
        document.getElementById('memberForm').onsubmit = async (e) => {
            e.preventDefault(); const id = document.getElementById('editMemberId').value;
            const data = { name: document.getElementById('inputName').value.trim(), guild: document.getElementById('inputGuild').value, role: document.getElementById('inputRole').value, class: document.getElementById('inputClass').value, isMain: document.getElementById('inputIsMain').checked, mainCharName: document.getElementById('inputMainCharName').value.trim(), joinDate: new Date().toISOString().split('T')[0] };
            if(await window.sendAction(id ? 'update' : 'add', id ? { ...data, id } : data)) window.closeModal('memberModal');
        };

        function initSidebar() {
            const sb = document.getElementById('sidebar'), ov = document.getElementById('sidebarOverlay');
            document.getElementById('openSidebar').onclick = () => { sb.classList.remove('-translate-x-full'); ov.classList.remove('hidden'); };
            document.getElementById('closeSidebar').onclick = () => { sb.classList.add('-translate-x-full'); ov.classList.add('hidden'); };
            ov.onclick = () => { sb.classList.add('-translate-x-full'); ov.classList.add('hidden'); };
        }

        document.addEventListener('DOMContentLoaded', () => { initSidebar(); window.fetchMembers(); });
    </script>
</body>
</html>
