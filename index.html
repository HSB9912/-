<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëš ì¹´ë¡± ê¸¸ë“œ ê´€ë¦¬ ì‹œìŠ¤í…œ (v8.4)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        
        .chart-container { position: relative; width: 100%; height: 300px; }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #fbcfe8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #f472b6; }
        
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        th.sortable { cursor: pointer; user-select: none; transition: background 0.2s; }
        th.sortable:hover { background-color: #fdf2f8 !important; color: #db2777 !important; }

        .force-hide { display: none !important; }
        #loadingOverlay {
            position: fixed; inset: 0; background: white; z-index: 10000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }

        .nav-item.active { background-color: #fdf2f8; color: #ec4899; box-shadow: inset 4px 0 0 #ec4899; }
        
        #msgBox { transition: all 0.3s ease; transform: translateY(100px); opacity: 0; pointer-events: none; }
        #msgBox.show { transform: translateY(0); opacity: 1; }

        .btn-loading { pointer-events: none; opacity: 0.6; position: relative; color: transparent !important; }
        .btn-loading:after { content: ""; position: absolute; width: 16px; height: 16px; top: 50%; left: 50%; margin: -8px 0 0 -8px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .page-btn { padding: 0.5rem 1rem; border-radius: 0.75rem; font-size: 0.75rem; font-weight: bold; transition: all 0.2s; border: 1px solid #e5e7eb; background: white; color: #6b7280; }
        .page-btn.active { background: #ec4899; color: white; border-color: #ec4899; box-shadow: 0 4px 6px -1px rgba(236, 72, 153, 0.2); }
        .page-btn:hover:not(.active) { background: #f9fafb; color: #ec4899; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* ë‹¬ë ¥ ìŠ¤íƒ€ì¼ */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem; text-align: center; font-size: 0.8rem; }
        .calendar-day { padding: 0.5rem; border-radius: 1rem; position: relative; transition: all 0.2s; }
        .calendar-day:hover { background-color: #f9fafb; }
        .calendar-day.today { background-color: #ec4899; color: white; box-shadow: 0 4px 6px -1px rgba(236, 72, 153, 0.4); }
        .calendar-day.thursday { color: #db2777; background-color: #fdf2f8; border: 1px solid #fbcfe8; }
        .calendar-head { font-size: 0.75rem; font-weight: 800; color: #9ca3af; text-transform: uppercase; padding-bottom: 0.5rem; }

        /* ë°°ì¹˜ ëª¨ë“œ ìŠ¤íƒ€ì¼ */
        .batch-modified { background-color: #fff7ed !important; } 
        .batch-deleted { opacity: 0.4; text-decoration: line-through; background-color: #fee2e2 !important; }

        /* ì£¼ê°€ ìŠ¤íƒ€ì¼ (ìƒìŠ¹:ë¹¨ê°• / í•˜ë½:íŒŒë‘) */
        .trend-up { color: #ef4444; } /* Red for Up */
        .trend-down { color: #3b82f6; } /* Blue for Down */
        .trend-neutral { color: #9ca3af; }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 h-screen overflow-hidden flex font-medium">

    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-pink-500 border-opacity-20 border-t-pink-500 mb-8 mx-auto"></div>
            <p class="text-pink-600 font-bold text-xl tracking-tight">í´ë¼ìš°ë“œ ì„œë²„ì™€ ë°ì´í„° ë™ê¸°í™” ì¤‘...</p>
            <p class="text-gray-400 text-xs mt-4 uppercase tracking-widest font-bold">Processing Data Sync</p>
            <button id="forceEnterBtn" onclick="hideOverlay()" class="hidden mt-8 text-[10px] text-gray-400 underline uppercase tracking-widest font-bold hover:text-pink-500 transition-colors">ì„œë²„ ì‘ë‹µ ì§€ì—° - ê°•ì œ ì…ì¥í•˜ê¸°</button>
        </div>
    </div>

    <!-- Message Box -->
    <div id="msgBox" class="fixed bottom-10 left-1/2 -translate-x-1/2 z-[200] bg-slate-900 text-white px-8 py-4 rounded-2xl shadow-2xl flex items-center gap-4 border border-white/10">
        <div id="msgIcon" class="text-pink-500"><i class="fas fa-info-circle"></i></div>
        <p id="msgText" class="text-sm font-bold"></p>
    </div>

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed lg:static inset-y-0 left-0 z-50 w-64 bg-white border-r border-gray-100 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 flex flex-col shadow-sm">
        <div class="p-6 border-b border-gray-100 flex items-center gap-3">
            <div class="w-10 h-10 rounded-2xl bg-gradient-to-tr from-pink-400 to-rose-400 flex items-center justify-center text-white font-bold shadow-lg shadow-pink-100 text-xl">ëš </div>
            <div>
                <h1 class="text-lg font-bold text-gray-800 tracking-tight">ëš ì¹´ë¡± ê¸¸ë“œ ê´€ë¦¬</h1>
                <p class="text-[9px] text-gray-400 font-bold uppercase tracking-widest leading-none mt-1">System Dashboard</p>
            </div>
            <button id="closeSidebar" class="lg:hidden ml-auto text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
        </div>
        
        <nav class="p-4 space-y-2 flex-1">
            <button onclick="router('dashboard')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="dashboard">
                <i class="fas fa-columns w-5 text-center"></i><span>ëŒ€ì‹œë³´ë“œ</span>
            </button>
            <button onclick="router('members')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="members">
                <i class="fas fa-users w-5 text-center"></i><span>ê¸¸ë“œì› ê´€ë¦¬</span>
            </button>
            <button onclick="router('suro')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="suro">
                <i class="fas fa-edit w-5 text-center"></i><span>ìˆ˜ë¡œ ì ìˆ˜ ì…ë ¥</span>
            </button>
            <button onclick="router('analysis')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="analysis">
                <i class="fas fa-chart-line w-5 text-center"></i><span>ìˆ˜ë¡œ ì ìˆ˜ ë¶„ì„</span>
            </button>
            <button onclick="router('sheet')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="sheet">
                <i class="fas fa-table w-5 text-center"></i><span>ì‹œíŠ¸ ë³´ê¸°</span>
            </button>
            <button onclick="router('history')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="history">
                <i class="fas fa-history w-5 text-center"></i><span>ìš´ì˜ ì´ë ¥</span>
            </button>
            <button onclick="router('settings')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="settings">
                <i class="fas fa-cog w-5 text-center"></i><span>ì„¤ì •</span>
            </button>
        </nav>
        <div class="p-4 border-t border-gray-100 bg-gray-50/50 text-center font-bold">
            <p class="text-[10px] text-green-500 uppercase tracking-widest"><i class="fas fa-cloud mr-1 animate-pulse"></i> ì‹¤ì‹œê°„ ì—°ë™ ì¤‘</p>
        </div>
    </aside>

    <div id="sidebarOverlay" class="fixed inset-0 bg-black/10 z-40 hidden lg:hidden"></div>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col overflow-hidden bg-gray-50">
        <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-8 shrink-0 z-10 shadow-sm">
            <div class="flex items-center gap-4">
                <button id="openSidebar" class="p-2 lg:hidden rounded-lg hover:bg-gray-100 text-gray-600"><i class="fas fa-bars text-xl"></i></button>
                <h2 id="pageTitle" class="text-xl font-bold text-gray-800 tracking-tight">ëŒ€ì‹œë³´ë“œ</h2>
            </div>
            <div class="flex items-center gap-4">
                <div class="px-4 py-1.5 bg-pink-50 text-pink-600 rounded-full text-xs font-bold border border-pink-100 shadow-sm">
                    âœ¨ <span id="counterLabel">ì „ì²´ ì¸ì›</span>: <span id="totalMembersCount">0</span>ëª…
                </div>
                <button onclick="fetchMembers()" class="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-gray-100 text-gray-400 transition-all border border-gray-100 shadow-sm"><i class="fas fa-sync-alt"></i></button>
            </div>
        </header>

        <div id="contentArea" class="flex-1 overflow-y-auto p-4 lg:p-10 relative bg-gray-50"></div>
    </main>

    <!-- Modals -->
    <!-- Suro Input Modal (Hidden by default, used internally if needed) -->
    <div id="suroModal" class="fixed inset-0 z-[120] flex items-center justify-center bg-black/40 backdrop-blur-md hidden fade-in font-bold">
        <div class="bg-white rounded-[2.5rem] shadow-2xl w-full max-w-4xl overflow-hidden flex flex-col h-[85vh] border border-gray-100">
            <div class="p-6 bg-gray-50 border-b border-gray-100 flex justify-between items-center px-10">
                <div>
                    <h3 class="font-bold text-gray-800 text-lg">ì£¼ê°„ ìˆ˜ë¡œ ì ìˆ˜ ì…ë ¥</h3>
                    <p class="text-[10px] text-gray-400 mt-1">ì´ë²ˆ ì£¼ (ëª©ìš”ì¼~ìˆ˜ìš”ì¼) ë°ì´í„°ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤.</p>
                </div>
                <button onclick="closeModal('suroModal')"><i class="fas fa-times text-gray-400"></i></button>
            </div>
            <div class="p-10 flex-1 overflow-y-auto flex flex-col gap-8">
                 <!-- Deprecated: Using Inline Editing now -->
            </div>
        </div>
    </div>

    <!-- Member Form Modal -->
    <div id="memberModal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/30 backdrop-blur-sm hidden fade-in font-bold">
        <div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-md overflow-hidden border border-gray-100">
            <div class="p-6 bg-pink-50 border-b border-pink-100 flex justify-between items-center">
                <div>
                    <h3 id="modalTitle" class="text-lg font-bold text-pink-700 tracking-tight">ë©¤ë²„ ì •ë³´ ì…ë ¥</h3>
                </div>
                <button onclick="closeModal('memberModal')"><i class="fas fa-times text-gray-400 text-lg"></i></button>
            </div>
            <form id="memberForm" class="p-8 space-y-5">
                <input type="hidden" id="editMemberId">
                <div class="space-y-1">
                    <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">ë‹‰ë„¤ì„</label>
                    <input type="text" id="inputName" class="w-full border border-gray-100 bg-gray-50 rounded-2xl p-3.5 outline-none focus:ring-4 focus:ring-pink-50 text-sm font-bold shadow-inner" required placeholder="ì •í™•í•œ ìºë¦­í„°ëª…">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">ì†Œì†</label>
                        <select id="inputGuild" class="w-full border border-gray-100 bg-gray-50 rounded-2xl p-3.5 text-sm font-bold outline-none" onchange="onGuildSelectChange(this.value)"></select>
                    </div>
                    <div class="space-y-1">
                        <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">ì§ìœ„</label>
                        <select id="inputRole" class="w-full border border-gray-100 bg-gray-50 rounded-2xl p-3.5 text-sm font-bold outline-none"></select>
                    </div>
                </div>
                <div class="space-y-1">
                    <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">ì§ì—…</label>
                    <select id="inputClass" class="w-full border border-gray-100 bg-gray-50 rounded-2xl p-3.5 text-sm font-bold outline-none shadow-inner cursor-pointer">
                        <option value="">ì§ì—…ì„ ì„ íƒí•˜ì„¸ìš”</option>
                    </select>
                </div>
                <div class="flex items-center gap-3 py-1">
                    <input type="checkbox" id="inputIsMain" class="w-5 h-5 text-pink-500 rounded focus:ring-pink-50 shadow-sm cursor-pointer" checked onchange="toggleMainCharInput()">
                    <label for="inputIsMain" class="text-[11px] font-bold text-gray-600 uppercase tracking-tight cursor-pointer">ë³¸ìºë¦­í„°ì…ë‹ˆê¹Œ?</label>
                </div>
                <div id="mainCharInputGroup" class="hidden animate-fade-in space-y-1">
                    <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">ë³¸ìº ë‹‰ë„¤ì„</label>
                    <input type="text" id="inputMainCharName" class="w-full border border-gray-100 bg-gray-50 rounded-2xl p-3.5 text-sm font-bold outline-none shadow-inner" placeholder="ë³¸ìºë¦­ëª… ì…ë ¥ (ìë™ ì§ìœ„ í™•ì¸)" oninput="checkAutoRank(this.value)">
                </div>
                <button type="submit" id="btnSubmitMember" class="w-full bg-gray-900 text-white py-4 rounded-2xl font-bold uppercase text-[10px] tracking-widest hover:bg-black transition-all shadow-xl mt-2">ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥</button>
            </form>
        </div>
    </div>

    <!-- Bulk Import Modal -->
    <div id="bulkModal" class="fixed inset-0 z-[120] flex items-center justify-center bg-black/40 backdrop-blur-md hidden fade-in font-bold">
        <div class="bg-white rounded-[2.5rem] shadow-2xl w-full max-w-4xl overflow-hidden flex flex-col h-[85vh] border border-gray-100">
            <div class="p-6 bg-gray-50 border-b border-gray-100 flex justify-between items-center px-10">
                <h3 class="font-bold text-gray-600 text-sm"><i class="fas fa-file-import mr-2 text-pink-500"></i> ëŒ€ëŸ‰ ëª…ë‹¨ ë°ì´í„° ë“±ë¡</h3>
                <button onclick="closeModal('bulkModal')"><i class="fas fa-times text-gray-400"></i></button>
            </div>
            <div class="p-10 flex-1 overflow-y-auto flex flex-col gap-8">
                <div class="bg-indigo-50 p-6 rounded-3xl border border-indigo-100 flex items-center gap-5 shadow-inner">
                    <div class="text-indigo-500 text-2xl"><i class="fas fa-info-circle"></i></div>
                    <p class="text-xs text-indigo-600 font-bold">ì—‘ì…€ì—ì„œ [ë„ˆêµ´, ëš ì¹´ë¡±, ì—ë°˜] ì²˜ëŸ¼ ë‹‰ë„¤ì„, ê¸¸ë“œëª…, ì§ì—… ìˆœì„œë¡œ ë³µì‚¬í•´ì„œ ë„£ìœ¼ì„¸ìš”.</p>
                </div>
                <div class="flex-1 flex flex-col lg:flex-row gap-8 min-h-0">
                    <div class="flex-1 flex flex-col">
                        <textarea id="bulkInput" oninput="parseBulkInput()" class="w-full flex-1 border border-gray-200 rounded-[2rem] p-6 font-mono text-sm outline-none focus:ring-8 focus:ring-indigo-50 resize-none bg-gray-50 shadow-inner" placeholder="ì´ê³³ì— ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>
                    </div>
                    <div class="flex-1 flex flex-col border border-gray-200 rounded-[2rem] overflow-hidden bg-white shadow-sm">
                        <div class="p-4 bg-gray-50 border-b border-gray-100 font-bold text-[11px] text-gray-500 text-center">ë“±ë¡ ëŒ€ê¸° ëª…ë‹¨</div>
                        <div class="flex-1 overflow-auto no-scrollbar shadow-inner">
                            <table class="w-full text-left text-[11px] whitespace-nowrap font-bold">
                                <thead class="bg-gray-50 text-gray-400 sticky top-0 shadow-sm">
                                    <tr><th class="px-5 py-3 border-b">ìƒíƒœ</th><th class="px-5 py-3 border-b">ë‹‰ë„¤ì„</th><th class="px-5 py-3 border-b">ì†Œì†</th><th class="px-5 py-3 border-b">ì§ì—…</th></tr>
                                </thead>
                                <tbody id="bulkPreviewBody" class="divide-y divide-gray-50"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t border-gray-100 bg-gray-50 flex justify-end gap-3 px-12 items-center">
                <span id="bulkStats" class="text-xs text-gray-500 font-bold mr-auto"></span>
                <button id="btnExecuteBulk" onclick="saveBulkData()" class="px-12 py-3 bg-gray-900 text-white rounded-2xl hover:bg-black font-bold text-xs shadow-xl transition-all disabled:opacity-30">ì…ë ¥í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirm Modal -->
    <div id="deleteModal" class="fixed inset-0 z-[110] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden fade-in font-bold">
        <div class="bg-white rounded-[2.5rem] shadow-2xl w-full max-w-sm p-10 text-center border border-gray-50">
            <div class="w-16 h-16 bg-red-50 text-red-500 rounded-2xl flex items-center justify-center text-2xl mx-auto mb-5 shadow-inner"><i class="fas fa-user-minus"></i></div>
            <p class="text-gray-800 font-bold text-lg mb-6 leading-tight">'<span id="deleteTargetName" class="text-red-500"></span>' ì œê±° í™•ì •</p>
            <div class="space-y-4 text-left mb-8">
                <div class="flex gap-2">
                    <button onclick="setDeleteType('leave')" id="btnLeave" class="flex-1 py-3 rounded-xl font-bold text-xs bg-gray-800 text-white shadow-sm transition-all">ìì§„íƒˆí‡´</button>
                    <button onclick="setDeleteType('kick')" id="btnKick" class="flex-1 py-3 rounded-xl font-bold text-xs bg-gray-100 text-gray-400 transition-all">ì¶”ë°©</button>
                </div>
                <input type="text" id="deleteReason" class="w-full border border-gray-100 bg-gray-50 rounded-xl p-3 text-xs font-bold outline-none shadow-inner" placeholder="ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì´ë ¥ìš©)">
            </div>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="closeModal('deleteModal')" class="py-4 bg-gray-50 rounded-2xl font-bold text-xs text-gray-500 hover:bg-gray-100 transition-all">ì·¨ì†Œ</button>
                <button onclick="confirmDelete()" class="py-4 bg-red-500 text-white rounded-2xl font-bold text-xs shadow-xl hover:bg-red-600 transition-all">ì‚­ì œ í™•ì •</button>
            </div>
        </div>
    </div>

    <!-- Factory Reset Modal -->
    <div id="resetModal" class="fixed inset-0 z-[110] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden fade-in font-bold">
        <div class="bg-white rounded-[3rem] shadow-2xl w-full max-w-md p-12 text-center border border-gray-50">
            <div class="w-20 h-20 bg-red-50 text-red-500 rounded-[2rem] flex items-center justify-center text-4xl mx-auto mb-6 shadow-inner"><i class="fas fa-radiation"></i></div>
            <h3 class="text-2xl font-black text-gray-800 tracking-tight mb-4">ë°ì´í„° ì „ì²´ ì´ˆê¸°í™”</h3>
            <p class="text-xs text-gray-500 mb-8 leading-relaxed">êµ¬ê¸€ ì‹œíŠ¸ì˜ ëª¨ë“  ë°ì´í„°ì™€ ë¡œê·¸ê°€ ì™„ì „íˆ ì§€ì›Œì§‘ë‹ˆë‹¤.<br>ì •ë§ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="closeModal('resetModal')" class="py-4 bg-gray-50 rounded-2xl font-bold text-xs text-gray-500 hover:bg-gray-100 transition-all">ì·¨ì†Œ</button>
                <button onclick="confirmReset()" class="py-4 bg-red-600 text-white rounded-2xl font-bold text-xs shadow-xl hover:bg-red-700 transition-all">ì´ˆê¸°í™” ì§„í–‰</button>
            </div>
        </div>
    </div>

    <script>
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrxEWj0qW3NchPmPbjGfDwMOUcTa9Qe_6AwrIzISLcTohCs-yO_MUPBfSEFvIK_QhV/exec";
        const DEFAULT_SHEET_URL = "https://docs.google.com/spreadsheets/d/1pu_PIJ03omYU00jAmJ5FSvyjs_sqLxAU90_xjfY_yjQ/edit?gid=260394678#gid=260394678";
        const GUILD_START_DATE = new Date('2020-03-17');
        
        const MAPLE_JOBS = [
            "íˆì–´ë¡œ", "ë‹¤í¬ë‚˜ì´íŠ¸", "íŒ”ë¼ë”˜", "ë¶ˆë…", "ì¬ì½œ", "ë¹„ìˆ", "ë³´ìš°ë§ˆìŠ¤í„°", "ì‹ ê¶", "íŒ¨ìŠ¤íŒŒì¸ë”",
            "ë‚˜ì´íŠ¸ë¡œë“œ", "ì„€ë„ì–´", "ë“€ì–¼ë¸”ë ˆì´ë“œ", "ìº¡í‹´", "ë°”ì´í¼", "ìºë…¼ë§ˆìŠ¤í„°",
            "ë¯¸í•˜ì¼", "ì†Œìš¸ë§ˆìŠ¤í„°", "í”Œë ˆì„ìœ„ìë“œ", "ìœˆë“œë¸Œë ˆì´ì»¤", "ë‚˜ì´íŠ¸ì›Œì»¤", "ìŠ¤íŠ¸ë¼ì´ì»¤",
            "ì•„ë€", "ì—ë°˜", "ë£¨ë¯¸ë„ˆìŠ¤", "ë©”ë¥´ì„¸ë°ìŠ¤", "íŒ¬í…€", "ì€ì›”",
            "ë°ëª¬ ìŠ¬ë ˆì´ì–´", "ë°ëª¬ ì–´ë²¤ì ¸", "ë¸”ë˜ìŠ¤í„°", "ë°°í‹€ë©”ì´ì§€", "ì™€ì¼ë“œí—Œí„°", "ë©”ì¹´ë‹‰", "ì œë…¼",
            "ì¹´ì´ì €", "ì¹´ì¸", "ì¹´ë°ë‚˜", "ì—”ì ¤ë¦­ë²„ìŠ¤í„°",
            "ë¼ë¼", "í˜¸ì˜", "ì•„ë¸", "ì¼ë¦¬ì›€", "ì•„í¬", "ì¹¼ë¦¬",
            "ì œë¡œ", "í‚¤ë„¤ì‹œìŠ¤", "ë Œ"
        ];

        const baseRanks = ['ë§ˆì¹´ë¡±', 'ë‹¤ì¿ ì•„ì¦ˆ'];
        const initialGuildRanks = {
            'ëš ì¹´ë¡±': [...baseRanks, 'í¬ë¼ìš´', 'íŒŒë¥´í˜', 'í‹°ë¼ë¯¸ìŠˆ', 'í¬ë¡œì¹¸ìŠˆ', 'ë¡¤ì¼€ì´í¬', 'íŒ¬ì¼€ì´í¬', 'ì™€í”Œ', 'ìŠ¤ì½˜', 'ë°˜ì£½', 'ë°˜ì£½(íœ´ë©´)'],
            'ëš±ì¹´ë¡±': [...baseRanks, 'ëš ì¼€ì´í¬', 'ëš ë¸Œë ˆë“œ', 'ìˆ˜í”Œë ˆ', 'ëš ìŠ¤ì½˜', 'ë°˜ì£½', 'ë°˜ì£½(íœ´ë©´)', 'ì•„ì¸ìŠˆíŒ¨ë„ˆ'],
            'ë°¤ì¹´ë¡±': [...baseRanks, 'ë¶€íŒ¬ì¼€ì´í¬', 'ë¶€ì¼€ì´í¬', 'ì•„ì¸ìŠˆíŒ¨ë„ˆ', 'ë°˜ì£½', 'ë°˜ì£½(íœ´ë©´)'],
            'ë³„ì¹´ë¡±': [...baseRanks, 'ë¶€íŒ¬ì¼€ì´í¬', 'ë¶€ì¼€ì´í¬', 'ì•„ì¸ìŠˆíŒ¨ë„ˆ', 'ë°˜ì£½', 'ë°˜ì£½(íœ´ë©´)'],
            'ë‹¬ì¹´ë¡±': [...baseRanks, 'ë¶€íŒ¬ì¼€ì´í¬', 'ë¶€ì¼€ì´í¬', 'ì•„ì¸ìŠˆíŒ¨ë„ˆ', 'ë°˜ì£½', 'ë°˜ì£½(íœ´ë©´)'],
            'ê¿€ì¹´ë¡±': [...baseRanks, 'ë¶€íŒ¬ì¼€ì´í¬', 'ë¶€ì¼€ì´í¬', 'ì•„ì¸ìŠˆíŒ¨ë„ˆ', 'ë°˜ì£½', 'ë°˜ì£½(íœ´ë©´)']
        };
        
        const appState = {
            activeTab: 'dashboard',
            guilds: [
                { id: 'ddun', name: 'ëš ì¹´ë¡±', type: 'ë©”ì¸ 1ê¸°', color: '#f472b6', icon: 'fa-crown', max: 200 },
                { id: 'ddung', name: 'ëš±ì¹´ë¡±', type: 'ë©”ì¸ 2ê¸°', color: '#fb7185', icon: 'fa-heart', max: 200 },
                { id: 'bam', name: 'ë°¤ì¹´ë¡±', type: 'ë¶€ìº 1ê¸°', color: '#6366f1', icon: 'fa-moon', max: 200 },
                { id: 'byeol', name: 'ë³„ì¹´ë¡±', type: 'ë¶€ìº 2ê¸°', color: '#facc15', icon: 'fa-star', max: 200 },
                { id: 'dal', name: 'ë‹¬ì¹´ë¡±', type: 'ë¶€ìº 3ê¸°', color: '#60a5fa', icon: 'fa-sun', max: 200 },
                { id: 'kkul', name: 'ê¿€ì¹´ë¡±', type: 'ë¶€ìº 4ê¸°', color: '#fbbf24', icon: 'fa-cube', max: 200 },
            ],
            members: [],
            history: [],
            guildRanks: {},
            filters: { guild: 'all', search: '', sortField: 'name', sortOrder: 'asc', page: 1 },
            suroFilters: { guild: 'all', search: '', sortField: 'name', sortOrder: 'asc' }, // ìˆ˜ë¡œ í˜ì´ì§€ìš© í•„í„° ì¶”ê°€
            analysisGuild: 'ëš ì¹´ë¡±', // ë¶„ì„ í˜ì´ì§€ ê¸°ë³¸ ê¸¸ë“œ
            deleteType: 'leave',
            tempSettingsRankGuild: 'ëš ì¹´ë¡±',
            parsedBulkData: [],
            currentSuroInputs: {}, // ì…ë ¥ ì¤‘ì¸ ìˆ˜ë¡œ ì ìˆ˜ ì„ì‹œ ì €ì¥
            isBatchMode: false,
            pendingUpdates: [],
            pendingDeletes: [],
            scriptUrl: localStorage.getItem('macaron_script_url') || APPS_SCRIPT_URL,
            sheetUrl: localStorage.getItem('macaron_sheet_url') || DEFAULT_SHEET_URL
        };

        const savedRanks = localStorage.getItem('macaron_ranks_v24');
        if (savedRanks) {
            appState.guildRanks = JSON.parse(savedRanks);
        } else {
            appState.guilds.forEach(g => {
                appState.guildRanks[g.name] = initialGuildRanks[g.name] ? [...initialGuildRanks[g.name]] : [...initialGuildRanks['ëš ì¹´ë¡±']];
            });
        }
        
        let jobChartInstance = null;
        let analysisChartInstance = null;

        function showMsg(text, type = 'info') {
            const box = document.getElementById('msgBox');
            const icon = document.getElementById('msgIcon');
            const txt = document.getElementById('msgText');
            if(!box || !txt) return;
            txt.innerText = text;
            icon.innerHTML = type === 'success' ? '<i class="fas fa-check-circle text-green-400"></i>' : 
                             type === 'error' ? '<i class="fas fa-exclamation-circle text-red-400"></i>' : 
                             '<i class="fas fa-info-circle text-pink-400"></i>';
            box.classList.add('show');
            setTimeout(() => box.classList.remove('show'), 3500);
        }

        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.remove('force-hide');
                setTimeout(() => {
                    const btn = document.getElementById('forceEnterBtn');
                    if (btn && !overlay.classList.contains('force-hide')) btn.classList.remove('hidden');
                }, 4000);
            } else {
                overlay.classList.add('force-hide');
            }
        }

        function hideOverlay() { showLoading(false); }

        async function fetchMembers() {
            if(!appState.scriptUrl) { router('settings'); hideOverlay(); return; }
            if (appState.isBatchMode) return; 

            showLoading(true);
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 12000);

            try {
                const response = await fetch(appState.scriptUrl, { 
                    method: 'GET', 
                    mode: 'cors',
                    cache: 'no-cache',
                    redirect: 'follow',
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                if (!response.ok) throw new Error(`Status: ${response.status}`);
                
                const json = await response.json();
                if (json.status === "success") {
                    appState.members = json.data.members ? json.data.members.filter(m => m.name && m.name.trim() !== "") : [];
                    appState.history = json.data.history || [];
                    appState.suroHeaders = json.data.suroHeaders || [];

                    appState.members.forEach(m => {
                        if (m.joinDate && !m.unicode) m.unicode = m.joinDate; 
                         if (m.suro) {
                            Object.keys(m.suro).forEach(key => {
                                m[`suro_${key}`] = m.suro[key];
                            });
                        }
                    });

                    // ì´ˆê¸°í™”: ìˆ˜ë¡œ ì…ë ¥ê°’ ë³´ì¡´ìš© ê°ì²´ ì¤€ë¹„
                    const period = getSuroPeriodHeader();
                    appState.members.forEach(m => {
                         if (m.suro && m.suro[period]) {
                             appState.currentSuroInputs[m.name] = m.suro[period];
                         }
                    });

                    const countEl = document.getElementById('totalMembersCount');
                    if(countEl) countEl.innerText = appState.members.length;
                    
                    // í˜„ì¬ íƒ­ ë¦¬ë¡œë“œ
                    if (appState.activeTab === 'members') updateMemberTable();
                    else if (appState.activeTab === 'suro') updateSuroTable();
                    else if (appState.activeTab === 'analysis') renderAnalysis(document.getElementById('contentArea'), appState.analysisGuild);
                    else router(appState.activeTab);
                    showLoading(false);
                } else {
                    throw new Error(json.message || "ì„œë²„ ë¡œì§ ì—ëŸ¬");
                }
            } catch (e) {
                clearTimeout(timeoutId);
                console.error("Fetch Error:", e);
                showMsg("ì„œë²„ ë™ê¸°í™” ì‹¤íŒ¨. GAS ë°°í¬ ê¶Œí•œì„ [ëª¨ë“  ì‚¬ìš©ì]ë¡œ ë³€ê²½í•´ì£¼ì„¸ìš”.", "error");
                document.getElementById('forceEnterBtn')?.classList.remove('hidden');
            }
        }

        async function sendAction(action, data, btnId) {
            if(!appState.scriptUrl) return showMsg("ì—°ë™ ì£¼ì†Œê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.", "error");
            const btn = btnId ? document.getElementById(btnId) : null;
            if (btn) btn.classList.add('btn-loading');
            showMsg("ì„œë²„ì— ë°ì´í„°ë¥¼ ì „ì†¡ ì¤‘ì…ë‹ˆë‹¤...", "info");
            
            try {
                const response = await fetch(appState.scriptUrl, {
                    method: 'POST',
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify({ action, data }),
                    redirect: 'follow'
                });
                
                let result;
                try {
                    result = await response.json();
                } catch(e) {
                    result = { status: "success" }; 
                }

                if (result.status === "success") {
                    if (action === 'update' || action === 'add' || action === 'delete' || action === 'save_suro') {
                         showMsg("ì„œë²„ ë°˜ì˜ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!", "success");
                         await fetchMembers();
                    }
                    return true;
                } else {
                    showMsg(result.message || "ì²˜ë¦¬ ì‹¤íŒ¨", "error");
                    return false;
                }
            } catch (e) {
                console.error("Post Action Error:", e);
                showMsg("ì„œë²„ ì „ì†¡ ì‹¤íŒ¨! ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.", "error");
                return false;
            } finally {
                if (btn) btn.classList.remove('btn-loading');
            }
        }

        function router(tab) {
            appState.activeTab = tab;
            const content = document.getElementById('contentArea');
            if (!content) return;
            content.innerHTML = '';
            document.querySelectorAll('.nav-item').forEach(el => {
                if(el.dataset.target === tab) {
                    el.classList.add('bg-pink-50', 'text-pink-600');
                    el.classList.remove('text-gray-600');
                } else {
                    el.classList.remove('bg-pink-50', 'text-pink-600');
                    el.classList.add('text-gray-600');
                }
            });

            if (tab === 'suro') {
                appState.suroFilters = { guild: 'all', search: '', sortField: 'name', sortOrder: 'asc' };
            }

            const titles = { dashboard: 'ê¸¸ë“œ í˜„í™©íŒ', members: 'ê¸¸ë“œì› ê´€ë¦¬', sheet: 'ì‹œíŠ¸ ë³´ê¸°', history: 'ìš´ì˜ ì´ë ¥', settings: 'ì‹œìŠ¤í…œ ì„¤ì •', suro: 'ìˆ˜ë¡œ ì ìˆ˜ ê´€ë¦¬' };
            document.getElementById('pageTitle').innerText = titles[tab] || '';

            if (tab === 'dashboard') renderDashboard(content);
            else if (tab === 'members') renderMembers(content);
            else if (tab === 'suro') renderSuro(content);
            else if (tab === 'analysis') renderAnalysis(content, 'ëš ì¹´ë¡±');
            else if (tab === 'sheet') renderSheet(content);
            else if (tab === 'history') renderHistory(content);
            else if (tab === 'settings') renderSettings(content);
        }

        function getSuroPeriodHeader() {
            const now = new Date();
            const day = now.getDay();
            let diff = day - 4; 
            if (diff < 0) diff += 7;
            const startDate = new Date(now);
            startDate.setDate(now.getDate() - diff);
            // ì§€ë‚œì£¼ ê³„ì‚°
            startDate.setDate(startDate.getDate() - 7);
            
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6);
            
            const f = (d) => {
                const yy = d.getFullYear().toString().slice(-2);
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                const dd = String(d.getDate()).padStart(2, '0');
                return `${yy}-${mm}-${dd}`;
            };
            return `${f(startDate)}(ëª©) ~ ${f(endDate)}(ìˆ˜) ìˆ˜ë¡œ ì ìˆ˜`;
        }

        // --- Render Analysis Logic ---
        function renderAnalysis(container, defaultGuild = 'ëš ì¹´ë¡±') {
            appState.analysisGuild = defaultGuild;
            
            const targetMembers = appState.members.filter(m => m.guild === defaultGuild);
            
            // ìµœê·¼ 2ê°œ ì£¼ì°¨ í—¤ë” ê°€ì ¸ì˜¤ê¸° (ë¹„êµìš©)
            let lastHeader = "";
            let prevHeader = "";
            
            if (appState.suroHeaders && appState.suroHeaders.length > 0) {
                lastHeader = appState.suroHeaders[appState.suroHeaders.length - 1];
                if (appState.suroHeaders.length >= 2) {
                    prevHeader = appState.suroHeaders[appState.suroHeaders.length - 2];
                }
            }

            // ì´ë²ˆ ì£¼ ì´ì  ê³„ì‚°
            const totalScore = targetMembers.reduce((sum, m) => sum + (Number(m.suro && m.suro[lastHeader] ? m.suro[lastHeader] : 0)), 0);
            
            // í…Œì´ë¸” ë°ì´í„° ìƒì„±
            const tableData = targetMembers.map(m => {
                const current = Number(m.suro && m.suro[lastHeader] ? m.suro[lastHeader] : 0);
                const prev = Number(m.suro && m.suro[prevHeader] ? m.suro[prevHeader] : 0);
                const diff = current - prev;
                const percent = prev > 0 ? ((diff / prev) * 100).toFixed(1) : 0;
                
                return { name: m.name, current, prev, diff, percent };
            }).sort((a,b) => b.current - a.current);

            // íƒ­ ë²„íŠ¼ ìƒì„±
            let tabsHtml = '';
            appState.guilds.forEach(g => {
                const activeClass = g.name === defaultGuild ? 'bg-pink-500 text-white shadow-lg' : 'bg-gray-50 text-gray-500 hover:bg-gray-100';
                tabsHtml += `<button onclick="router('analysis'); renderAnalysis(document.getElementById('contentArea'), '${g.name}')" class="px-6 py-3 rounded-2xl text-xs font-bold transition-all ${activeClass}">${g.name}</button>`;
            });

            // í…Œì´ë¸” HTML ìƒì„±
            let tableRows = tableData.map((d, i) => {
                const diffClass = d.diff > 0 ? 'text-red-500 trend-up' : (d.diff < 0 ? 'text-blue-500 trend-down' : 'text-gray-400');
                const diffIcon = d.diff > 0 ? 'â–²' : (d.diff < 0 ? 'â–¼' : '-');
                
                return `
                <tr class="hover:bg-gray-50 border-b border-gray-50 transition-colors">
                    <td class="p-4 text-center text-gray-400 font-bold text-xs">${i+1}</td>
                    <td class="p-4 font-bold text-gray-700">${d.name}</td>
                    <td class="p-4 text-right font-bold text-gray-800">${d.current.toLocaleString()}</td>
                    <td class="p-4 text-right font-bold text-xs ${diffClass}">
                        ${diffIcon} ${Math.abs(d.diff).toLocaleString()} 
                        <span class="text-[9px] opacity-70 ml-1">(${d.diff > 0 ? '+' : ''}${d.percent}%)</span>
                    </td>
                </tr>`;
            }).join('');

            container.innerHTML = `
                <div class="flex flex-col gap-8 fade-in h-full">
                    <div class="bg-white p-8 rounded-[2.5rem] border border-gray-100 shadow-sm">
                        <div class="flex flex-col md:flex-row justify-between items-center gap-6 mb-6">
                            <h2 class="text-xl font-bold text-gray-800 tracking-tight">ìˆ˜ë¡œ ì ìˆ˜ ë¶„ì„</h2>
                            <div class="flex gap-2 overflow-x-auto pb-2 no-scrollbar w-full md:w-auto">
                                ${tabsHtml}
                            </div>
                        </div>
                        <div class="bg-gray-50 rounded-3xl p-8 text-center border border-gray-100">
                             <p class="text-xs text-gray-400 font-bold uppercase tracking-widest mb-2">${defaultGuild} ì´ë²ˆ ì£¼ ì´ì </p>
                             <h1 class="text-4xl font-black text-gray-800 tracking-tighter">${totalScore.toLocaleString()}</h1>
                             <p class="text-[10px] text-gray-400 mt-2 font-bold">${lastHeader} ê¸°ì¤€</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 flex-1 min-h-0">
                        <!-- ì°¨íŠ¸ ì˜ì—­ -->
                        <div class="lg:col-span-1 bg-white p-8 rounded-[2.5rem] border border-gray-100 shadow-sm flex flex-col">
                            <h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-6">ì£¼ê°„ ì´ì  ì¶”ì´</h3>
                            <div class="flex-1 relative" style="min-height: 200px;">
                                <canvas id="analysisChart"></canvas>
                            </div>
                        </div>

                        <!-- í…Œì´ë¸” ì˜ì—­ -->
                        <div class="lg:col-span-2 bg-white rounded-[2.5rem] border border-gray-100 shadow-sm flex flex-col overflow-hidden">
                            <div class="p-6 border-b border-gray-50">
                                <h3 class="text-sm font-bold text-gray-800">ê°œì¸ë³„ ì ìˆ˜ í˜„í™©</h3>
                            </div>
                            <div class="flex-1 overflow-y-auto p-0">
                                <table class="w-full text-left">
                                    <thead class="bg-gray-50 text-gray-500 text-[10px] font-bold uppercase sticky top-0">
                                        <tr>
                                            <th class="p-4 text-center w-16">Rank</th>
                                            <th class="p-4">Nickname</th>
                                            <th class="p-4 text-right">Score</th>
                                            <th class="p-4 text-right">Change</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-50">
                                        ${tableRows}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // ì°¨íŠ¸ ê·¸ë¦¬ê¸°
            updateAnalysisChart(defaultGuild);
        }

        function updateAnalysisChart(guildName) {
            const ctx = document.getElementById('analysisChart');
            if(!ctx) return;
            
            // ìµœê·¼ 5ì£¼ ë°ì´í„° ì¶”ì¶œ
            const headers = appState.suroHeaders.slice(-5);
            const data = headers.map(h => {
                return appState.members
                    .filter(m => m.guild === guildName)
                    .reduce((sum, m) => sum + (Number(m.suro && m.suro[h] ? m.suro[h] : 0)), 0);
            });

            // ë‚ ì§œ ë¼ë²¨ ê°„ì†Œí™” (MM-DD)
            const labels = headers.map(h => h.substring(3, 8));

            if(analysisChartInstance) analysisChartInstance.destroy();

            analysisChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ì´ì ',
                        data: data,
                        borderColor: '#ec4899',
                        backgroundColor: 'rgba(236, 72, 153, 0.1)',
                        borderWidth: 2,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#ec4899',
                        pointRadius: 4,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { display: false },
                        x: { grid: { display: false }, ticks: { font: { size: 10 } } }
                    }
                }
            });
        }

        // ëŒ€ì‹œë³´ë“œ í—¬í¼ í•¨ìˆ˜
        function calculateTotalSuro(guildName) {
            const lastHeader = appState.suroHeaders[appState.suroHeaders.length - 1];
            if (!lastHeader) return 0;
            return appState.members
                .filter(m => m.guild === guildName)
                .reduce((sum, m) => sum + (Number(m.suro && m.suro[lastHeader] ? m.suro[lastHeader] : 0)), 0);
        }

        function renderDashboard(container) {
            const anniv = getAnniversaryInfo();
            const wrap = document.createElement('div');
            
            // ëš ì¹´ë¡±, ëš±ì¹´ë¡± ì´ì  ê³„ì‚°
            const ddunTotal = calculateTotalSuro('ëš ì¹´ë¡±');
            const ddungTotal = calculateTotalSuro('ëš±ì¹´ë¡±');

            const topSection = document.createElement('div');
            topSection.className = "grid grid-cols-1 xl:grid-cols-2 gap-8 mb-8 fade-in";
            topSection.innerHTML = `
                <div class="flex flex-col gap-6 h-[450px]">
                    <!-- ìˆ˜ë¡œ ì´ì  ì¹´ë“œ -->
                    <div class="flex gap-6 h-1/2">
                        <div onclick="router('analysis'); renderAnalysis(document.getElementById('contentArea'), 'ëš ì¹´ë¡±')" class="flex-1 bg-gradient-to-br from-pink-500 to-rose-500 rounded-[2.5rem] p-8 shadow-lg text-white cursor-pointer hover:scale-[1.02] transition-transform flex flex-col justify-between relative overflow-hidden">
                            <div class="absolute top-0 right-0 p-6 opacity-20 text-6xl"><i class="fas fa-crown"></i></div>
                            <h3 class="text-sm font-bold opacity-80 uppercase tracking-widest">ëš ì¹´ë¡± ìˆ˜ë¡œ ì´ì </h3>
                            <div>
                                <p class="text-3xl font-black tracking-tighter">${ddunTotal.toLocaleString()}</p>
                                <p class="text-[10px] font-bold mt-1 opacity-70">í´ë¦­í•˜ì—¬ ìƒì„¸ ë¶„ì„ ë³´ê¸° &rarr;</p>
                            </div>
                        </div>
                        <div onclick="router('analysis'); renderAnalysis(document.getElementById('contentArea'), 'ëš±ì¹´ë¡±')" class="flex-1 bg-white border border-gray-100 rounded-[2.5rem] p-8 shadow-sm text-gray-800 cursor-pointer hover:border-pink-200 transition-all flex flex-col justify-between">
                             <h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest">ëš±ì¹´ë¡± ìˆ˜ë¡œ ì´ì </h3>
                             <div>
                                <p class="text-3xl font-black tracking-tighter">${ddungTotal.toLocaleString()}</p>
                                <p class="text-[10px] text-pink-400 font-bold mt-1">í´ë¦­í•˜ì—¬ ìƒì„¸ ë¶„ì„ ë³´ê¸° &rarr;</p>
                            </div>
                        </div>
                    </div>

                    <!-- ë‹¬ë ¥ -->
                    <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-gray-100 flex flex-col justify-between h-1/2">
                         <div class="flex justify-between items-center mb-2">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">ğŸ“…</span>
                                <div>
                                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest">Guild Calendar</h3>
                                </div>
                            </div>
                            <div class="text-right">
                                 <div class="text-[10px] font-bold text-gray-400 bg-gray-50 px-2 py-0.5 rounded-lg inline-block">D+${anniv.totalDays}</div>
                            </div>
                         </div>
                         ${renderCalendar()}
                    </div>
                </div>
                
                <div class="bg-white p-10 rounded-[3rem] shadow-sm border border-gray-100 flex flex-col h-[450px]">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest">ì§ì—… ë¶„í¬ë„ (Job Stats)</h3>
                        <select onchange="updateJobChart(this.value)" class="border-none bg-gray-50 rounded-xl px-3 py-1.5 text-xs font-bold text-gray-600 outline-none cursor-pointer hover:bg-gray-100 transition-all text-right">
                            <option value="all">ì „ì²´ ê¸¸ë“œ í•©ê³„</option>
                            ${appState.guilds.map(g => `<option value="${g.name}">${g.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="flex-1 overflow-y-auto pr-2 relative no-scrollbar">
                        <div style="min-height: 300px;">
                            <canvas id="jobChart"></canvas>
                        </div>
                    </div>
                </div>
            `;
            
            const bottomSection = document.createElement('div');
            bottomSection.className = "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 fade-in";
            
            appState.guilds.forEach(g => {
                const count = appState.members.filter(m => m.guild === g.name).length;
                const pct = g.max > 0 ? Math.min((count / g.max) * 100, 100) : 0;
                
                bottomSection.innerHTML += `
                    <div class="bg-white p-8 rounded-[2.5rem] border border-gray-100 shadow-sm hover:shadow-xl transition-all cursor-pointer group" onclick="filterByGuild('${g.name}')">
                        <div class="flex justify-between items-start mb-6">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-gray-50 rounded-2xl flex items-center justify-center text-gray-400 group-hover:bg-pink-50 group-hover:text-pink-500 transition-colors">
                                    <i class="fas ${g.icon}"></i>
                                </div>
                                <div>
                                    <span class="block font-bold text-lg text-gray-800 leading-none group-hover:text-pink-500 transition-colors">${g.name}</span>
                                    <span class="text-[10px] text-gray-400 font-bold">${g.type}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-between text-[10px] mb-2 text-gray-400 font-bold">
                            <span>ì ìœ ìœ¨</span><span class="text-gray-800">${count} / ${g.max}</span>
                        </div>
                        <div class="w-full bg-gray-50 rounded-full h-1.5 overflow-hidden">
                            <div class="h-full bg-pink-500 rounded-full transition-all duration-1000" style="width:${pct}%"></div>
                        </div>
                    </div>
                `;
            });

            container.appendChild(topSection);
            container.appendChild(bottomSection);

            setTimeout(() => window.updateJobChart('all'), 0);
        }

        // --- Suro Logic ---
        function renderSuro(container) {
            // í•„í„° íˆ´ë°” ìƒì„± (ê¸¸ë“œì› ê´€ë¦¬ì™€ ë™ì¼í•œ ìŠ¤íƒ€ì¼)
            const toolbar = document.createElement('div');
            toolbar.className = "bg-white p-10 rounded-t-[3rem] border border-gray-100 space-y-8 shadow-sm fade-in";
            
            let btns = `<button onclick="filterSuroGuild('all')" class="shrink-0 whitespace-nowrap px-8 py-3 rounded-2xl text-xs font-bold transition-all ${appState.suroFilters.guild === 'all' ? 'bg-gray-800 text-white shadow-xl' : 'bg-gray-50 text-gray-500 hover:bg-gray-100'}">All</button>`;
            appState.guilds.forEach(g => {
                btns += `<button onclick="filterSuroGuild('${g.name}')" class="shrink-0 whitespace-nowrap px-8 py-3 rounded-2xl text-xs font-bold transition-all ml-3 ${appState.suroFilters.guild === g.name ? 'bg-pink-500 text-white shadow-xl shadow-pink-100' : 'bg-gray-50 text-gray-500 hover:bg-gray-100'}">${g.name}</button>`;
            });

            toolbar.innerHTML = `
                <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                    <div class="flex overflow-x-auto pb-2 no-scrollbar w-full md:w-auto gap-3">
                        ${btns}
                    </div>
                    <button onclick="saveSuroInputs()" class="shrink-0 px-8 py-3.5 bg-blue-500 text-white rounded-2xl text-xs font-bold shadow-xl hover:bg-blue-600 transition-all"><i class="fas fa-save mr-2"></i> ì ìˆ˜ ì €ì¥</button>
                </div>
                <div class="relative"><i class="fas fa-search absolute left-6 top-1/2 -translate-y-1/2 text-gray-400 text-sm"></i><input type="text" oninput="filterSuroSearch(this.value)" value="${appState.suroFilters.search}" class="w-full pl-16 pr-8 py-4 bg-gray-50 border border-gray-100 rounded-[2rem] outline-none focus:ring-4 focus:ring-blue-50 font-bold text-sm shadow-inner" placeholder="ë‹‰ë„¤ì„ ê²€ìƒ‰"></div>
            `;
            container.appendChild(toolbar);

            const tableWrap = document.createElement('div');
            tableWrap.id = 'suroTableContainer';
            tableWrap.className = "bg-white rounded-b-[3rem] border border-gray-100 overflow-hidden shadow-sm fade-in h-[600px] flex flex-col";
            container.appendChild(tableWrap);
            
            updateSuroTable();
        }

        function filterSuroGuild(g) { appState.suroFilters.guild = g; updateSuroTable(); }
        function filterSuroSearch(v) { appState.suroFilters.search = v; updateSuroTable(); }
        function handleSuroSort(field) {
            if (appState.suroFilters.sortField === field) {
                appState.suroFilters.sortOrder = appState.suroFilters.sortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                appState.suroFilters.sortField = field;
                appState.suroFilters.sortOrder = 'asc';
            }
            updateSuroTable();
        }

        function updateSuroTable() {
            const container = document.getElementById('suroTableContainer');
            if(!container) return;

            const period = getSuroPeriodHeader();
            
            let prevWeekHeader = "";
            let prevWeekScoreMap = {};
            
            if (appState.suroHeaders && appState.suroHeaders.length > 0) {
                 const lastHeader = appState.suroHeaders[appState.suroHeaders.length - 1];
                 if (lastHeader !== period) {
                     prevWeekHeader = lastHeader;
                 } else if (appState.suroHeaders.length >= 2) {
                     prevWeekHeader = appState.suroHeaders[appState.suroHeaders.length - 2];
                 }
            }

            if (prevWeekHeader) {
                appState.members.forEach(m => {
                    if (m.suro && m.suro[prevWeekHeader]) {
                        prevWeekScoreMap[m.name] = m.suro[prevWeekHeader];
                    }
                });
            }

            const term = appState.suroFilters.search.toLowerCase();
            const membersToInput = appState.members.filter(m => {
                const gMatch = appState.suroFilters.guild === 'all' || m.guild === appState.suroFilters.guild;
                const sMatch = m.name.toLowerCase().includes(term);
                return gMatch && sMatch;
            });

            membersToInput.sort((a, b) => {
                let vA, vB;
                if (appState.suroFilters.sortField === 'score') {
                    vA = Number(appState.currentSuroInputs[a.name] || (a.suro && a.suro[period]) || 0);
                    vB = Number(appState.currentSuroInputs[b.name] || (b.suro && b.suro[period]) || 0);
                } else if (appState.suroFilters.sortField === 'prevScore') {
                    vA = Number(prevWeekScoreMap[a.name] || 0);
                    vB = Number(prevWeekScoreMap[b.name] || 0);
                } else {
                    vA = a[appState.suroFilters.sortField] || '';
                    vB = b[appState.suroFilters.sortField] || '';
                    // ìœ ë‹ˆì½”ë“œ ë‹¨ìˆœ ë¹„êµ
                    if (vA < vB) return appState.suroFilters.sortOrder === 'asc' ? -1 : 1;
                    if (vA > vB) return appState.suroFilters.sortOrder === 'asc' ? 1 : -1;
                    return 0;
                }
                return appState.suroFilters.sortOrder === 'asc' ? vA - vB : vB - vA;
            });

            const getSortIcon = (f) => {
                if (appState.suroFilters.sortField !== f) return '<i class="fas fa-sort ml-1 opacity-30 text-[9px]"></i>';
                return appState.suroFilters.sortOrder === 'asc' ? '<i class="fas fa-sort-up ml-1 text-blue-500 text-[10px]"></i>' : '<i class="fas fa-sort-down ml-1 text-blue-500 text-[10px]"></i>';
            };

            let tableRows = membersToInput.map((m, idx) => {
                const prevScore = prevWeekScoreMap[m.name] || 0;
                const currentScore = appState.currentSuroInputs[m.name] !== undefined ? appState.currentSuroInputs[m.name] : ((m.suro && m.suro[period]) ? m.suro[period] : '');
                
                return `
                <tr class="hover:bg-blue-50/30 transition-colors border-b border-gray-100 group">
                    <td class="p-4 font-bold text-gray-700">${m.name}</td>
                    <td class="p-4 text-xs text-gray-500 font-bold">${m.guild}</td>
                    <td class="p-4 text-right font-mono text-gray-400 text-xs font-bold">${prevScore > 0 ? Number(prevScore).toLocaleString() : '-'}</td>
                    <td class="p-3">
                        <input type="number" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-2.5 text-right font-bold text-gray-800 outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white transition-all suro-input shadow-inner" 
                               data-name="${m.name}" 
                               value="${currentScore}" 
                               placeholder="ì ìˆ˜"
                               oninput="handleSuroInput(this)"
                               onkeydown="handleSuroEnter(event, ${idx})">
                    </td>
                </tr>`;
            }).join('');

            container.innerHTML = `
                <div class="overflow-y-auto flex-1 p-0">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 text-gray-500 text-[10px] font-bold uppercase sticky top-0 z-10 border-b border-gray-100 shadow-sm">
                            <tr>
                                <th class="p-4 cursor-pointer hover:bg-gray-100" onclick="handleSuroSort('name')">ë‹‰ë„¤ì„ ${getSortIcon('name')}</th>
                                <th class="p-4 cursor-pointer hover:bg-gray-100" onclick="handleSuroSort('guild')">ì†Œì† ${getSortIcon('guild')}</th>
                                <th class="p-4 text-right cursor-pointer hover:bg-gray-100" onclick="handleSuroSort('prevScore')">ì§€ë‚œì£¼ ì ìˆ˜ ${getSortIcon('prevScore')}</th>
                                <th class="p-4 text-right w-48 cursor-pointer hover:bg-gray-100" onclick="handleSuroSort('score')">ì´ë²ˆì£¼ ì ìˆ˜ ${getSortIcon('score')}</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-50">
                            ${tableRows.length > 0 ? tableRows : '<tr><td colspan="4" class="p-10 text-center text-gray-300 font-bold italic">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>'}
                        </tbody>
                    </table>
                </div>
            `;
        }

        window.handleSuroInput = function(el) {
            const name = el.dataset.name;
            const val = el.value;
            appState.currentSuroInputs[name] = val; // ìƒíƒœ ì €ì¥
        };

        window.handleSuroEnter = function(e, idx) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const inputs = document.querySelectorAll('.suro-input');
                if (idx + 1 < inputs.length) {
                    inputs[idx + 1].focus();
                }
            }
        };

        window.saveSuroInputs = async function() {
            const data = [];
            let count = 0;
            
            appState.members.forEach(m => {
                const val = appState.currentSuroInputs[m.name];
                if (val !== undefined && val !== "") {
                    data.push({ name: m.name, score: val });
                    count++;
                }
            });

            if (count === 0) return alert("ì…ë ¥ëœ ì ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.");
            if (!confirm(`${count}ëª…ì˜ ìˆ˜ë¡œ ì ìˆ˜ë¥¼ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            await sendAction('save_suro', data);
        };
        
        function getAnniversaryInfo() {
            const now = new Date();
            const diff = now - GUILD_START_DATE;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const years = Math.floor(days / 365);
            const remainingDays = days % 365;
            return { totalDays: days, years: years, remainingDays: remainingDays };
        }

        function renderCalendar() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const today = now.getDate();
            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();
            
            const monthNames = ["1ì›”", "2ì›”", "3ì›”", "4ì›”", "5ì›”", "6ì›”", "7ì›”", "8ì›”", "9ì›”", "10ì›”", "11ì›”", "12ì›”"];
            
            let html = `
                <div class="mb-4 flex justify-between items-end">
                    <h4 class="text-xl font-bold text-gray-800">${monthNames[month]} <span class="text-gray-400 text-sm">${year}</span></h4>
                </div>
                <div class="calendar-grid">
                    <div class="calendar-head text-red-400">ì¼</div>
                    <div class="calendar-head">ì›”</div>
                    <div class="calendar-head">í™”</div>
                    <div class="calendar-head">ìˆ˜</div>
                    <div class="calendar-head text-pink-500">ëª©</div>
                    <div class="calendar-head">ê¸ˆ</div>
                    <div class="calendar-head text-blue-400">í† </div>
            `;

            for(let i=0; i<firstDay; i++) html += `<div></div>`;
            
            for(let d=1; d<=lastDate; d++) {
                const date = new Date(year, month, d);
                const dayOfWeek = date.getDay();
                let classes = "calendar-day text-gray-600";
                let content = d;
                
                if (dayOfWeek === 4) {
                    classes += " thursday"; // ëª©ìš”ì¼ ê°•ì¡°
                    content = `<span class="relative z-10">${d}</span><i class="fas fa-sync-alt absolute top-0.5 right-1 text-[8px] text-pink-300 opacity-50"></i>`;
                }
                if (d === today) classes += " today";
                
                html += `<div class="${classes}">${content}</div>`;
            }
            html += `</div>`;
            return html;
        }

        window.updateJobChart = function(targetGuild) {
            const ctx = document.getElementById('jobChart');
            if(!ctx) return;
            
            let targetMembers = appState.members;
            if(targetGuild !== 'all') {
                targetMembers = appState.members.filter(m => m.guild === targetGuild);
            }

            const jobCounts = {};
            targetMembers.forEach(m => {
                const job = (m.class && m.class.trim()) ? m.class : 'ë¯¸ì„¤ì •';
                jobCounts[job] = (jobCounts[job] || 0) + 1;
            });
            
            const sortedJobs = Object.entries(jobCounts).sort((a,b) => b[1] - a[1]);
            const labels = sortedJobs.map(j => j[0]);
            const data = sortedJobs.map(j => j[1]);

            const minHeight = 300;
            const dynamicHeight = Math.max(minHeight, labels.length * 25);
            const chartContainer = ctx.parentElement;
            chartContainer.style.height = dynamicHeight + 'px';

            if(jobChartInstance) jobChartInstance.destroy();
            
            jobChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{ 
                        label: 'ì¸ì› ìˆ˜',
                        data: data, 
                        backgroundColor: '#f472b6',
                        borderRadius: 4,
                        barThickness: 12,
                        hoverBackgroundColor: '#ec4899'
                    }]
                },
                options: { 
                    indexAxis: 'y',
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleFont: { family: "'Noto Sans KR', sans-serif", size: 12 },
                            bodyFont: { family: "'Noto Sans KR', sans-serif", size: 12 },
                            padding: 10,
                            cornerRadius: 8,
                            displayColors: false,
                            callbacks: {
                                label: function(context) { return context.parsed.x + 'ëª…'; }
                            }
                        }
                    },
                    scales: {
                        x: { 
                            beginAtZero: true, 
                            grid: { display: false, drawBorder: false },
                            ticks: { font: { size: 10 }, color: '#9ca3af', precision: 0 }
                        },
                        y: { 
                            grid: { display: false, drawBorder: false }, 
                            ticks: { 
                                font: { family: "'Noto Sans KR', sans-serif", size: 11, weight: 'bold' },
                                color: '#4b5563',
                                autoSkip: false
                            } 
                        }
                    },
                    animation: { duration: 500 }
                }
            });
        };

        function renderDashboard(container) {
            const anniv = getAnniversaryInfo();
            const wrap = document.createElement('div');
            
            const topSection = document.createElement('div');
            topSection.className = "grid grid-cols-1 xl:grid-cols-2 gap-8 mb-8 fade-in";
            topSection.innerHTML = `
                <div class="bg-white p-10 rounded-[3rem] shadow-sm border border-gray-100 flex flex-col justify-between h-[450px]">
                     <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">ğŸ“…</span>
                            <div>
                                <h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest">Guild Calendar</h3>
                                <p class="text-[10px] text-pink-400 font-bold">ëª©ìš”ì¼ì€ ì£¼ê°„ ì´ˆê¸°í™”!</p>
                            </div>
                        </div>
                        <div class="text-right">
                             <div class="text-2xl font-black text-gray-800 tracking-tight">D+${anniv.totalDays}</div>
                             <div class="text-[10px] font-bold text-gray-400 bg-gray-100 px-2 py-0.5 rounded-lg inline-block">ìƒì„±ëœ ì§€ ${anniv.years}ë…„ ${anniv.remainingDays}ì¼ ì§€ë‚¨</div>
                        </div>
                     </div>
                     ${renderCalendar()}
                </div>
                
                <div class="bg-white p-10 rounded-[3rem] shadow-sm border border-gray-100 flex flex-col h-[450px]">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest">ì§ì—… ë¶„í¬ë„ (Job Stats)</h3>
                        <select onchange="updateJobChart(this.value)" class="border-none bg-gray-50 rounded-xl px-3 py-1.5 text-xs font-bold text-gray-600 outline-none cursor-pointer hover:bg-gray-100 transition-all text-right">
                            <option value="all">ì „ì²´ ê¸¸ë“œ í•©ê³„</option>
                            ${appState.guilds.map(g => `<option value="${g.name}">${g.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="flex-1 overflow-y-auto pr-2 relative no-scrollbar">
                        <div style="min-height: 300px;">
                            <canvas id="jobChart"></canvas>
                        </div>
                    </div>
                </div>
            `;
            
            const bottomSection = document.createElement('div');
            bottomSection.className = "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 fade-in";
            
            appState.guilds.forEach(g => {
                const count = appState.members.filter(m => m.guild === g.name).length;
                const pct = g.max > 0 ? Math.min((count / g.max) * 100, 100) : 0;
                
                bottomSection.innerHTML += `
                    <div class="bg-white p-8 rounded-[2.5rem] border border-gray-100 shadow-sm hover:shadow-xl transition-all cursor-pointer group" onclick="filterByGuild('${g.name}')">
                        <div class="flex justify-between items-start mb-6">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-gray-50 rounded-2xl flex items-center justify-center text-gray-400 group-hover:bg-pink-50 group-hover:text-pink-500 transition-colors">
                                    <i class="fas ${g.icon}"></i>
                                </div>
                                <div>
                                    <span class="block font-bold text-lg text-gray-800 leading-none group-hover:text-pink-500 transition-colors">${g.name}</span>
                                    <span class="text-[10px] text-gray-400 font-bold">${g.type}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-between text-[10px] mb-2 text-gray-400 font-bold">
                            <span>ì ìœ ìœ¨</span><span class="text-gray-800">${count} / ${g.max}</span>
                        </div>
                        <div class="w-full bg-gray-50 rounded-full h-1.5 overflow-hidden">
                            <div class="h-full bg-pink-500 rounded-full transition-all duration-1000" style="width:${pct}%"></div>
                        </div>
                    </div>
                `;
            });

            container.appendChild(topSection);
            container.appendChild(bottomSection);

            setTimeout(() => window.updateJobChart('all'), 0);
        }

        function toggleBatchMode() {
            appState.isBatchMode = !appState.isBatchMode;
            if(!appState.isBatchMode) {
                if((appState.pendingUpdates.length > 0 || appState.pendingDeletes.length > 0) && !confirm("ì €ì¥í•˜ì§€ ì•Šì€ ë³€ê²½ì‚¬í•­ì´ ì‚¬ë¼ì§‘ë‹ˆë‹¤. ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    appState.isBatchMode = true; 
                    return;
                }
                appState.pendingUpdates = [];
                appState.pendingDeletes = [];
                fetchMembers();
            } else {
                router('members'); 
                showMsg("ìˆ˜ì • ëª¨ë“œê°€ ì¼œì¡ŒìŠµë‹ˆë‹¤. ë³€ê²½ í›„ [ë³€ê²½ì‚¬í•­ ì €ì¥]ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.", "info");
            }
        }

        async function saveBatchChanges() {
            if(appState.pendingUpdates.length === 0 && appState.pendingDeletes.length === 0) {
                showMsg("ë³€ê²½ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.", "info");
                return;
            }

            if(!confirm(`ìˆ˜ì •: ${appState.pendingUpdates.length}ê±´, ì‚­ì œ: ${appState.pendingDeletes.length}ê±´\ní´ë¼ìš°ë“œì— ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            showLoading(true);
            
            // ì‚­ì œ ì²˜ë¦¬
            for(const id of appState.pendingDeletes) {
                 await fetch(appState.scriptUrl, {
                    method: 'POST',
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify({ action: 'delete', data: { id: id, deleteType: 'leave', reason: 'ì¼ê´„ ìˆ˜ì • ì‚­ì œ' } }),
                    redirect: 'follow'
                });
            }

            // ìˆ˜ì •/ì¶”ê°€ ì²˜ë¦¬
            for(const m of appState.pendingUpdates) {
                 await fetch(appState.scriptUrl, {
                    method: 'POST',
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify({ action: 'update', data: m }),
                    redirect: 'follow'
                });
            }

            appState.pendingUpdates = [];
            appState.pendingDeletes = [];
            appState.isBatchMode = false;
            
            showLoading(false);
            showMsg("ì¼ê´„ ì €ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
            fetchMembers();
        }

        function renderMembers(container) {
            const batchBtnClass = appState.isBatchMode ? 'bg-gray-800 text-white shadow-inner' : 'bg-white text-gray-500 hover:bg-gray-100 shadow-sm border border-gray-100';
            const saveBtnHtml = appState.isBatchMode ? `<button onclick="saveBatchChanges()" class="shrink-0 px-6 py-3 rounded-2xl text-xs font-bold transition-all bg-pink-500 text-white shadow-xl hover:bg-pink-600 animate-pulse"><i class="fas fa-save mr-2"></i> ë³€ê²½ì‚¬í•­ ì €ì¥</button>` : '';

            container.innerHTML = `
                <div class="flex flex-col gap-8 fade-in">
                    <div class="bg-white p-10 rounded-t-[3rem] border border-gray-100 space-y-8 shadow-sm">
                        <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                            <div class="flex overflow-x-auto pb-2 no-scrollbar w-full md:w-auto gap-3">
                                <button onclick="filterByGuild('all')" class="shrink-0 whitespace-nowrap px-8 py-3 rounded-2xl text-xs font-bold transition-all ${appState.filters.guild === 'all' ? 'bg-gray-800 text-white shadow-xl' : 'bg-gray-50 text-gray-500 hover:bg-gray-100'}">ì „ì²´ ë³´ê¸°</button>
                                ${appState.guilds.map(g => `<button onclick="filterByGuild('${g.name}')" class="shrink-0 whitespace-nowrap px-8 py-3 rounded-2xl text-xs font-bold transition-all ${appState.filters.guild === g.name ? 'bg-pink-500 text-white shadow-xl shadow-pink-100' : 'bg-gray-50 text-gray-500 hover:bg-gray-100'}">${g.name}</button>`).join('')}
                            </div>
                            <div class="flex gap-4 w-full md:w-auto items-center">
                                ${saveBtnHtml}
                                <button onclick="toggleBatchMode()" class="shrink-0 px-6 py-3 rounded-2xl text-xs font-bold transition-all ${batchBtnClass}"><i class="fas fa-edit mr-1"></i> ${appState.isBatchMode ? 'ìˆ˜ì • ëª¨ë“œ ë„ê¸°' : 'ìˆ˜ì • ëª¨ë“œ ì¼œê¸°'}</button>
                                <button onclick="openBulkModal()" class="shrink-0 w-10 h-10 flex items-center justify-center rounded-2xl bg-emerald-50 text-emerald-500 hover:bg-emerald-100 transition-all" title="ì¼ê´„ ë“±ë¡"><i class="fas fa-file-import"></i></button>
                                <button onclick="openAddModal()" class="shrink-0 w-10 h-10 flex items-center justify-center rounded-2xl bg-pink-50 text-pink-500 hover:bg-pink-100 transition-all" title="ë©¤ë²„ ì¶”ê°€"><i class="fas fa-plus"></i></button>
                            </div>
                        </div>
                        <div class="relative"><i class="fas fa-search absolute left-6 top-1/2 -translate-y-1/2 text-gray-400 text-sm"></i><input type="text" oninput="handleSearch(this.value)" value="${appState.filters.search}" class="w-full pl-16 pr-8 py-4 bg-gray-50 border border-gray-100 rounded-[2rem] outline-none focus:ring-4 focus:ring-pink-50 font-bold text-sm shadow-inner" placeholder="ë‹‰ë„¤ì„, ì§ì—…, ì§ìœ„, ë³¸ìºë‹‰ ê²€ìƒ‰"></div>
                    </div>
                    <div id="memberTableContainer" class="bg-white rounded-b-[3rem] border border-gray-100 overflow-hidden shadow-sm"></div>
                </div>`;
            updateMemberTable();
        }

        function updateMemberTable() {
            const container = document.getElementById('memberTableContainer');
            if(!container) return;
            
            const memberMap = new Map();
            appState.members.forEach(m => memberMap.set(m.name, m));

            const term = appState.filters.search.toLowerCase();
            const filtered = appState.members.filter(m => {
                const gMatch = appState.filters.guild === 'all' || m.guild === appState.filters.guild;
                const owner = m.isMain ? m.name : (m.mainCharName || '');
                const sMatch = (m.name || '').toLowerCase().includes(term) || 
                               (m.role || '').toLowerCase().includes(term) || 
                               (m.class || '').toLowerCase().includes(term) || 
                               owner.toLowerCase().includes(term);
                return gMatch && sMatch;
            });
            
            filtered.sort((a, b) => { 
                const vA = (a[appState.filters.sortField] || '').toString(); 
                const vB = (b[appState.filters.sortField] || '').toString(); 
                if (vA < vB) return appState.filters.sortOrder === 'asc' ? -1 : 1;
                if (vA > vB) return appState.filters.sortOrder === 'asc' ? 1 : -1;
                return 0;
            });

            const countLabel = appState.filters.guild === 'all' ? 'ì „ì²´ ì¸ì›' : appState.filters.guild + ' ì¸ì›';
            const labelEl = document.getElementById('counterLabel');
            if(labelEl) labelEl.innerText = countLabel;
            
            const countEl = document.getElementById('totalMembersCount');
            if(countEl) countEl.innerText = filtered.length;

            const getSortIcon = (f) => {
                if (appState.filters.sortField !== f) return '<i class="fas fa-sort ml-1 opacity-30 text-[9px]"></i>';
                return appState.filters.sortOrder === 'asc' ? '<i class="fas fa-sort-up ml-1 text-pink-500 text-[10px]"></i>' : '<i class="fas fa-sort-down ml-1 text-pink-500 text-[10px]"></i>';
            };

            let html = `<div class="overflow-x-auto shadow-inner"><table class="w-full text-left min-w-[900px] text-xs whitespace-nowrap"><thead class="bg-gray-50 text-[10px] font-bold text-gray-500 border-b border-gray-100"><tr>
                <th class="p-4 text-center w-16">No.</th>
                <th class="p-4 sortable hover:bg-gray-100 transition-colors" onclick="handleSort('name')">ë‹‰ë„¤ì„ ${getSortIcon('name')}</th>
                <th class="p-4">ë³¸ìº ì •ë³´</th>
                <th class="p-4 sortable hover:bg-gray-100 transition-colors" onclick="handleSort('guild')">ì†Œì† ${getSortIcon('guild')}</th>
                <th class="p-4 sortable hover:bg-gray-100 transition-colors" onclick="handleSort('role')">ì§ìœ„ ${getSortIcon('role')}</th>
                <th class="p-4 sortable hover:bg-gray-100 transition-colors" onclick="handleSort('class')">ì§ì—… ${getSortIcon('class')}</th>
                <th class="p-4 text-right">ê´€ë¦¬</th>
            </tr></thead><tbody class="divide-y divide-gray-50 text-gray-600 font-bold">`;
            
            if (filtered.length === 0) html += `<tr><td colspan="7" class="p-20 text-center text-gray-300 font-bold">ê²€ìƒ‰ëœ ê¸¸ë“œì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
            
            const exemptionRanks = ['í¬ë¼ìš´', 'íŒŒë¥´í˜', 'í‹°ë¼ë¯¸ìŠˆ', 'í¬ë¡œì¹¸ìŠˆ'];

            filtered.forEach((m, index) => {
                // ë°°ì¹˜ ëª¨ë“œ ìƒíƒœ í‘œì‹œ
                let trClass = "hover:bg-pink-50/20 transition-all group";
                const isPendingUpdate = appState.pendingUpdates.find(u => u.name === m.name); // IDê°€ ë‹‰ë„¤ì„
                const isPendingDelete = appState.pendingDeletes.includes(m.name);
                
                if (isPendingUpdate) trClass += " batch-modified";
                if (isPendingDelete) trClass += " batch-deleted";

                // íŒŒë€ ë™ê·¸ë¼ë¯¸ ë¡œì§ ì¶”ê°€ (ì•„ì¸ìŠˆíŒ¨ë„ˆ)
                let iconHtml = '';
                if (m.role === 'ë§ˆì¹´ë¡±') {
                    iconHtml = '<i class="fas fa-crown text-blue-500 text-sm shadow-sm" style="text-shadow: 0 0 8px rgba(59,130,246,0.6);"></i>';
                } else if (m.role === 'ë‹¤ì¿ ì•„ì¦ˆ') {
                    iconHtml = '<i class="fas fa-crown text-pink-500 text-sm shadow-sm" style="text-shadow: 0 0 8px rgba(236,72,153,0.6);"></i>';
                } else {
                    let dotClass = 'bg-gray-200';
                    if(m.role === 'ì•„ì¸ìŠˆíŒ¨ë„ˆ') {
                        dotClass = 'bg-blue-500 shadow-[0_0_8px_rgba(59,130,246,0.5)]';
                    } else if (m.isMain) {
                        if (exemptionRanks.includes(m.role)) {
                            dotClass = 'bg-blue-500 shadow-[0_0_8px_rgba(59,130,246,0.5)]';
                        } else if (['íŒ¬ì¼€ì´í¬', 'ë¡¤ì¼€ì´í¬'].includes(m.role)) {
                            dotClass = 'bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.5)]';
                        } else {
                            dotClass = 'bg-pink-500 shadow-[0_0_8px_rgba(236,72,153,0.5)]';
                        }
                    }
                    iconHtml = `<div class="w-2.5 h-2.5 rounded-full ${dotClass}"></div>`;
                }
                
                // ì§ìœ„ ë±ƒì§€ ì²˜ë¦¬ (ì•„ì¸ìŠˆíŒ¨ë„ˆì¼ ë•Œë§Œ ë±ƒì§€ë¡œ, ì•„ë‹ˆë©´ í…ìŠ¤íŠ¸)
                let roleHtml = m.role;
                if(m.role === 'ì•„ì¸ìŠˆíŒ¨ë„ˆ') {
                    roleHtml = `<span class="px-2 py-1 rounded-full bg-gray-100 text-gray-500 text-[9px] font-bold tracking-tighter">ì•„ì¸ìŠˆíŒ¨ë„ˆ</span>`;
                }

                // ë³¸ìº ì •ë³´ ë¡œì§ ìˆ˜ì •: ë³¸ìº ì§ìœ„ê°€ ë©´ì œ ì§ìœ„ë©´ (ì•„ì¸ìŠˆíŒ¨ë„ˆ) íŒŒë€ ê¸€ì”¨ ì¶”ê°€
                let ownerName = '-';
                let ownerRankHtml = ''; 

                if (m.isMain) {
                    ownerName = m.name;
                    let rText = m.role;
                    if (exemptionRanks.includes(m.role)) {
                        rText += ' <span class="text-[8px] text-blue-500 font-bold">(ì•„ì¸ìŠˆíŒ¨ë„ˆ)</span>';
                    }
                    ownerRankHtml = rText;
                } else {
                    ownerName = m.mainCharName || '-';
                    const mainMem = memberMap.get(ownerName);
                    if (mainMem) {
                        let rText = mainMem.role;
                        if (exemptionRanks.includes(mainMem.role)) {
                            rText += ' <span class="text-[8px] text-blue-500 font-bold">(ì•„ì¸ìŠˆíŒ¨ë„ˆ)</span>';
                        }
                        ownerRankHtml = rText;
                    } else {
                        ownerRankHtml = '<span class="text-gray-300">ì •ë³´ì—†ìŒ</span>';
                    }
                }

                html += `<tr class="${trClass}">
                    <td class="p-3 text-center text-gray-400 font-black text-[11px]">${index + 1}</td>
                    <td class="p-3 leading-none"><div class="flex items-center gap-4 leading-none">${iconHtml}<span class="text-sm font-bold text-gray-800 tracking-tight leading-none">${m.name}</span></div></td>
                    <td class="p-3 leading-none">
                        <div class="flex flex-col gap-0.5">
                            <span class="text-[10px] font-bold text-gray-700">${ownerName}</span>
                            <span class="text-[9px] text-gray-400 font-medium">${ownerRankHtml}</span>
                        </div>
                    </td>
                    <td class="p-3 font-bold text-gray-500 leading-none">${m.guild}</td>
                    <td class="p-3 leading-none"><span class="text-gray-600 font-bold text-[10px]">${roleHtml}</span></td>
                    <td class="p-3 font-bold text-gray-400 leading-none">${m.class || '-'}</td>
                    <td class="p-3 text-right opacity-0 group-hover:opacity-100 transition-opacity leading-none">
                        ${isPendingDelete ? '<span class="text-red-500 text-[10px]">ì‚­ì œ ëŒ€ê¸°</span>' : 
                         `<div class="flex justify-end gap-2"><button onclick="openEditModal('${m.id}')" class="w-8 h-8 rounded-xl bg-white border border-gray-100 text-blue-500 hover:bg-blue-50 shadow-sm transition-all flex items-center justify-center"><i class="fas fa-edit text-xs"></i></button><button onclick="openDeleteModal('${m.id}')" class="w-8 h-8 rounded-xl bg-white border border-gray-100 text-red-500 hover:bg-red-50 shadow-sm transition-all flex items-center justify-center"><i class="fas fa-trash-alt text-xs"></i></button></div>`}
                    </td>
                </tr>`;

                if ((index + 1) % 17 === 0 && index !== filtered.length - 1) {
                    html += `<tr><td colspan="7" class="p-0 border-b-[3px] border-dashed border-pink-300"></td></tr>`;
                }
            });
            html += `</tbody></table></div>`;
            container.innerHTML = html;
        }

        // ìë™ ì§ìœ„ ì²´í¬ í•¨ìˆ˜
        function checkAutoRank(mainName) {
            if(!mainName) return;
            const mainMem = appState.members.find(m => m.name === mainName);
            if(mainMem) {
                 const exemptionRanks = ['í¬ë¼ìš´', 'íŒŒë¥´í˜', 'í‹°ë¼ë¯¸ìŠˆ', 'í¬ë¡œì¹¸ìŠˆ'];
                 if(exemptionRanks.includes(mainMem.role)) {
                     const roleSel = document.getElementById('inputRole');
                     if(roleSel) {
                         roleSel.value = 'ì•„ì¸ìŠˆíŒ¨ë„ˆ';
                         // ì‹œê°ì  í”¼ë“œë°±
                         roleSel.classList.add('bg-blue-50');
                         setTimeout(() => roleSel.classList.remove('bg-blue-50'), 500);
                     }
                 }
            }
        }

        function renderSheet(container) {
            const sheetUrl = appState.sheetUrl;
            let embedUrl = (sheetUrl && sheetUrl.includes("docs.google.com/spreadsheets")) ? (sheetUrl.split('/edit')[0] + "/preview") : "";
            container.innerHTML = `<div class="h-full flex flex-col gap-6 fade-in font-bold"><div class="bg-white p-6 rounded-[2rem] border border-gray-100 shadow-sm flex flex-col md:flex-row justify-between items-center gap-6"><div><h3 class="text-sm font-bold text-gray-800">ì›ë³¸ ë°ì´í„° ì‹œíŠ¸ ë·°ì–´</h3><p class="text-[10px] text-gray-400 font-bold mt-2">A~Gì—´ ì›ë³¸ êµ¬ê¸€ ì‹œíŠ¸ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.</p></div><button onclick="window.open('${sheetUrl || '#'}', '_blank')" class="px-10 py-4 bg-gray-900 text-white rounded-2xl text-[10px] font-bold shadow-xl hover:bg-black transition-all">ìƒˆ ì°½ì—ì„œ ì‹œíŠ¸ ì—´ê¸°</button></div><div class="flex-1 bg-white border border-gray-100 rounded-[2.5rem] shadow-inner overflow-hidden relative">${embedUrl ? `<iframe src="${embedUrl}" class="w-full h-full border-none"></iframe>` : `<div class="absolute inset-0 flex flex-col items-center justify-center text-gray-300"><i class="fas fa-table text-7xl mb-6 opacity-20"></i><p class="text-xs">ì„¤ì • ë©”ë‰´ì—ì„œ ì‹œíŠ¸ ë§í¬ë¥¼ ì—°ë™í•´ì£¼ì„¸ìš”.</p></div>`}</div></div>`;
        }

        function renderHistory(container) {
            container.innerHTML = `<div class="bg-white rounded-[2.5rem] border border-gray-100 shadow-sm overflow-hidden fade-in font-bold"><div class="p-8 border-b border-gray-50 flex items-center justify-between shadow-sm"><h3 class="text-sm font-bold text-gray-800"><i class="fas fa-history mr-2 text-pink-500"></i> ê¸¸ë“œ í™œë™ ìš´ì˜ ì´ë ¥</h3><span class="text-[10px] text-gray-400 font-bold">ëˆ„ì  ê¸°ë¡: ${appState.history.length} ê±´</span></div><div class="overflow-x-auto shadow-inner"><table class="w-full text-left text-xs whitespace-nowrap font-bold"><thead class="bg-gray-50 text-[10px] font-bold text-gray-500 border-b border-gray-100"><tr><th class="p-6">ì‹œê°„</th><th class="p-6 w-32">í™œë™ ë¶„ë¥˜</th><th class="p-8">ëŒ€ìƒ ë‹‰ë„¤ì„</th><th class="p-6">í™œë™ ìƒì„¸ ë‚´ìš©</th></tr></thead><tbody class="divide-y divide-gray-50 text-gray-600 font-bold">${appState.history.length === 0 ? `<tr><td colspan="4" class="p-20 text-center text-gray-300 font-bold">ê¸°ë¡ëœ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>` : appState.history.map(log => {
                const badge = log.category === 'ì¶”ë°©' ? 'bg-red-50 text-red-500 border border-red-100' : (log.category === 'íƒˆí‡´' || log.category === 'ìì§„íƒˆí‡´' ? 'bg-gray-100 text-gray-500 border border-gray-200' : 'bg-green-50 text-green-500 border border-green-100');
                return `<tr class="hover:bg-gray-50/50 transition-colors"><td class="p-6 font-mono text-gray-400 font-bold text-[10px] tracking-tighter">${log.date}</td><td class="p-6"><span class="px-3 py-1.5 rounded-lg text-[9px] font-bold ${badge} shadow-sm">${log.category}</span></td><td class="p-8 font-bold text-gray-800">${log.name}</td><td class="p-8 font-medium text-gray-500 font-bold text-[11px]">${log.content}</td></tr>`;
            }).join('')}</tbody></table></div></div>`;
        }

        function renderSettings(container) {
            container.innerHTML = `
                <div class="grid grid-cols-1 gap-10 fade-in max-w-4xl font-bold">
                    <div class="bg-white p-12 rounded-[2.5rem] border border-gray-100 shadow-sm font-bold">
                        <div class="flex items-center gap-5 mb-10"><div class="w-14 h-14 rounded-3xl bg-gray-900 text-white flex items-center justify-center text-2xl shadow-xl shadow-gray-200"><i class="fas fa-link"></i></div><div><h3 class="text-xl font-bold text-gray-800 tracking-tighter">í´ë¼ìš°ë“œ ì—°ë™ ì„¤ì •</h3><p class="text-[10px] text-gray-400 font-bold mt-2">API ë° ì‹œíŠ¸ ì£¼ì†Œë¥¼ êµ¬ì„±í•©ë‹ˆë‹¤.</p></div></div>
                        <div class="space-y-8 font-bold">
                            <div class="space-y-2"><label class="text-[10px] font-bold text-gray-400 ml-1">ì•±ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ API URL</label><input type="text" id="settingScriptUrl" value="${appState.scriptUrl}" class="w-full bg-gray-50 border border-gray-100 rounded-2xl p-5 text-xs font-bold outline-none focus:ring-4 focus:ring-gray-200 shadow-inner font-mono transition-all"></div>
                            <div class="space-y-2"><label class="text-[10px] font-bold text-gray-400 ml-1">êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ URL</label><input type="text" id="settingSheetUrl" value="${appState.sheetUrl}" class="w-full bg-gray-50 border border-gray-100 rounded-2xl p-5 text-xs font-bold outline-none focus:ring-4 focus:ring-gray-200 shadow-inner font-mono transition-all"></div>
                            <button onclick="saveSystemSettings()" class="w-full py-6 bg-gray-900 text-white rounded-3xl font-bold text-xs shadow-xl hover:bg-black transition-all active:scale-[0.98]">ì €ì¥ í›„ ì‹œìŠ¤í…œ ì¬ë¶€íŒ…</button>
                        </div>
                    </div>
                    <div class="bg-white p-12 rounded-[2.5rem] border border-gray-100 shadow-sm">
                        <div class="flex flex-col md:flex-row justify-between items-center gap-6 mb-12 pb-10 border-b border-gray-100">
                            <div>
                                <h3 class="text-xl font-bold text-gray-800 text-pink-500 tracking-tight">ê¸¸ë“œ ì§ìœ„ ì²´ê³„ (ì½ê¸° ì „ìš©)</h3>
                                <p class="text-[10px] text-gray-400 font-bold mt-2">ê¸¸ë“œë³„ ì§ìœ„ ëª©ë¡ì…ë‹ˆë‹¤.</p>
                            </div>
                            <select onchange="changeRankGuild(this.value)" class="bg-gray-50 border border-gray-100 rounded-2xl px-8 py-5 text-xs font-bold outline-none cursor-pointer hover:bg-gray-100 shadow-sm transition-all">${appState.guilds.map(g => `<option value="${g.name}" ${g.name === appState.tempSettingsRankGuild ? 'selected' : ''}>${g.name}</option>`).join('')}</select>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 mb-12">
                            ${(appState.guildRanks[appState.tempSettingsRankGuild] || []).map((r, i) => `<div class="flex items-center gap-4 bg-gray-50 border border-gray-100 p-5 rounded-3xl group hover:bg-white hover:border-pink-200 shadow-sm"><span class="w-8 text-center text-[10px] font-bold text-gray-400 group-hover:text-pink-400">${i+1}</span><div class="flex-1 text-sm font-bold text-gray-700">${r}</div></div>`).join('')}
                        </div>
                    </div>
                    <div class="bg-white p-12 rounded-[2.5rem] border border-red-100 shadow-sm mt-10">
                        <div class="text-center">
                             <div class="w-16 h-16 bg-red-50 text-red-500 rounded-2xl flex items-center justify-center text-2xl mx-auto mb-5 shadow-inner"><i class="fas fa-radiation"></i></div>
                             <h3 class="text-xl font-bold text-gray-800 mb-2">ê³µì¥ ì´ˆê¸°í™”</h3>
                             <p class="text-xs text-gray-400 font-bold mb-8">êµ¬ê¸€ ì‹œíŠ¸ì˜ ëª¨ë“  ë°ì´í„°ë¥¼ ì˜êµ¬ ì‚­ì œí•©ë‹ˆë‹¤.</p>
                             <button onclick="executeFactoryReset()" class="py-4 px-10 bg-red-500 text-white rounded-2xl font-bold text-xs shadow-xl hover:bg-red-600 transition-all">ì „ì²´ ë°ì´í„° ì´ˆê¸°í™”</button>
                        </div>
                    </div>
                </div>`;
        }

        // --- Logic Handlers ---
        function saveSystemSettings() {
            const script = document.getElementById('settingScriptUrl').value.trim(), sheet = document.getElementById('settingSheetUrl').value.trim();
            if(!script) return showMsg("API ì£¼ì†Œê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.", "error");
            localStorage.setItem('macaron_script_url', script); localStorage.setItem('macaron_sheet_url', sheet);
            showMsg("ì—°ë™ ë§í¬ ì„¤ì •ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤. ì¬ì‹œì‘ ì¤‘...", "success"); setTimeout(() => location.reload(), 1000);
        }

        function handleSearch(v) { appState.filters.search = v; appState.filters.page = 1; updateMemberTable(); }
        function filterByGuild(g) { appState.filters.guild = g; appState.filters.page = 1; updateMemberTable(); router('members'); }
        function handleSort(field) { if(appState.filters.sortField === field) appState.filters.sortOrder = appState.filters.sortOrder === 'asc' ? 'desc' : 'asc'; else { appState.filters.sortField = field; appState.filters.sortOrder = 'asc'; } updateMemberTable(); }
        function goToPage(p) { appState.filters.page = p; updateMemberTable(); }
        function openModal(id) { document.getElementById(id)?.classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id)?.classList.add('hidden'); }
        function onGuildSelectChange(v) {
            const roleSel = document.getElementById('inputRole'); if(roleSel) roleSel.innerHTML = (appState.guildRanks[v] || initialGuildRanks['ëš ì¹´ë¡±']).map(r => `<option value="${r}">${r}</option>`).join('');
        }
        function toggleMainCharInput() { document.getElementById('mainCharInputGroup').classList.toggle('hidden', document.getElementById('inputIsMain').checked); }
        
        function openAddModal() {
            document.getElementById('modalTitle').innerText = 'ë©¤ë²„ ì •ë³´ ì‹ ê·œ ë“±ë¡'; 
            document.getElementById('memberForm').reset();
            document.getElementById('editMemberId').value = ''; 
            document.getElementById('inputName').disabled = false;
            document.getElementById('btnSubmitMember').innerText = appState.isBatchMode ? 'ì„ì‹œ ì €ì¥ (ëŒ€ê¸°)' : 'ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥';
            
            const gSel = document.getElementById('inputGuild'); 
            if(gSel) { 
                gSel.innerHTML = appState.guilds.map(g => `<option value="${g.name}">${g.name}</option>`).join(''); 
                onGuildSelectChange(appState.guilds[0].name); 
            }
            
            const jobSel = document.getElementById('inputClass');
            if(jobSel) {
                jobSel.innerHTML = `<option value="">ì§ì—…ì„ ì„ íƒí•˜ì„¸ìš”</option>` + MAPLE_JOBS.map(job => `<option value="${job}">${job}</option>`).join('');
            }
            
            toggleMainCharInput(); 
            openModal('memberModal');
        }

        function openEditModal(id) {
            const m = appState.members.find(x => x.id == id); 
            if(!m) return;
            // ë§Œì•½ ëŒ€ê¸°ì¤‘ì¸ ì—…ë°ì´íŠ¸ê°€ ìˆë‹¤ë©´ ê·¸ ì •ë³´ë¡œ ë®ì–´ì”€
            const pending = appState.pendingUpdates.find(u => u.id === id);
            const data = pending || m;

            document.getElementById('modalTitle').innerText = 'ë©¤ë²„ ì •ë³´ ìˆ˜ì •í•˜ê¸°'; 
            document.getElementById('editMemberId').value = data.id;
            document.getElementById('inputName').value = data.name; 
            document.getElementById('inputName').disabled = true; 
            document.getElementById('btnSubmitMember').innerText = appState.isBatchMode ? 'ë³€ê²½ì‚¬í•­ ì„ì‹œ ì ìš©' : 'ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸';
            
            const jobSel = document.getElementById('inputClass');
            if(jobSel) {
                jobSel.innerHTML = `<option value="">ì§ì—…ì„ ì„ íƒí•˜ì„¸ìš”</option>` + MAPLE_JOBS.map(job => `<option value="${job}">${job}</option>`).join('');
                jobSel.value = data.class || '';
            }

            const gSel = document.getElementById('inputGuild'); 
            if(gSel) { 
                gSel.innerHTML = appState.guilds.map(g => `<option value="${g.name}" ${g.name === data.guild ? 'selected' : ''}>${g.name}</option>`).join(''); 
                onGuildSelectChange(data.guild); 
            }
            
            setTimeout(() => {
                const rSel = document.getElementById('inputRole');
                if(rSel) rSel.value = data.role;
            }, 50);

            document.getElementById('inputIsMain').checked = data.isMain;
            document.getElementById('inputMainCharName').value = data.mainCharName || ''; 
            toggleMainCharInput(); 
            openModal('memberModal');
        }

        document.getElementById('memberForm').onsubmit = async (e) => {
            e.preventDefault(); 
            const oldId = document.getElementById('editMemberId').value;
            const name = document.getElementById('inputName').value.trim();
            
            if(!name) {
                showMsg('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            const payload = { 
                id: oldId || name, 
                name: name, 
                guild: document.getElementById('inputGuild').value, 
                role: document.getElementById('inputRole').value, 
                class: document.getElementById('inputClass').value, 
                isMain: document.getElementById('inputIsMain').checked, 
                mainCharName: document.getElementById('inputMainCharName').value.trim(), 
                joinDate: '' 
            };
            
            if(appState.isBatchMode) {
                // ë°°ì¹˜ ëª¨ë“œ: ë¡œì»¬ ë°˜ì˜
                if(oldId) { // ìˆ˜ì •
                    // ê¸°ì¡´ ëª©ë¡ ì—…ë°ì´íŠ¸
                    const idx = appState.members.findIndex(m => m.id === oldId);
                    if(idx !== -1) appState.members[idx] = { ...appState.members[idx], ...payload };
                    
                    // ëŒ€ê¸° ëª©ë¡ ì—…ë°ì´íŠ¸ (ì´ë¯¸ ìˆìœ¼ë©´ ë®ì–´ì“°ê¸°)
                    const pIdx = appState.pendingUpdates.findIndex(u => u.id === oldId);
                    if(pIdx !== -1) appState.pendingUpdates[pIdx] = payload;
                    else appState.pendingUpdates.push(payload);
                    
                } else { // ì¶”ê°€
                    appState.members.push(payload);
                    appState.pendingUpdates.push(payload);
                }
                updateMemberTable();
                closeModal('memberModal');
                showMsg("ë³€ê²½ì‚¬í•­ì´ ì„ì‹œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.", "info");
            } else {
                // ì¦‰ì‹œ ì „ì†¡
                if (await sendAction(oldId ? 'update' : 'add', payload, 'btnSubmitMember')) closeModal('memberModal');
            }
        };

        function openDeleteModal(id) { appState.memberToDelete = appState.members.find(x => x.id == id); if(!appState.memberToDelete) return; document.getElementById('deleteTargetName').innerText = appState.memberToDelete.name; document.getElementById('deleteReason').value = ''; setDeleteType('leave'); openModal('deleteModal'); }
        function setDeleteType(t) { appState.deleteType = t; document.getElementById('btnLeave').className = t === 'leave' ? "flex-1 py-3.5 rounded-xl font-bold text-xs bg-gray-800 text-white shadow-sm transition-all" : "flex-1 py-3.5 rounded-xl font-bold text-xs bg-gray-100 text-gray-400 transition-all"; document.getElementById('btnKick').className = t === 'kick' ? "flex-1 py-3.5 rounded-xl font-bold text-xs bg-red-600 text-white shadow-xl shadow-red-100 transition-all" : "flex-1 py-3.5 rounded-xl font-bold text-xs bg-gray-100 text-gray-400 transition-all"; }
        
        async function confirmDelete() { 
            if(!appState.memberToDelete) return; 
            
            if(appState.isBatchMode) {
                // ë°°ì¹˜ ëª¨ë“œ: ë¡œì»¬ ì‚­ì œ í‘œì‹œ
                appState.pendingDeletes.push(appState.memberToDelete.id);
                // í™”ë©´ ê°±ì‹ 
                updateMemberTable();
                closeModal('deleteModal');
                showMsg("ì‚­ì œ ëŒ€ê¸° ìƒíƒœê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.", "info");
            } else {
                if (await sendAction('delete', { id: appState.memberToDelete.id, deleteType: appState.deleteType, reason: document.getElementById('deleteReason').value.trim() })) closeModal('deleteModal'); 
            }
        }

        function openBulkModal() { document.getElementById('bulkInput').value = ''; appState.parsedBulkData = []; parseBulkInput(); openModal('bulkModal'); }

        function parseBulkInput() {
            const raw = document.getElementById('bulkInput').value.trim(), tbody = document.getElementById('bulkPreviewBody'), btn = document.getElementById('btnExecuteBulk'), readyCount = document.getElementById('bulkReadyCount');
            if (!raw) { appState.parsedBulkData = []; if(tbody) tbody.innerHTML = '<tr><td colspan="4" class="p-20 text-center text-gray-400 font-bold">ì´ê³³ì— ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.</td></tr>'; if(readyCount) readyCount.innerText = '0'; if(btn) btn.disabled = true; return; }
            const lines = raw.split('\n'), parsed = [], today = new Date().toISOString().split('T')[0];
            lines.forEach(line => {
                let cols = line.split('\t').map(c => c.trim()); if (cols.length < 2 && line.includes(',')) cols = line.split(',').map(c => c.trim());
                if (!cols[0]) return; 
                let guild = appState.filters.guild !== 'all' ? appState.filters.guild : appState.guilds[0].name;
                const match = appState.guilds.find(g => g.name === cols[1]); if (match) guild = match.name;
                const ranks = appState.guildRanks[guild] || initialGuildRanks['ëš ì¹´ë¡±'];
                parsed.push({ id: cols[0], name: cols[0], guild, role: ranks[ranks.length-1], class: cols[2] || '-', isMain: true, mainCharName: '', joinDate: today });
            });
            appState.parsedBulkData = parsed; if(readyCount) readyCount.innerText = parsed.length; if(btn) btn.disabled = (parsed.length === 0);
            if(tbody) {
                tbody.innerHTML = parsed.slice(0, 100).map(d => `<tr class="hover:bg-gray-50 transition-colors font-bold"><td class="px-5 py-4 text-green-500 font-bold text-[10px]">ì •ìƒ ëŒ€ê¸°</td><td class="px-5 py-4 font-bold text-gray-800">${d.name}</td><td class="px-5 py-4 text-gray-500 font-bold text-[10px]">${d.guild}</td><td class="px-5 py-4 text-gray-400 font-medium text-[10px]">${d.class}</td></tr>`).join('');
                if (parsed.length > 100) tbody.innerHTML += `<tr><td colspan="4" class="px-5 py-6 text-center text-gray-400 text-[10px] font-bold">...ì™¸ ${parsed.length - 100}ëª… ìƒëµë¨</td></tr>`;
            }
        }

        async function saveBulkData() {
            if (appState.parsedBulkData.length === 0) return;
            // iframe ë‚´ confirm ì°½ ë§‰í˜ í˜„ìƒ í•´ê²°ì„ ìœ„í•´ alert/confirm ì—†ì´ ì¦‰ì‹œ ì „ì†¡
            if (await sendAction('bulk_add', appState.parsedBulkData, 'btnExecuteBulk')) {
                closeModal('bulkModal');
                document.getElementById('bulkInput').value = '';
                appState.parsedBulkData = [];
                document.getElementById('bulkPreviewBody').innerHTML = '';
            }
        }

        function changeRankGuild(v) { appState.tempSettingsRankGuild = v; router('settings'); }
        function updateRankVal(i, v) { appState.guildRanks[appState.tempSettingsRankGuild][i] = v; localStorage.setItem('macaron_ranks_v22', JSON.stringify(appState.guildRanks)); } // ë²„ì „ v22ìœ¼ë¡œ í†µì¼
        function addRank() { appState.guildRanks[appState.tempSettingsRankGuild].push("ìƒˆ ì§ìœ„"); localStorage.setItem('macaron_ranks_v22', JSON.stringify(appState.guildRanks)); router('settings'); }
        function removeRank(i) { appState.guildRanks[appState.tempSettingsRankGuild].splice(i, 1); localStorage.setItem('macaron_ranks_v22', JSON.stringify(appState.guildRanks)); router('settings'); }
        
        function executeFactoryReset() { openModal('resetModal'); }
        async function confirmReset() { if(await sendAction('reset', {})) closeModal('resetModal'); }

        function initSidebar() {
            const sb = document.getElementById('sidebar'), ov = document.getElementById('sidebarOverlay'), openBtn = document.getElementById('openSidebar'), closeBtn = document.getElementById('closeSidebar');
            if(openBtn) { openBtn.onclick = () => { sb.classList.remove('-translate-x-full'); ov.classList.remove('hidden'); }; }
            if(closeBtn) { closeBtn.onclick = () => { sb.classList.add('-translate-x-full'); ov.classList.add('hidden'); }; }
            if(ov) { ov.onclick = () => { sb.classList.add('-translate-x-full'); ov.classList.add('hidden'); }; }
            
            // ë³¸ë¬¸ì— ì´ˆê¸°í™” ëª¨ë‹¬ì´ ì—†ìœ¼ë©´ ìƒì„±
            if(!document.getElementById('resetModal')){
                const resetHtml = `<div id="resetModal" class="fixed inset-0 z-[110] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden fade-in font-bold"><div class="bg-white rounded-[3rem] shadow-2xl w-full max-w-md p-12 text-center border border-gray-50"><div class="w-20 h-20 bg-red-50 text-red-500 rounded-[2rem] flex items-center justify-center text-4xl mx-auto mb-6 shadow-inner"><i class="fas fa-radiation"></i></div><h3 class="text-2xl font-black text-gray-800 tracking-tight mb-4">ë°ì´í„° ì „ì²´ ì´ˆê¸°í™”</h3><p class="text-xs text-gray-500 mb-8 leading-relaxed">êµ¬ê¸€ ì‹œíŠ¸ì˜ ëª¨ë“  ë°ì´í„°ì™€ ë¡œê·¸ê°€ ì™„ì „íˆ ì§€ì›Œì§‘ë‹ˆë‹¤.<br>ì •ë§ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p><div class="grid grid-cols-2 gap-4"><button onclick="closeModal('resetModal')" class="py-4 bg-gray-50 rounded-2xl font-bold text-xs text-gray-500 hover:bg-gray-100 transition-all">ì·¨ì†Œ</button><button onclick="confirmReset()" class="py-4 bg-red-600 text-white rounded-2xl font-bold text-xs shadow-xl hover:bg-red-700 transition-all">ì´ˆê¸°í™” ì§„í–‰</button></div></div></div>`;
                document.body.insertAdjacentHTML('beforeend', resetHtml);
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => { initSidebar(); fetchMembers(); });
    </script>
</body>
</html>
