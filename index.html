<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>뚠카롱 길드 관리 시스템 (v8.24)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        .chart-container { position: relative; width: 100%; height: 300px; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #fbcfe8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #f472b6; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        th.sortable { cursor: pointer; user-select: none; transition: background 0.2s; position: relative; }
        th.sortable:hover { background-color: #fdf2f8 !important; color: #db2777 !important; }
        .force-hide { display: none !important; }
        #loadingOverlay { position: fixed; inset: 0; background: white; z-index: 10000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .nav-item.active { background-color: #fdf2f8; color: #ec4899; box-shadow: inset 4px 0 0 #ec4899; }
        #msgBox { transition: all 0.3s ease; transform: translateY(100px); opacity: 0; pointer-events: none; }
        #msgBox.show { transform: translateY(0); opacity: 1; }
        .batch-modified { background-color: #fff7ed !important; } 
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.25rem; text-align: center; font-size: 0.75rem; }
        .calendar-day { padding: 0.25rem; border-radius: 0.75rem; position: relative; transition: all 0.2s; min-height: 32px; display: flex; align-items: center; justify-content: center; aspect-ratio: 1.2/1; }
        .calendar-day.today { background-color: #ec4899; color: white; font-weight: bold; }
        .calendar-day.thursday { color: #db2777; background-color: #fdf2f8; border: 1px solid #fbcfe8; font-weight: bold; }
        .calendar-head { font-size: 0.7rem; font-weight: 800; color: #9ca3af; text-transform: uppercase; padding-bottom: 8px; }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 h-screen overflow-hidden flex font-medium">

    <div id="loadingOverlay">
        <div class="text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-pink-500 border-opacity-20 border-t-pink-500 mb-8 mx-auto"></div>
            <p class="text-pink-600 font-bold text-xl tracking-tight">데이터 동기화 중...</p>
        </div>
    </div>

    <div id="msgBox" class="fixed bottom-10 left-1/2 -translate-x-1/2 z-[200] bg-slate-900 text-white px-8 py-4 rounded-2xl shadow-2xl flex items-center gap-4 border border-white/10">
        <div id="msgIcon" class="text-pink-500"><i class="fas fa-info-circle"></i></div>
        <p id="msgText" class="text-sm font-bold"></p>
    </div>

    <aside id="sidebar" class="fixed lg:static inset-y-0 left-0 z-50 w-64 bg-white border-r border-gray-100 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 flex flex-col shadow-sm">
        <div class="p-6 border-b border-gray-100 flex items-center gap-3">
            <div class="w-10 h-10 rounded-2xl bg-gradient-to-tr from-pink-400 to-rose-400 flex items-center justify-center text-white font-bold shadow-lg shadow-pink-100 text-xl">뚠</div>
            <div><h1 class="text-lg font-bold text-gray-800 tracking-tight">뚠카롱 길드 관리</h1><p class="text-[9px] text-gray-400 font-bold uppercase tracking-widest leading-none mt-1">v8.24 Stable</p></div>
            <button id="closeSidebar" class="lg:hidden ml-auto text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
        </div>
        <nav class="p-4 space-y-2 flex-1 overflow-y-auto no-scrollbar">
            <button onclick="router('dashboard')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="dashboard"><i class="fas fa-columns w-5 text-center"></i><span>대시보드</span></button>
            <button onclick="router('members')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="members"><i class="fas fa-users w-5 text-center"></i><span>길드원 관리</span></button>
            <button onclick="router('suro')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="suro"><i class="fas fa-edit w-5 text-center"></i><span>수로 점수 입력</span></button>
            <button onclick="router('analysis')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="analysis"><i class="fas fa-chart-line w-5 text-center"></i><span>수로 점수 분석</span></button>
            <button onclick="router('bail')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="bail"><i class="fas fa-gem w-5 text-center"></i><span>보석금 관리</span></button>
            <button onclick="router('sheet')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="sheet"><i class="fas fa-table w-5 text-center"></i><span>시트 보기</span></button>
            <button onclick="router('history')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="history"><i class="fas fa-history w-5 text-center"></i><span>운영 이력</span></button>
            <button onclick="router('settings')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="settings"><i class="fas fa-cog w-5 text-center"></i><span>설정</span></button>
        </nav>
        <div class="p-4 border-t border-gray-100 bg-gray-50/50 text-center font-bold"><p class="text-[10px] text-green-500 uppercase tracking-widest"><i class="fas fa-cloud mr-1 animate-pulse"></i> Database Connected</p></div>
    </aside>

    <div id="sidebarOverlay" class="fixed inset-0 bg-black/10 z-40 hidden lg:hidden"></div>

    <main class="flex-1 flex flex-col overflow-hidden bg-gray-50">
        <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-8 shrink-0 z-10 shadow-sm">
            <div class="flex items-center gap-4"><button id="openSidebar" class="p-2 lg:hidden rounded-lg hover:bg-gray-100 text-gray-600"><i class="fas fa-bars text-xl"></i></button><h2 id="pageTitle" class="text-xl font-bold text-gray-800 tracking-tight">대시보드</h2></div>
            <div class="flex items-center gap-4"><div class="px-4 py-1.5 bg-pink-50 text-pink-600 rounded-full text-xs font-bold border border-pink-100 shadow-sm">✨ <span id="counterLabel">전체 인원</span>: <span id="totalMembersCount">0</span>명</div><button onclick="fetchMembers()" class="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-gray-100 text-gray-400 transition-all border border-gray-100 shadow-sm"><i class="fas fa-sync-alt"></i></button></div>
        </header>
        <div id="contentArea" class="flex-1 overflow-y-auto p-4 lg:p-10 relative bg-gray-50 flex flex-col min-h-0"></div>
    </main>

    <!-- Modals -->
    <div id="memberModal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/30 backdrop-blur-sm hidden fade-in font-bold"><div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-md overflow-hidden border border-gray-100"><div class="p-6 bg-pink-50 border-b border-pink-100 flex justify-between items-center"><div><h3 id="modalTitle" class="text-lg font-bold text-pink-700 tracking-tight">멤버 정보 입력</h3></div><button onclick="closeModal('memberModal')"><i class="fas fa-times text-gray-400 text-lg"></i></button></div><form id="memberForm" class="p-8 space-y-5"><input type="hidden" id="editMemberId"><div class="space-y-1"><label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">닉네임</label><input type="text" id="inputName" class="w-full border border-gray-100 bg-gray-50 rounded-2xl p-3.5 outline-none focus:ring-4 focus:ring-pink-50 text-sm font-bold shadow-inner" required placeholder="정확한 캐릭터명"></div><div class="grid grid-cols-2 gap-4"><div class="space-y-1"><label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">소속</label><select id="inputGuild" class="w-full border border-gray-100 bg-gray-50 rounded-2xl p-3.5 text-sm font-bold outline-none" onchange="onGuildSelectChange(this.value)"></select></div><div class="space-y-1"><label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">직위</label><select id="inputRole" class="w-full border border-gray-100 bg-gray-50 rounded-2xl p-3.5 text-sm font-bold outline-none"></select></div></div><div class="space-y-1"><label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">직업</label><select id="inputClass" class="w-full border border-gray-100 bg-gray-50 rounded-2xl p-3.5 text-sm font-bold outline-none shadow-inner cursor-pointer"><option value="">직업을 선택하세요</option></select></div><div class="flex items-center gap-3 py-1"><input type="checkbox" id="inputIsMain" class="w-5 h-5 text-pink-500 rounded focus:ring-pink-50 shadow-sm cursor-pointer" checked onchange="toggleMainCharInput()"><label for="inputIsMain" class="text-[11px] font-bold text-gray-600 uppercase tracking-tight cursor-pointer">본캐릭터입니까?</label></div><div id="mainCharInputGroup" class="hidden animate-fade-in space-y-1"><label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">본캐 닉네임</label><input type="text" id="inputMainCharName" class="w-full border border-gray-100 bg-gray-50 rounded-2xl p-3.5 text-sm font-bold outline-none shadow-inner" placeholder="본캐릭명 입력"></div><button type="submit" id="btnSubmitMember" class="w-full bg-gray-900 text-white py-4 rounded-2xl font-bold uppercase text-[10px] tracking-widest hover:bg-black transition-all shadow-xl mt-2">데이터베이스에 저장</button></form></div></div>
    
    <div id="deleteModal" class="fixed inset-0 z-[110] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden fade-in font-bold"><div class="bg-white rounded-[2.5rem] shadow-2xl w-full max-w-sm p-10 text-center border border-gray-50"><div class="w-16 h-16 bg-red-50 text-red-500 rounded-2xl flex items-center justify-center text-2xl mx-auto mb-5 shadow-inner"><i class="fas fa-user-minus"></i></div><p class="text-gray-800 font-bold text-lg mb-6 leading-tight">'<span id="deleteTargetName" class="text-red-500"></span>' 제거 확정</p><div class="space-y-4 text-left mb-8"><div class="flex gap-2"><button onclick="setDeleteType('leave')" id="btnLeave" class="flex-1 py-3 rounded-xl font-bold text-xs bg-gray-800 text-white shadow-sm transition-all">자진탈퇴</button><button onclick="setDeleteType('kick')" id="btnKick" class="flex-1 py-3 rounded-xl font-bold text-xs bg-gray-100 text-gray-400 transition-all">추방</button></div><input type="text" id="deleteReason" class="w-full border border-gray-100 bg-gray-50 rounded-xl p-3 text-xs font-bold outline-none shadow-inner" placeholder="사유를 입력하세요 (이력용)"></div><div class="grid grid-cols-2 gap-4"><button onclick="closeModal('deleteModal')" class="py-4 bg-gray-50 rounded-2xl font-bold text-xs text-gray-500 hover:bg-gray-100 transition-all">취소</button><button onclick="confirmDelete()" class="py-4 bg-red-500 text-white rounded-2xl font-bold text-xs shadow-xl hover:bg-red-600 transition-all">삭제 확정</button></div></div></div>

    <script>
        // --- CONSTANTS ---
        const DEFAULT_SHEET_URL = "https://docs.google.com/spreadsheets/d/1pu_PIJ03omYU00jAmJ5FSvyjs_sqLxAU90_xjfY_yjQ/edit#gid=260394678";
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyZ-HCvldBXKA3bF7ghj8XpVAF1GRwlJF4evM_O6KmGn-vnCKLXwjIiW6Be-cgrwri6/exec";
        const GUILD_START_DATE = new Date('2020-03-17');
        const MAPLE_JOBS = ["히어로", "다크나이트", "팔라딘", "불독", "썬콜", "비숍", "보우마스터", "신궁", "패스파인더","나이트로드", "섀도어", "듀얼블레이드", "캡틴", "바이퍼", "캐논마스터","미하일", "소울마스터", "플레임위자드", "윈드브레이커", "나이트워커", "스트라이커","아란", "에반", "루미너스", "메르세데스", "팬텀", "은월","데몬 슬레이어", "데몬 어벤져", "블래스터", "배틀메이지", "와일드헌터", "메카닉", "제논","카이저", "카인", "카데나", "엔젤릭버스터","라라", "호영", "아델", "일리움", "아크", "칼리","제로", "키네시스", "렌"];
        const baseRanks = ['마카롱', '다쿠아즈'];
        const initialGuildRanks = {
            '뚠카롱': [...baseRanks, '크라운', '파르페', '티라미슈', '크로칸슈', '롤케이크', '팬케이크', '와플', '스콘(보석금대상자)', '반죽', '반죽(휴면)'],
            '뚱카롱': [...baseRanks, '뚠케이크', '뚠브레드', '수플레', '뚠스콘', '반죽', '반죽(휴면)', '아인슈패너'],
            '밤카롱': [...baseRanks, '부팬케이크', '부케이크', '아인슈패너', '반죽', '반죽(휴면)'],
            '별카롱': [...baseRanks, '부팬케이크', '부케이크', '아인슈패너', '반죽', '반죽(휴면)'],
            '달카롱': [...baseRanks, '부팬케이크', '부케이크', '아인슈패너', '반죽', '반죽(휴면)'],
            '꿀카롱': [...baseRanks, '부팬케이크', '부케이크', '아인슈패너', '반죽', '반죽(휴면)']
        };

        // --- GLOBAL STATE ---
        let jobChartInstance = null;
        let analysisChartInstance = null;

        const appState = {
            activeTab: 'dashboard',
            guilds: [
                { id: 'ddun', name: '뚠카롱', type: '메인 1기', color: '#f472b6', icon: 'fa-crown', max: 200 },
                { id: 'ddung', name: '뚱카롱', type: '메인 2기', color: '#fb7185', icon: 'fa-heart', max: 200 },
                { id: 'bam', name: '밤카롱', type: '부캐 1기', color: '#6366f1', icon: 'fa-moon', max: 200 },
                { id: 'byeol', name: '별카롱', type: '부캐 2기', color: '#facc15', icon: 'fa-star', max: 200 },
                { id: 'dal', name: '달카롱', type: '부캐 3기', color: '#60a5fa', icon: 'fa-sun', max: 200 },
                { id: 'kkul', name: '꿀카롱', type: '부캐 4기', color: '#fbbf24', icon: 'fa-cube', max: 200 },
            ],
            members: [], history: [], bailHistory: [], suroHeaders: [],
            filters: { guild: 'all', search: '', sortField: 'name', sortOrder: 'asc' },
            suroFilters: { guild: 'all', search: '', sortField: 'name', sortOrder: 'asc' },
            analysisFilters: { sortField: 'score', sortOrder: 'desc' },
            analysisGuild: '뚠카롱',
            isBatchMode: false, pendingUpdates: {},
            calendarView: { year: new Date().getFullYear(), month: new Date().getMonth() },
            scriptUrl: localStorage.getItem('macaron_script_url') || APPS_SCRIPT_URL,
            sheetUrl: localStorage.getItem('macaron_sheet_url') || DEFAULT_SHEET_URL,
            guildRanks: initialGuildRanks,
            currentSuroInputs: {}
        };

        // --- HELPER FUNCTIONS ---
        function showMsg(text, type = 'info') {
            const box = document.getElementById('msgBox'); if(!box) return;
            document.getElementById('msgText').innerText = text;
            box.classList.add('show'); setTimeout(() => box.classList.remove('show'), 3500);
        }
        function showLoading(show) { document.getElementById('loadingOverlay')?.classList.toggle('force-hide', !show); }
        function getAnniversaryInfo() {
            const now = new Date(); const diff = now - GUILD_START_DATE;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            return { totalDays: days, years: Math.floor(days / 365), remainingDays: days % 365 };
        }
        function calculateTotalSuro(guildName) {
            if (!appState.suroHeaders || appState.suroHeaders.length === 0) return 0;
            const lastHeader = appState.suroHeaders[appState.suroHeaders.length - 1];
            return appState.members.filter(m => m.guild === guildName).reduce((s, m) => s + (Number(m.suro?.[lastHeader]) || 0), 0);
        }
        function getAdminBailStats() {
            const stats = {};
            appState.bailHistory.forEach(h => { const amount = parseInt(h.amount) || 0; stats[h.receiver] = (stats[h.receiver] || 0) + amount; });
            return Object.entries(stats).sort((a,b) => a[0].localeCompare(b[0], 'ko'));
        }

        // Generic Sort with Unicode & Number support
        function smartCompare(a, b, field, order) {
            let valA = a[field];
            let valB = b[field];

            // Specific logic for 'mainInfo' sort field
            if (field === 'mainInfo') {
                valA = a.isMain ? a.name : (a.mainCharName || "");
                valB = b.isMain ? b.name : (b.mainCharName || "");
            }

            if (valA === valB) return 0;
            
            // Numeric check
            const numA = parseFloat(valA);
            const numB = parseFloat(valB);
            if (!isNaN(numA) && !isNaN(numB)) {
                return order === 'asc' ? numA - numB : numB - numA;
            }

            // Unicode Strict Sort
            const strA = String(valA || "");
            const strB = String(valB || "");
            const res = strA < strB ? -1 : 1;
            return order === 'asc' ? res : -res;
        }

        function getNicknameIcon(role) {
            if (role === '마카롱') return '<i class="fas fa-crown text-blue-500 mr-2 shadow-sm"></i>';
            if (role === '다쿠아즈') return '<i class="fas fa-crown text-pink-500 mr-2 shadow-sm"></i>';
            return '<span class="w-3 h-3 rounded-full bg-gray-200 mr-2 inline-block"></span>';
        }
        function formatRankWithSuffix(rank) {
            if (!rank) return '-';
            const special = ['크라운', '티라미슈', '크로칸슈'];
            if (special.includes(rank)) return `${rank} <span class="text-[8.5px] text-blue-500 font-bold tracking-tighter">(아인슈패너)</span>`;
            return rank;
        }
        function getSuroPeriodHeader(dateObj) { 
            const now = dateObj || new Date(); const day = now.getDay(); let diff = day - 4; if (diff < 0) diff += 7; 
            const startDate = new Date(now); startDate.setDate(now.getDate() - diff - 7); 
            const endDate = new Date(startDate); endDate.setDate(startDate.getDate() + 6); 
            const f = (d) => { 
                const yy = d.getFullYear().toString().slice(-2);
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                const dd = String(d.getDate()).padStart(2, '0');
                return `${yy}-${mm}-${dd}`;
            };
            return `${f(startDate)}(목) ~ ${f(endDate)}(수) 수로 점수`; 
        }

        // --- CORE API ---
        async function fetchMembers() {
            showLoading(true);
            try {
                const response = await fetch(appState.scriptUrl, { method: 'GET', mode: 'cors', cache: 'no-cache' });
                const json = await response.json();
                if (json.status === "success") {
                    appState.members = (json.data.members || []).filter(m => m.name && m.name.trim() !== "");
                    appState.history = json.data.history || [];
                    appState.suroHeaders = json.data.suroHeaders || [];
                    appState.bailHistory = json.data.bailHistory || [];
                    document.getElementById('totalMembersCount').innerText = appState.members.length;
                    router(appState.activeTab);
                }
            } catch (e) { console.error(e); showMsg("서버 연결 실패.", "error"); }
            showLoading(false);
        }
        async function sendAction(action, data) {
            showMsg("데이터 처리 중...", "info");
            try {
                const response = await fetch(appState.scriptUrl, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ action, data }), redirect: 'follow' });
                const res = await response.json();
                if (res.status === "success") { showMsg("완료되었습니다.", "success"); await fetchMembers(); return true; }
                else { showMsg(res.message || "오류 발생", "error"); return false; }
            } catch (e) { console.error(e); showMsg("서버 전송 실패", "error"); return false; }
        }

        // --- ROUTER ---
        function router(tab) {
            appState.activeTab = tab;
            const content = document.getElementById('contentArea'); if(!content) return;
            content.innerHTML = '';
            document.querySelectorAll('.nav-item').forEach(el => el.classList.toggle('active', el.dataset.target === tab));
            const titles = { dashboard: '길드 현황판', members: '길드원 관리', suro: '수로 점수 입력', analysis: '수로 분석', bail: '보석금 관리', sheet: '시트 보기', history: '운영 이력', settings: '설정' };
            document.getElementById('pageTitle').innerText = titles[tab] || '';
            if (tab === 'dashboard') renderDashboard(content);
            else if (tab === 'members') renderMembers(content);
            else if (tab === 'suro') renderSuro(content);
            else if (tab === 'analysis') renderAnalysis(content, appState.analysisGuild);
            else if (tab === 'bail') renderBail(content);
            else if (tab === 'sheet') renderSheet(content);
            else if (tab === 'history') renderHistory(content);
            else if (tab === 'settings') renderSettings(content);
        }

        // --- 길드원 관리 (검색 범위 및 전체 정렬 확대) ---
        function renderMembers(container) {
            container.innerHTML = `
                <div class="flex flex-col gap-8 fade-in h-full">
                    <div class="bg-white p-10 rounded-t-[3rem] border border-gray-100 space-y-8 shadow-sm">
                        <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                            <div class="flex overflow-x-auto pb-2 no-scrollbar w-full md:w-auto gap-3">
                                <button onclick="filterByGuild('all')" class="shrink-0 px-8 py-3 rounded-2xl text-xs font-bold transition-all ${appState.filters.guild === 'all' ? 'bg-gray-800 text-white shadow-xl' : 'bg-gray-50 text-gray-500 hover:bg-gray-100'}">전체 보기</button>
                                ${appState.guilds.map(g => `<button onclick="filterByGuild('${g.name}')" class="shrink-0 px-8 py-3 rounded-2xl text-xs font-bold transition-all ${appState.filters.guild === g.name ? 'bg-pink-500 text-white shadow-xl' : 'bg-gray-50 text-gray-500 hover:bg-gray-100'}">${g.name}</button>`).join('')}
                            </div>
                            <div class="flex gap-4 items-center">
                                <button onclick="toggleBatchMode()" class="px-6 py-3 rounded-2xl text-xs font-bold transition-all ${appState.isBatchMode ? 'bg-gray-800 text-white shadow-xl' : 'bg-pink-50 text-pink-500 hover:bg-pink-100'}"><i class="fas fa-edit mr-1"></i> 일괄 수정 ${appState.isBatchMode?'OFF':'ON'}</button>
                                ${appState.isBatchMode ? `<button onclick="saveBatchUpdates()" class="px-6 py-3 bg-pink-500 text-white rounded-2xl text-xs font-bold shadow-xl animate-pulse">변경사항 저장</button>` : ''}
                                <button onclick="openAddModal()" class="w-10 h-10 flex items-center justify-center rounded-2xl bg-pink-50 text-pink-500 hover:bg-pink-100 shadow-sm"><i class="fas fa-plus"></i></button>
                            </div>
                        </div>
                        <div class="relative">
                            <i class="fas fa-search absolute left-6 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            <input type="text" oninput="handleSearch(this.value)" value="${appState.filters.search}" class="w-full pl-16 pr-8 py-4 bg-gray-50 border border-gray-100 rounded-[2rem] outline-none text-sm font-bold shadow-inner focus:ring-4 focus:ring-pink-50 transition-all" placeholder="닉네임, 직위, 직업 검색">
                        </div>
                    </div>
                    <div id="memberTableContainer" class="bg-white rounded-b-[3rem] border border-gray-100 overflow-hidden shadow-sm flex-1 min-h-0"></div>
                </div>`;
            updateMemberTable();
        }

        function updateMemberTable() {
            const container = document.getElementById('memberTableContainer'); if(!container) return;
            const term = appState.filters.search.toLowerCase();
            const memberMap = new Map(); appState.members.forEach(m => memberMap.set(m.name, m));
            const filtered = appState.members.filter(m => {
                const gMatch = appState.filters.guild === 'all' || m.guild === appState.filters.guild;
                const sMatch = m.name.toLowerCase().includes(term) || (m.class||'').toLowerCase().includes(term) || (m.role||'').toLowerCase().includes(term);
                return gMatch && sMatch;
            });
            filtered.sort((a, b) => smartCompare(a, b, appState.filters.sortField, appState.filters.sortOrder));

            const sortIcon = (f) => appState.filters.sortField === f ? (appState.filters.sortOrder === 'asc' ? ' <i class="fas fa-sort-up"></i>' : ' <i class="fas fa-sort-down"></i>') : '';

            let html = `<div class="overflow-y-auto h-full"><table class="w-full text-left min-w-[900px] text-xs whitespace-nowrap"><thead class="bg-gray-50 text-[10px] font-bold text-gray-500 border-b border-gray-100 sticky top-0 z-10"><tr><th class="p-4 text-center w-16">No.</th><th class="p-4 sortable" onclick="handleSort('name')">닉네임${sortIcon('name')}</th><th class="p-4 sortable" onclick="handleSort('mainInfo')">본캐 정보${sortIcon('mainInfo')}</th><th class="p-4 sortable" onclick="handleSort('guild')">소속${sortIcon('guild')}</th><th class="p-4 sortable" onclick="handleSort('role')">직위${sortIcon('role')}</th><th class="p-4 sortable" onclick="handleSort('class')">직업${sortIcon('class')}</th><th class="p-4 text-right">관리</th></tr></thead><tbody class="divide-y divide-gray-50 text-gray-600 font-bold">`;
            filtered.forEach((m, idx) => {
                const mainName = m.isMain ? m.name : (m.mainCharName || '-');
                const mainMem = memberMap.get(mainName);
                const mainRankHtml = mainMem ? formatRankWithSuffix(mainMem.role) : '-';
                html += `<tr class="${appState.pendingUpdates[m.id] ? 'batch-modified' : ''} hover:bg-pink-50/20 group transition-colors h-14"><td class="p-3 text-center text-gray-400 text-[11px]">${idx+1}</td><td class="p-3 font-bold text-gray-800 flex items-center h-full leading-none">${getNicknameIcon(m.role)}<span class="text-sm tracking-tight">${m.name}</span></td><td class="p-3 leading-tight"><div><span class="block text-[11px] font-bold text-gray-700">${mainName}</span><span class="text-[9px] text-gray-400 font-medium">${mainRankHtml}</span></div></td><td class="p-3">${appState.isBatchMode ? `<select onchange="stageUpdate('${m.id}', 'guild', this.value)" class="bg-white border rounded px-1 text-[10px] outline-none">${appState.guilds.map(g=>`<option value="${g.name}" ${m.guild===g.name?'selected':''}>${g.name}</option>`).join('')}</select>` : m.guild}</td><td class="p-3">${appState.isBatchMode ? `<select onchange="stageUpdate('${m.id}', 'role', this.value)" class="bg-white border rounded px-1 text-[10px] outline-none">${(appState.guildRanks[m.guild]||initialGuildRanks['뚠카롱']).map(r=>`<option value="${r}" ${m.role===r?'selected':''}>${r}</option>`).join('')}</select>` : `<span class="text-[10px]">${m.role}</span>`}</td><td class="p-3">${appState.isBatchMode ? `<input type="text" value="${m.class||''}" oninput="stageUpdate('${m.id}', 'class', this.value)" class="bg-white border rounded px-1 text-[10px] w-24 outline-none">` : `<span class="text-[10px] text-gray-400">${m.class||'-'}</span>`}</td><td class="p-3 text-right">${!appState.isBatchMode ? `<div class="flex justify-end gap-1 opacity-0 group-hover:opacity-100 transition-opacity"><button onclick="openEditModal('${m.id}')" class="w-8 h-8 rounded-xl border border-gray-100 text-blue-500 hover:bg-blue-50 flex items-center justify-center shadow-sm"><i class="fas fa-edit text-[10px]"></i></button><button onclick="openDeleteModal('${m.id}')" class="w-8 h-8 rounded-xl border border-gray-100 text-red-500 hover:bg-red-50 flex items-center justify-center shadow-sm"><i class="fas fa-trash text-[10px]"></i></button></div>` : '<span class="text-[9px] text-gray-300">수정 중</span>'}</td></tr>`;
                if ((idx + 1) % 17 === 0 && idx !== filtered.length - 1) html += `<tr><td colspan="7" class="p-0 border-b-[3px] border-dashed border-pink-300 opacity-20"></td></tr>`;
            });
            html += `</tbody></table></div>`; container.innerHTML = html;
        }

        // --- 수로 점수 입력 (전체 정렬 기능 활성화) ---
        function renderSuro(container) {
            container.innerHTML = `
                <div class="flex flex-col gap-8 fade-in h-full">
                    <div class="bg-white p-10 rounded-t-[3rem] border border-gray-100 space-y-8 shadow-sm shrink-0">
                        <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                            <div class="flex overflow-x-auto pb-2 no-scrollbar w-full md:w-auto gap-3">
                                <button onclick="filterSuroGuild('all')" class="shrink-0 px-8 py-3 rounded-2xl text-xs font-bold transition-all ${appState.suroFilters.guild === 'all' ? 'bg-gray-800 text-white shadow-xl' : 'bg-gray-50 text-gray-500'}">전체 보기</button>
                                ${appState.guilds.map(g => `<button onclick="filterSuroGuild('${g.name}')" class="shrink-0 px-8 py-3 rounded-2xl text-xs font-bold transition-all ${appState.suroFilters.guild === g.name ? 'bg-blue-500 text-white shadow-xl' : 'bg-gray-50 text-gray-500'}">${g.name}</button>`).join('')}
                            </div>
                            <button onclick="saveSuroInputs()" id="btnSuroSave" class="px-10 py-4 bg-blue-500 text-white rounded-2xl font-bold shadow-xl hover:bg-blue-600 transition-all text-xs">수로 점수 저장</button>
                        </div>
                        <div class="relative">
                            <i class="fas fa-search absolute left-6 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            <input type="text" oninput="filterSuroSearch(this.value)" class="w-full pl-16 pr-8 py-4 bg-gray-50 border border-gray-100 rounded-[2rem] outline-none font-bold text-sm shadow-inner focus:ring-4 focus:ring-blue-50 transition-all" placeholder="닉네임 검색">
                        </div>
                    </div>
                    <div id="suroTableContainer" class="bg-white rounded-b-[3rem] border border-gray-100 overflow-hidden shadow-sm flex-1 min-h-0 flex flex-col"></div>
                </div>`;
            updateSuroTable();
        }

        function updateSuroTable() {
            const container = document.getElementById('suroTableContainer'); if(!container) return;
            const period = getSuroPeriodHeader();
            const prevHeader = appState.suroHeaders.slice(-2)[0] || "";
            const term = (appState.suroFilters.search || '').toLowerCase();
            const filtered = appState.members.filter(m => (appState.suroFilters.guild === 'all' || m.guild === appState.suroFilters.guild) && m.name.toLowerCase().includes(term));
            
            // Extend sorting for Suro Table
            filtered.sort((a, b) => {
                const f = appState.suroFilters.sortField;
                const o = appState.suroFilters.sortOrder;
                if (f === 'prev') return smartCompare({prev: Number(a.suro?.[prevHeader]||0)}, {prev: Number(b.suro?.[prevHeader]||0)}, 'prev', o);
                if (f === 'curr') {
                    const valA = Number(appState.currentSuroInputs[a.name] || a.suro?.[period] || 0);
                    const valB = Number(appState.currentSuroInputs[b.name] || b.suro?.[period] || 0);
                    return o === 'asc' ? valA - valB : valB - valA;
                }
                return smartCompare(a, b, f, o);
            });

            const sortIcon = (f) => appState.suroFilters.sortField === f ? (appState.suroFilters.sortOrder === 'asc' ? ' <i class="fas fa-sort-up"></i>' : ' <i class="fas fa-sort-down"></i>') : '';

            let html = `<div class="overflow-y-auto flex-1 p-0"><table class="w-full text-left min-w-[800px]"><thead class="bg-gray-50 text-gray-500 text-[10px] font-bold uppercase sticky top-0 z-10 border-b border-gray-100 shadow-sm"><tr><th class="p-4 cursor-pointer hover:bg-gray-100 transition-colors" onclick="handleSuroSort('name')">닉네임 (유니코드)${sortIcon('name')}</th><th class="p-4 cursor-pointer hover:bg-gray-100 transition-colors" onclick="handleSuroSort('guild')">소속${sortIcon('guild')}</th><th class="p-4 text-right cursor-pointer hover:bg-gray-100 transition-colors" onclick="handleSuroSort('prev')">지난 기록${sortIcon('prev')}</th><th class="p-4 text-right w-48 cursor-pointer hover:bg-gray-100 transition-colors" onclick="handleSuroSort('curr')">이번주 점수${sortIcon('curr')}</th></tr></thead><tbody class="divide-y divide-gray-50">`;
            filtered.forEach((m, idx) => {
                const currVal = appState.currentSuroInputs[m.name] !== undefined ? appState.currentSuroInputs[m.name] : (m.suro?.[period] || '');
                const prevVal = Number(m.suro?.[prevHeader] || 0);
                html += `<tr class="hover:bg-blue-50/30 transition-colors h-14"><td class="p-4 font-bold text-gray-800 flex items-center h-full text-sm leading-none">${getNicknameIcon(m.role)}${m.name}</td><td class="p-4 text-xs font-bold text-gray-400">${m.guild}</td><td class="p-4 text-right font-mono text-gray-300 text-xs">${prevVal > 0 ? prevVal.toLocaleString() : '-'}</td><td class="p-3"><input type="number" class="w-full bg-gray-50 border border-gray-100 rounded-xl px-4 py-2 text-right font-bold outline-none focus:bg-white focus:ring-2 focus:ring-blue-100 shadow-inner" value="${currVal}" oninput="appState.currentSuroInputs['${m.name}']=this.value"></td></tr>`;
                if ((idx + 1) % 17 === 0 && idx !== filtered.length - 1) html += `<tr><td colspan="4" class="p-0 border-b-[3px] border-dashed border-blue-300 opacity-20"></td></tr>`;
            });
            html += `</tbody></table></div>`; container.innerHTML = html;
        }

        // --- 수로 점수 분석 (전체 정렬 기능 활성화) ---
        function renderAnalysis(container, gName) {
            appState.analysisGuild = gName;
            const targets = appState.members.filter(m => m.guild === gName);
            const headers = appState.suroHeaders.slice(-5);
            const lastH = headers[headers.length-1];
            const total = calculateTotalSuro(gName);
            
            // All-column sorting for Analysis
            const sortedList = [...targets].sort((a,b) => {
                const f = appState.analysisFilters.sortField;
                const o = appState.analysisFilters.sortOrder;
                if (f === 'score') {
                    const vA = Number(a.suro?.[lastH]) || 0; const vB = Number(b.suro?.[lastH]) || 0;
                    return o === 'asc' ? vA - vB : vB - vA;
                }
                if (f === 'rank') {
                    const vA = targets.filter(x => (Number(x.suro?.[lastH])||0) > (Number(a.suro?.[lastH])||0)).length + 1;
                    const vB = targets.filter(x => (Number(x.suro?.[lastH])||0) > (Number(b.suro?.[lastH])||0)).length + 1;
                    return o === 'asc' ? vA - vB : vB - vA;
                }
                return smartCompare(a, b, f, o);
            });

            const sortIcon = (f) => appState.analysisFilters.sortField === f ? (appState.analysisFilters.sortOrder === 'asc' ? ' <i class="fas fa-sort-up"></i>' : ' <i class="fas fa-sort-down"></i>') : '';

            container.innerHTML = `
                <div class="flex flex-col gap-8 fade-in h-full">
                    <div class="bg-white p-10 rounded-[3rem] border border-gray-100 shadow-sm shrink-0">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                            <h2 class="text-xl font-bold text-gray-800 tracking-tight">수로 점수 분석</h2>
                            <div class="flex gap-2 overflow-x-auto no-scrollbar">${appState.guilds.map(g => `<button onclick="renderAnalysis(document.getElementById('contentArea'), '${g.name}')" class="px-6 py-2.5 rounded-xl text-xs font-bold transition-all ${g.name === gName ? 'bg-pink-500 text-white shadow-lg' : 'bg-gray-100 text-gray-500'}">${g.name}</button>`).join('')}</div>
                        </div>
                        <div class="bg-gray-50 rounded-[2.5rem] p-10 text-center border border-gray-100 shadow-inner"><p class="text-xs text-gray-400 mb-2 font-bold uppercase tracking-widest">${gName} 이번 주 총점</p><h1 class="text-5xl font-black text-gray-800 tracking-tighter">${total.toLocaleString()}</h1><p class="text-[10px] text-pink-400 mt-4 font-bold">${lastH || '기록 없음'}</p></div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 flex-1 min-h-0">
                        <div class="bg-white p-8 rounded-[3rem] border border-gray-100 shadow-sm flex flex-col h-full overflow-hidden shrink-0"><h3 class="text-sm font-bold text-gray-400 mb-6 uppercase tracking-widest">주간 추이</h3><div class="flex-1"><canvas id="analysisChart"></canvas></div></div>
                        <div class="lg:col-span-2 bg-white rounded-[3rem] border border-gray-100 shadow-sm overflow-hidden flex flex-col h-full">
                            <div class="p-8 border-b border-gray-50 shrink-0"><h3 class="text-sm font-bold text-gray-800 uppercase tracking-widest">개인별 점수 현황 (헤더 클릭 시 정렬)</h3></div>
                            <div class="flex-1 overflow-y-auto"><table class="w-full text-left text-xs"><thead class="bg-gray-50 font-bold uppercase text-[10px] text-gray-500 sticky top-0"><tr><th class="p-4 w-20 text-center sortable" onclick="setAnalysisSort('rank')">RANK${sortIcon('rank')}</th><th class="p-4 sortable" onclick="setAnalysisSort('name')">NICKNAME${sortIcon('name')}</th><th class="p-4 text-right sortable" onclick="setAnalysisSort('score')">SCORE${sortIcon('score')}</th></tr></thead><tbody class="divide-y divide-gray-50">
                                ${sortedList.map((m, i) => {
                                    const rank = targets.filter(x => (Number(x.suro?.[lastH])||0) > (Number(m.suro?.[lastH])||0)).length + 1;
                                    return `<tr class="hover:bg-gray-50 transition-colors h-12"><td class="p-4 text-center font-bold text-gray-400">${rank}</td><td class="p-4 font-bold text-gray-800 flex items-center leading-none">${getNicknameIcon(m.role)}${m.name}</td><td class="p-4 text-right font-black text-gray-700">${(Number(m.suro?.[lastH])||0).toLocaleString()}</td></tr>`;
                                }).join('')}
                            </tbody></table></div>
                        </div>
                    </div>
                </div>`;
            const ctx = document.getElementById('analysisChart'); if(!ctx) return;
            if(analysisChartInstance) analysisChartInstance.destroy();
            analysisChartInstance = new Chart(ctx, { type: 'line', data: { labels: headers.map(h => h.slice(3, 8)), datasets: [{ label: '총점', data: headers.map(h => appState.members.filter(m => m.guild === gName).reduce((s, m) => s + (Number(m.suro?.[h]) || 0), 0)), borderColor: '#ec4899', borderWidth: 3, pointRadius: 5, pointBackgroundColor: '#fff', tension: 0.4, fill: true, backgroundColor: 'rgba(236, 72, 153, 0.05)' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { grid: { display: false }, ticks: { font: { size: 10 } } } } } });
        }

        function setAnalysisSort(f) { 
            if(appState.analysisFilters.sortField === f) appState.analysisFilters.sortOrder = appState.analysisFilters.sortOrder === 'asc'?'desc':'asc';
            else { appState.analysisFilters.sortField = f; appState.analysisFilters.sortOrder = (f==='score'||f==='rank') ? 'desc' : 'asc'; }
            renderAnalysis(document.getElementById('contentArea'), appState.analysisGuild); 
        }

        // --- 보석금 관리 ---
        function renderBail(container) {
            const receivers = appState.members.filter(m => m.guild === '뚠카롱' && ['마카롱', '다쿠아즈'].includes(m.role)).sort((a,b) => smartCompare(a, b, 'name', 'asc'));
            const adminStats = getAdminBailStats();
            const historyRows = [...appState.bailHistory].reverse().map(h => {
                let sDate = '-';
                if (h.date) {
                    const p = h.date.split(' ')[0].split('-');
                    const yy = p[0].length === 4 ? p[0].slice(2) : p[0];
                    sDate = `${yy}-${p[1]}-${p[2]}`;
                }
                return `<tr class="hover:bg-gray-50 border-b border-gray-50 h-12 transition-colors"><td class="p-4 font-mono text-gray-400 text-[10px]">${sDate}</td><td class="p-4 font-bold text-gray-700">${h.payer}</td><td class="p-4 font-bold text-blue-500">${h.receiver}</td><td class="p-4 text-right font-black text-pink-500">${h.amount}개</td></tr>`;
            }).join('');
            const statsHtml = adminStats.map(([name, count]) => `<div class="bg-gray-50 rounded-2xl p-4 flex justify-between items-center border border-gray-100 hover:bg-white transition-all shadow-sm"><span class="font-bold text-gray-700 text-xs">${name}</span><span class="font-black text-pink-500 text-lg">${count}개</span></div>`).join('');

            container.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 fade-in h-full">
                    <div class="lg:col-span-1 bg-white p-10 rounded-[3rem] border border-gray-100 shadow-sm flex flex-col h-full overflow-hidden">
                        <div class="mb-8"><h3 class="text-xl font-bold text-gray-800 tracking-tight">보석금 납부 등록</h3><p class="text-xs text-gray-400 mt-1 uppercase font-bold tracking-widest">GEM BAIL REGISTRATION</p></div>
                        <div class="space-y-6 flex-1 overflow-y-auto no-scrollbar pb-6">
                            <div class="space-y-2"><label class="text-[10px] font-bold text-gray-400 ml-1 uppercase">납부자</label><input type="text" id="bailPayerInput" class="w-full bg-gray-50 border border-gray-100 rounded-2xl p-4 text-sm font-bold outline-none shadow-inner" placeholder="닉네임 직접 입력"></div>
                            <div class="space-y-2"><label class="text-[10px] font-bold text-gray-400 ml-1 uppercase">수령자</label><select id="bailReceiver" class="w-full bg-gray-50 border border-gray-100 rounded-2xl p-4 text-sm font-bold outline-none shadow-sm cursor-pointer">${receivers.map(r=>`<option value="${r.name}">${r.name} (${r.role})</option>`).join('')}</select></div>
                            <div class="space-y-2"><label class="text-[10px] font-bold text-gray-400 ml-1 uppercase">수량</label><input type="number" id="bailAmount" value="1" min="1" class="w-full bg-gray-50 border border-gray-100 rounded-2xl p-4 text-sm font-bold outline-none shadow-inner"></div>
                            <button onclick="submitBail()" id="btnBailSubmit" class="w-full py-6 bg-gray-900 text-white rounded-[2rem] font-bold text-xs shadow-2xl hover:bg-black transition-all active:scale-[0.98]">납부 확인 및 저장</button>
                            <div class="mt-8 border-t pt-8">
                                <h4 class="text-xs font-bold text-gray-400 mb-4 uppercase tracking-widest">간부별 수령 총계</h4>
                                <div class="grid grid-cols-1 gap-2">${statsHtml || '<p class="text-[10px] text-gray-300 italic text-center">데이터 없음</p>'}</div>
                            </div>
                        </div>
                    </div>
                    <div class="lg:col-span-2 bg-white rounded-[3rem] border border-gray-100 shadow-sm flex flex-col overflow-hidden h-full">
                        <div class="p-8 border-b border-gray-50 flex justify-between items-center"><h3 class="text-sm font-bold text-gray-800 uppercase tracking-widest">최근 보석금 내역 (yy-mm-dd)</h3><span class="text-[10px] text-gray-400 font-bold italic">Total: ${appState.bailHistory.length}</span></div>
                        <div class="flex-1 overflow-y-auto"><table class="w-full text-left text-xs"><thead class="bg-gray-50 text-[10px] font-bold text-gray-500 uppercase sticky top-0"><tr><th class="p-5">날짜</th><th class="p-5">납부자</th><th class="p-5">수령자</th><th class="p-5 text-right">수량</th></tr></thead><tbody class="divide-y divide-gray-50">${historyRows || '<tr><td colspan="4" class="p-20 text-center text-gray-300 font-bold italic">내역이 존재하지 않습니다.</td></tr>'}</tbody></table></div>
                    </div>
                </div>`;
        }

        async function submitBail() {
            const pI = document.getElementById('bailPayerInput'), rI = document.getElementById('bailReceiver'), aI = document.getElementById('bailAmount'), btn = document.getElementById('btnBailSubmit');
            const payer = pI.value.trim(), receiver = rI.value, amount = aI.value;
            if(!payer || !receiver || !amount) return showMsg("항목을 모두 입력하세요.", "error");
            if(!confirm(`${payer} 님의 보석금 ${amount}개를 저장하시겠습니까?`)) return;
            if (btn) { btn.disabled = true; btn.innerText = "전송 중..."; }
            if (await sendAction('save_bail', { payer, receiver, amount })) { pI.value = ''; aI.value = '1'; }
            else if (btn) { btn.disabled = false; btn.innerText = "납부 확인 및 저장"; }
        }

        // --- DASHBOARD ---
        function renderDashboard(container) {
            const anniv = getAnniversaryInfo(); const ddunT = calculateTotalSuro('뚠카롱'); const ddungT = calculateTotalSuro('뚱카롱');
            const adminBailStats = getAdminBailStats();
            const adminBailHtml = adminBailStats.map(([name, count]) => `<div class="flex justify-between items-center py-2 border-b border-gray-50 last:border-0"><span class="text-[11px] font-bold text-gray-600">${name}</span><span class="text-[11px] font-black text-pink-500">${count}개</span></div>`).join('') || '<p class="text-[10px] text-gray-300 italic text-center py-4">보석금 내역 없음</p>';
            container.innerHTML = `<div class="grid grid-cols-1 xl:grid-cols-2 gap-8 mb-8 fade-in shrink-0"><div class="flex flex-col gap-6"><div class="flex gap-6 h-40"><div onclick="router('analysis'); renderAnalysis(document.getElementById('contentArea'), '뚠카롱')" class="flex-1 bg-gradient-to-br from-pink-500 to-rose-500 rounded-[2.5rem] p-8 shadow-lg text-white cursor-pointer hover:scale-[1.02] transition-transform relative overflow-hidden flex flex-col justify-center"><div class="absolute top-0 right-0 p-4 opacity-20 text-5xl"><i class="fas fa-crown"></i></div><h3 class="text-sm font-bold opacity-80 uppercase tracking-widest text-center">뚠카롱 수로 총점</h3><p class="text-3xl font-black tracking-tighter text-center">${ddunT.toLocaleString()}</p></div><div onclick="router('analysis'); renderAnalysis(document.getElementById('contentArea'), '뚱카롱')" class="flex-1 bg-white border border-gray-100 rounded-[2.5rem] p-8 shadow-sm text-gray-800 cursor-pointer hover:border-pink-200 transition-all flex flex-col justify-center"><h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest text-center">뚱카롱 수로 총점</h3><p class="text-3xl font-black tracking-tighter text-pink-500 text-center">${ddungT.toLocaleString()}</p></div></div><div class="bg-white p-8 rounded-[2.5rem] border border-gray-100 min-h-[300px] shadow-sm"><div class="flex justify-between items-center mb-6"><div class="flex items-center gap-3"><span class="text-2xl">📅</span><h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest font-bold">Guild Calendar</h3></div><div class="text-[10px] font-bold text-gray-400 bg-gray-50 px-2 py-0.5 rounded-lg inline-block">D+${anniv.totalDays}</div></div>${renderCalendar()}</div></div><div class="flex flex-col gap-8 h-full"><div class="bg-white p-10 rounded-[3rem] shadow-sm border border-gray-100 flex flex-col h-[300px] overflow-hidden shrink-0"><div class="flex justify-between items-center mb-4"><h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest">직업 분포도</h3><select onchange="updateJobChart(this.value)" class="bg-gray-50 rounded-xl px-3 py-1.5 text-xs font-bold outline-none cursor-pointer hover:bg-gray-100"><option value="all">전체</option>${appState.guilds.map(g => `<option value="${g.name}">${g.name}</option>`).join('')}</select></div><div class="flex-1 overflow-y-auto no-scrollbar"><div style="min-height: 250px;"><canvas id="jobChart"></canvas></div></div></div><div class="bg-white p-10 rounded-[3rem] shadow-sm border border-gray-100 flex flex-col flex-1 min-h-[200px] overflow-hidden"><div class="flex items-center justify-between mb-6"><h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest">간부진 보석금 현황</h3><i class="fas fa-gem text-pink-300"></i></div><div class="flex-1 overflow-y-auto no-scrollbar pr-2">${adminBailHtml}</div></div></div></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 fade-in shrink-0">${appState.guilds.map(g => { const count = appState.members.filter(m => m.guild === g.name).length; const pct = Math.min((count / g.max) * 100, 100); return `<div class="bg-white p-8 rounded-[2.5rem] border border-gray-100 shadow-sm hover:shadow-xl transition-all cursor-pointer group" onclick="filterByGuild('${g.name}')"><div class="flex justify-between items-start mb-6"><div class="flex items-center gap-3"><div class="w-10 h-10 bg-gray-50 rounded-2xl flex items-center justify-center text-gray-400 group-hover:bg-pink-50 group-hover:text-pink-500 transition-colors"><i class="fas ${g.icon}"></i></div><div><span class="block font-bold text-lg text-gray-800 group-hover:text-pink-500">${g.name}</span><span class="text-[10px] text-gray-400 font-bold">${g.type}</span></div></div></div><div class="w-full bg-gray-50 rounded-full h-1.5 overflow-hidden"><div class="h-full bg-pink-500 transition-all duration-1000" style="width:${pct}%"></div></div><p class="text-[10px] text-gray-400 font-bold mt-2 text-right">${count} / ${g.max}</p></div>`; }).join('')}</div>`;
            setTimeout(() => window.updateJobChart('all'), 0);
        }
        function renderCalendar() { 
            const year = appState.calendarView.year, month = appState.calendarView.month; 
            const first = new Date(year, month, 1).getDay(), last = new Date(year, month + 1, 0).getDate(); 
            const today = new Date();
            let html = `<div class="calendar-grid"><div class="calendar-head text-red-400">일</div><div class="calendar-head">월</div><div class="calendar-head">화</div><div class="calendar-head">수</div><div class="calendar-head text-pink-500">목</div><div class="calendar-head">금</div><div class="calendar-head text-blue-400">토</div>`; 
            for(let i=0; i<first; i++) html += `<div class="calendar-day invisible"></div>`; 
            for(let d=1; d<=last; d++) { const date = new Date(year, month, d); let cls = "calendar-day text-gray-600"; if(date.getDay() === 4) cls += " thursday"; if(today.getFullYear()===year && today.getMonth()===month && today.getDate()===d) cls += " today"; html += `<div class="${cls}">${d}</div>`; } 
            return html + `</div>`; 
        }
        function updateJobChart(target) {
            const ctx = document.getElementById('jobChart'); if(!ctx) return;
            const targets = target === 'all' ? appState.members : appState.members.filter(m => m.guild === target);
            const counts = {}; targets.forEach(m => { const j = m.class || '미설정'; counts[j] = (counts[j] || 0) + 1; });
            const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]);
            if(jobChartInstance) jobChartInstance.destroy();
            jobChartInstance = new Chart(ctx, { type: 'bar', data: { labels: sorted.map(j => j[0]), datasets: [{ label: '인원', data: sorted.map(j => j[1]), backgroundColor: '#f472b6', borderRadius: 4, barThickness: 12 }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, ticks: { precision: 0 } } } } });
        }
        function renderSheet(container) { 
            const embedUrl = appState.sheetUrl.includes('/edit') ? appState.sheetUrl.split('/edit')[0] + '/preview' : appState.sheetUrl;
            container.innerHTML = `<div class="h-full flex flex-col gap-6 fade-in"><div class="bg-white p-8 rounded-[2.5rem] border border-gray-100 shadow-sm flex flex-col md:flex-row justify-between items-center gap-4 shrink-0"><div><h3 class="text-lg font-bold text-gray-800 tracking-tight">구글 스프레드시트 뷰어</h3><p class="text-xs text-gray-400 mt-1">원본 시트를 즉시 연결하거나 실시간으로 확인합니다.</p></div><button onclick="window.open('${appState.sheetUrl}', '_blank')" class="px-10 py-4 bg-gray-900 text-white text-xs font-bold rounded-2xl shadow-xl hover:bg-black transition-all flex items-center gap-2"><i class="fas fa-external-link-alt"></i> 원본 시트 바로가기</button></div><div class="flex-1 bg-white rounded-[3rem] border border-gray-100 overflow-hidden shadow-sm relative"><iframe src="${embedUrl}" class="w-full h-full border-none"></iframe></div></div>`; 
        }
        function renderHistory(container) { container.innerHTML = `<div class="bg-white rounded-[3rem] border border-gray-100 shadow-sm overflow-hidden h-full flex flex-col"><div class="p-8 border-b font-bold text-gray-800 shrink-0">운영 이력</div><div class="flex-1 overflow-y-auto"><table class="w-full text-left text-xs whitespace-nowrap"><thead class="bg-gray-50 text-[10px] font-bold text-gray-500 uppercase sticky top-0"><tr><th class="p-6">DATE</th><th class="p-6">TYPE</th><th class="p-6">NAME</th><th class="p-6">CONTENT</th></tr></thead><tbody class="divide-y divide-gray-100">${appState.history.length === 0 ? `<tr><td colspan="4" class="p-20 text-center text-gray-300 font-bold">기록 없음</td></tr>` : [...appState.history].reverse().map(l => `<tr class="hover:bg-gray-50 transition-colors h-12 leading-none"><td class="p-6 text-gray-400 font-mono text-[10px]">${l.date}</td><td class="p-6"><span class="px-2 py-1 rounded-lg bg-gray-100 text-[9px] font-bold">${l.category}</span></td><td class="p-6 font-bold text-gray-700">${l.name}</td><td class="p-6 text-gray-500">${l.content}</td></tr>`).join('')}</tbody></table></div></div>`; }
        function renderSettings(container) { container.innerHTML = `<div class="bg-white p-12 rounded-[3rem] border border-gray-100 shadow-sm max-w-4xl font-bold h-fit"><h3 class="text-xl mb-10 text-gray-800">시스템 설정</h3><div class="space-y-8"><div class="space-y-2"><label class="text-[10px] font-bold text-gray-400 uppercase font-bold">Apps Script WebApp URL</label><input type="text" id="settingScriptUrl" value="${appState.scriptUrl}" class="w-full bg-gray-50 border border-gray-100 rounded-2xl p-5 text-xs font-mono outline-none shadow-inner focus:ring-4 focus:ring-gray-100 transition-all"></div><div class="space-y-2"><label class="text-[10px] font-bold text-gray-400 uppercase font-bold">Google Sheet URL</label><input type="text" id="settingSheetUrl" value="${appState.sheetUrl}" class="w-full bg-gray-50 border border-gray-100 rounded-2xl p-5 text-xs font-mono outline-none shadow-inner focus:ring-4 focus:ring-gray-100 transition-all"></div><button onclick="saveSettings()" class="w-full py-6 bg-gray-900 text-white rounded-3xl font-bold shadow-xl active:scale-[0.98] transition-all">설정 저장 및 시스템 재시작</button></div></div>`; }
        function saveSettings() { localStorage.setItem('macaron_script_url', document.getElementById('settingScriptUrl').value.trim()); localStorage.setItem('macaron_sheet_url', document.getElementById('settingSheetUrl').value.trim()); showMsg("저장되었습니다.", "success"); setTimeout(()=>location.reload(), 800); }

        // --- CORE ACTIONS ---
        function toggleBatchMode() { appState.isBatchMode = !appState.isBatchMode; appState.pendingUpdates = {}; renderMembers(document.getElementById('contentArea')); }
        function stageUpdate(id, field, val) { if(!appState.pendingUpdates[id]) appState.pendingUpdates[id] = { id }; appState.pendingUpdates[id][field] = val; updateMemberTable(); }
        async function saveBatchUpdates() {
            const updates = Object.values(appState.pendingUpdates); if(updates.length === 0) return showMsg("수정된 내용이 없습니다.", "error");
            if(confirm(`${updates.length}명의 정보를 업데이트하시겠습니까?`)) { if(await sendAction('bulk_update', updates)) { appState.isBatchMode = false; appState.pendingUpdates = {}; } }
        }
        function handleSearch(v) { appState.filters.search = v; updateMemberTable(); }
        function filterByGuild(g) { appState.filters.guild = g; updateMemberTable(); renderMembers(document.getElementById('contentArea')); }
        function handleSort(field) { 
            if(appState.filters.sortField === field) appState.filters.sortOrder = appState.filters.sortOrder === 'asc' ? 'desc' : 'asc'; 
            else { appState.filters.sortField = field; appState.filters.sortOrder = 'asc'; }
            updateMemberTable(); 
        }
        function handleSuroSort(field) { 
            if(appState.suroFilters.sortField === field) appState.suroFilters.sortOrder = appState.suroFilters.sortOrder === 'asc' ? 'desc' : 'asc'; 
            else { appState.suroFilters.sortField = field; appState.suroFilters.sortOrder = 'asc'; }
            updateSuroTable(); 
        }
        function filterSuroGuild(g) { appState.suroFilters.guild = g; updateSuroTable(); renderSuro(document.getElementById('contentArea')); }
        function filterSuroSearch(v) { appState.suroFilters.search = v; updateSuroTable(); }

        function closeModal(id) { document.getElementById(id)?.classList.add('hidden'); }
        function openEditModal(id) { 
            const m = appState.members.find(x => x.id == id); if(!m) return;
            document.getElementById('modalTitle').innerText = '멤버 정보 수정';
            document.getElementById('editMemberId').value = m.id; document.getElementById('inputName').value = m.name; document.getElementById('inputName').disabled = true;
            document.getElementById('inputClass').innerHTML = MAPLE_JOBS.map(j=>`<option value="${j}">${j}</option>`).join(''); document.getElementById('inputClass').value = m.class || '';
            document.getElementById('inputGuild').innerHTML = appState.guilds.map(g=>`<option value="${g.name}">${g.name}</option>`).join(''); document.getElementById('inputGuild').value = m.guild;
            onGuildSelectChange(m.guild); setTimeout(() => { document.getElementById('inputRole').value = m.role; }, 100);
            document.getElementById('inputIsMain').checked = m.isMain; document.getElementById('inputMainCharName').value = m.mainCharName || '';
            toggleMainCharInput(); document.getElementById('memberModal').classList.remove('hidden');
        }
        function openAddModal() {
            document.getElementById('modalTitle').innerText = '멤버 신규 등록'; document.getElementById('memberForm').reset(); document.getElementById('editMemberId').value = ''; document.getElementById('inputName').disabled = false;
            document.getElementById('inputClass').innerHTML = MAPLE_JOBS.map(j=>`<option value="${j}">${j}</option>`).join('');
            document.getElementById('inputGuild').innerHTML = appState.guilds.map(g=>`<option value="${g.name}">${g.name}</option>`).join('');
            onGuildSelectChange(appState.guilds[0].name); toggleMainCharInput(); document.getElementById('memberModal').classList.remove('hidden');
        }
        function openDeleteModal(id) { appState.memberToDelete = appState.members.find(x => x.id == id); document.getElementById('deleteTargetName').innerText = appState.memberToDelete.name; document.getElementById('deleteModal').classList.remove('hidden'); }
        function setDeleteType(t) { appState.deleteType = t; document.getElementById('btnLeave').className = t === 'leave' ? 'flex-1 py-3 rounded-xl font-bold text-xs bg-gray-800 text-white' : 'flex-1 py-3 rounded-xl font-bold text-xs bg-gray-100 text-gray-400'; document.getElementById('btnKick').className = t === 'kick' ? 'flex-1 py-3 rounded-xl font-bold text-xs bg-red-600 text-white' : 'flex-1 py-3 rounded-xl font-bold text-xs bg-gray-100 text-gray-400'; }
        async function confirmDelete() { if(await sendAction('delete', { id: appState.memberToDelete.id, type: appState.deleteType, reason: document.getElementById('deleteReason').value })) closeModal('deleteModal'); }
        function onGuildSelectChange(v) { document.getElementById('inputRole').innerHTML = (appState.guildRanks[v] || initialGuildRanks['뚠카롱']).map(r => `<option value="${r}">${r}</option>`).join(''); }
        function toggleMainCharInput() { document.getElementById('mainCharInputGroup').classList.toggle('hidden', document.getElementById('inputIsMain').checked); }

        document.getElementById('memberForm').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('editMemberId').value;
            const data = { name: document.getElementById('inputName').value.trim(), guild: document.getElementById('inputGuild').value, role: document.getElementById('inputRole').value, class: document.getElementById('inputClass').value, isMain: document.getElementById('inputIsMain').checked, mainCharName: document.getElementById('inputMainCharName').value.trim(), joinDate: new Date().toISOString().split('T')[0] };
            if(await sendAction(id ? 'update' : 'add', id ? { ...data, id } : data)) closeModal('memberModal');
        };

        function initSidebar() {
            const sb = document.getElementById('sidebar'), ov = document.getElementById('sidebarOverlay');
            document.getElementById('openSidebar').onclick = () => { sb.classList.remove('-translate-x-full'); ov.classList.remove('hidden'); };
            document.getElementById('closeSidebar').onclick = () => { sb.classList.add('-translate-x-full'); ov.classList.add('hidden'); };
            ov.onclick = () => { sb.classList.add('-translate-x-full'); ov.classList.add('hidden'); };
        }

        document.addEventListener('DOMContentLoaded', () => { initSidebar(); fetchMembers(); });
    </script>
</body>
</html>
